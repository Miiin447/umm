# coding: utf-8
# ì‚¬ì „ ì¤€ë¹„:
#   pip install customtkinter pillow

import os
import tkinter as tk
from tkinter import messagebox, filedialog
from PIL import Image, ImageTk, ImageSequence
import customtkinter as ctk
import shutil
from datetime import datetime

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í…Œë§ˆ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Light ëª¨ë“œ ê³ ì • ë° ì»¬ëŸ¬ í…Œë§ˆ ì„¤ì •
ctk.set_appearance_mode("light")
ctk.set_default_color_theme("blue")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì—­ ìƒíƒœ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STATE: READY(ì¤€ë¹„) / WORKING(ì‘ì—…ì¤‘) ì¤‘ì•™ ë°°ê²½ ì´ë¯¸ì§€ ì „í™˜
STATE = "READY"

# íŒŒì¼ ê²½ë¡œ ì €ì¥
UPLOADED_FILES = {
    "main": None,
    "patients": None,
    "Paymentitems": None
}

# ì´ë¯¸ì§€ ìºì‹œ (ì°¸ì¡° ìœ ì§€ìš©)
IMAGE_CACHE = {
    "active_frames": {},  # í™œì„±í™” ìƒíƒœ í”„ë ˆì„ ìºì‹œ
    "lock_frames": None,  # ì ê¸ˆ í”„ë ˆì„ (ëª¨ë“  ë²„íŠ¼ì´ ê³µìœ )
    "current_images": {}  # í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì´ë¯¸ì§€ ì €ì¥
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì½œë°± í•¨ìˆ˜ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def on_help():
    """ë„ì›€ë§ ì°½ ë˜ëŠ” ì•ˆë‚´ ë¡œì§ í˜¸ì¶œ"""
    print("â“ ì‚¬ìš©ë²•")

def on_upload_main_file():
    """ë©”ì¸ íŒŒì¼ ì—…ë¡œë“œ"""
    file_path = filedialog.askopenfilename(
        title="ë©”ì¸ íŒŒì¼ ì„ íƒ",
        filetypes=(("Excel íŒŒì¼", "*.xlsx"), ("CSV íŒŒì¼", "*.csv"), ("ëª¨ë“  íŒŒì¼", "*.*"))
    )
    if file_path:
        UPLOADED_FILES["main"] = file_path
        main_file_name = os.path.basename(file_path)
        
        # íŒŒì¼ ì •ë³´ ì—…ë°ì´íŠ¸
        update_file_labels()
        
        # ë°±ì—… ìƒì„±
        try:
            backup_dir = "BACK UP"
            os.makedirs(backup_dir, exist_ok=True)
            backup_file = os.path.join(backup_dir, f"BACKUP_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{main_file_name}")
            shutil.copy2(file_path, backup_file)
            print(f"ë©”ì¸ íŒŒì¼ ë°±ì—… ìƒì„± ì™„ë£Œ: {backup_file}")
        except Exception as e:
            print(f"ë°±ì—… ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            
        messagebox.showinfo("íŒŒì¼ ì—…ë¡œë“œ", f"ë©”ì¸ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: {main_file_name}")

def on_upload_patients_file():
    """í™˜ì íŒŒì¼ ì—…ë¡œë“œ"""
    file_path = filedialog.askopenfilename(
        title="í™˜ì íŒŒì¼ ì„ íƒ",
        filetypes=(("Excel íŒŒì¼", "*.xlsx"), ("CSV íŒŒì¼", "*.csv"), ("ëª¨ë“  íŒŒì¼", "*.*"))
    )
    if file_path:
        # íŒŒì¼ ì´ë¦„ì´ 'patients'ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
        file_name = os.path.basename(file_path).lower()
        if not file_name.startswith('patients'):
            messagebox.showwarning("íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜", "í™˜ì íŒŒì¼ì€ 'patients'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.")
            return
            
        UPLOADED_FILES["patients"] = file_path
        update_file_labels()
        messagebox.showinfo("íŒŒì¼ ì—…ë¡œë“œ", f"í™˜ì íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: {os.path.basename(file_path)}")

def on_upload_Paymentitems_file():
    """ê²°ì œ íŒŒì¼ ì—…ë¡œë“œ"""
    file_path = filedialog.askopenfilename(
        title="ê²°ì œ íŒŒì¼ ì„ íƒ",
        filetypes=(("Excel íŒŒì¼", "*.xlsx"), ("CSV íŒŒì¼", "*.csv"), ("ëª¨ë“  íŒŒì¼", "*.*"))
    )
    if file_path:
        # íŒŒì¼ ì´ë¦„ì´ 'Paymentitems'ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
        file_name = os.path.basename(file_path).lower()
        if not file_name.startswith('Paymentitems'):
            messagebox.showwarning("íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜", "ê²°ì œ íŒŒì¼ì€ 'Paymentitems'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.")
            return
            
        UPLOADED_FILES["Paymentitems"] = file_path
        update_file_labels()
        messagebox.showinfo("íŒŒì¼ ì—…ë¡œë“œ", f"ê²°ì œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: {os.path.basename(file_path)}")

def on_table_update():
    """í‘œ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ì‹¤í–‰"""
    print("ğŸ“Š í‘œ ì—…ë°ì´íŠ¸ ì‹¤í–‰")
    
    # ë©”ì¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not UPLOADED_FILES["main"]:
        messagebox.showerror("ì˜¤ë¥˜", "ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return
        
    # í•„ìš”í•œ íŒŒì¼ í™•ì¸
    if not UPLOADED_FILES["patients"] and not UPLOADED_FILES["Paymentitems"]:
        messagebox.showwarning("íŒŒì¼ ì—†ìŒ", "Patients íŒŒì¼ê³¼ Paymentitems íŒŒì¼ì´ ëª¨ë‘ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return
        
    # ë©”ì¸ íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if not check_file_access(UPLOADED_FILES["main"]):
        messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì´ ì—´ë ¤ìˆê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”: {UPLOADED_FILES['main']}")
        return
        
    # ì—¬ê¸°ì— ì‹¤ì œ í‘œ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ êµ¬í˜„


def on_patient_update():
    """í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ì‹¤í–‰"""
    print("ğŸ‘¥ í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤í–‰")
    
    # ë©”ì¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not UPLOADED_FILES["main"]:
        messagebox.showerror("ì˜¤ë¥˜", "ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return
        
    # ë©”ì¸ íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if not check_file_access(UPLOADED_FILES["main"]):
        messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì´ ì—´ë ¤ìˆê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”: {UPLOADED_FILES['main']}")
        return
        


def on_exit():
    """í”„ë¡œê·¸ë¨ ì¢…ë£Œ"""
    print("ğŸšª ì¢…ë£Œ")
    root.destroy()

def on_chart_update():
    """ë„í‘œ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ì‹¤í–‰"""
    print("ğŸ“Š ë„í‘œ ì—…ë°ì´íŠ¸ ì‹¤í–‰")
    
    # ë©”ì¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not UPLOADED_FILES["main"]:
        messagebox.showerror("ì˜¤ë¥˜", "ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return
        
    # ë©”ì¸ íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if not check_file_access(UPLOADED_FILES["main"]):
        messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì´ ì—´ë ¤ìˆê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”: {UPLOADED_FILES['main']}")
        return
        
    # ì—¬ê¸°ì— ì‹¤ì œ ë„í‘œ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ êµ¬í˜„

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¤‘ì•™ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def update_center_image(new_state):
    """
    new_state ì— ë”°ë¼ ì¤‘ì•™ì— í‘œì‹œë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
    1) READY: ì²˜ë¦¬ì ë°°ê²½ì œê±°.png
    2) WORKING: ì²˜ë¦¬ì¤‘ ë°°ê²½ì œê±°.png
    """
    global STATE, center_lbl, center_img
    STATE = new_state
    img_map = {"READY": "ì²˜ë¦¬ì ë°°ê²½ì œê±°.png", "WORKING": "ì²˜ë¦¬ì¤‘ ë°°ê²½ì œê±°.png"}
    img_file = os.path.join(ASSET_DIR, img_map[STATE])
    if os.path.exists(img_file):
        pil_img = Image.open(img_file)
        center_img = ctk.CTkImage(pil_img, size=(200,200))
        center_lbl.configure(image=center_img)
        center_lbl.image = center_img  # ì°¸ì¡° ìœ ì§€
    else:
        print(f"[ê²½ê³ ] ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ: {img_file}")

def check_file_access(file_path):
    """íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸)"""
    if not os.path.exists(file_path):
        print(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {file_path}")
        return False
        
    try:
        # íŒŒì¼ì´ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì ê²¨ìˆëŠ”ì§€ í™•ì¸
        with open(file_path, 'r+b') as f:
            return True
    except IOError:
        print(f"íŒŒì¼ì´ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì ê²¨ ìˆìŠµë‹ˆë‹¤: {file_path}")
        return False

def setup_folders():
    """í•„ìš”í•œ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤"""
    folders = ['DONE', 'BACK UP', 'SKIPPED']
    for folder in folders:
        if not os.path.exists(folder):
            os.makedirs(folder)
            print(f"{folder} í´ë” ìƒì„± ì™„ë£Œ")

def update_file_labels():
    """íŒŒì¼ ìƒíƒœ ë ˆì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤"""
    # í•„ìš”í•œ í´ë” ìƒì„±
    setup_folders()
    
    # íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    main_file = os.path.basename(UPLOADED_FILES["main"]) if UPLOADED_FILES["main"] else None
    patients_file = os.path.basename(UPLOADED_FILES["patients"]) if UPLOADED_FILES["patients"] else None
    payment_items = os.path.basename(UPLOADED_FILES["Paymentitems"]) if UPLOADED_FILES["Paymentitems"] else None
    
    # íŒŒì¼ ê°ì§€ ê²°ê³¼ ì¶œë ¥
    file_summary = []
    if main_file:
        file_summary.append(f"ë©”ì¸: {main_file}")
    if patients_file:
        file_summary.append(f"Patients: {patients_file}")
    if payment_items:
        file_summary.append(f"Paymentitems: {payment_items}")
        
    if file_summary:
        print(f"íŒŒì¼ ì—…ë¡œë“œ ê²°ê³¼: {', '.join(file_summary)}")
    
    # ì¹´ë“œ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
    file_rows = card.winfo_children()
    if len(file_rows) >= 3:
        # ë©”ì¸ íŒŒì¼ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
        main_row_labels = file_rows[0].winfo_children()
        if len(main_row_labels) >= 3:
            main_row_labels[2].configure(text=main_file if main_file else "ì—†ìŒ")
        
        # í™˜ì íŒŒì¼ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
        patient_row_labels = file_rows[1].winfo_children()
        if len(patient_row_labels) >= 3:
            patient_row_labels[2].configure(text=patients_file if patients_file else "ì—†ìŒ")
        
        # ì§€ë¶ˆ íŒŒì¼ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
        payment_row_labels = file_rows[2].winfo_children()
        if len(payment_row_labels) >= 3:
            payment_row_labels[2].configure(text=payment_items if payment_items else "ì—†ìŒ")
    
    # ìƒíƒœ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
    if not main_file:
        status_lbl.configure(text="âš ï¸ ë©”ì¸ íŒŒì¼ ì—†ìŒ", text_color="red")
    elif not patients_file and not payment_items:
        status_lbl.configure(text="âš ï¸ ì…ë ¥ íŒŒì¼ ì—†ìŒ", text_color="orange")
    else:
        status_lbl.configure(text="ì¤€ë¹„ ì™„ë£Œ", text_color="black")
    
    # ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    update_button_states(main_file, patients_file, payment_items)
    
    # ë©”ì¸ íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (íŒŒì¼ì´ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì—ì„œ ì—´ë ¤ìˆëŠ”ì§€)
    if main_file and not check_file_access(UPLOADED_FILES["main"]):
        messagebox.showerror("íŒŒì¼ ì ‘ê·¼ ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì´ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì—ì„œ ì—´ë ¤ìˆì–´ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”: {main_file}")
        return False
    
    return True

def create_hover_button(parent, gif, cb, tip, col):
    """ì•„ì´ì½˜ GIF ì• ë‹ˆë©”ì´ì…˜ ë° í˜¸ë²„ íŒì—… ê¸°ëŠ¥ ì„¤ì •"""
    global IMAGE_CACHE
    
    # GIF íŒŒì¼ ê²½ë¡œ ì €ì¥
    gif_path = os.path.join(ICON_DIR, gif)
    lock_gif_path = os.path.join(ICON_DIR, "ì ê¸ˆ.gif")
    
    # ì ê¸ˆ í”„ë ˆì„ì„ ì „ì—­ ìºì‹œì— ë¡œë“œ (ëª¨ë“  ë²„íŠ¼ì´ ê³µìœ )
    if IMAGE_CACHE["lock_frames"] is None and os.path.exists(lock_gif_path):
        lock_pil = Image.open(lock_gif_path)
        IMAGE_CACHE["lock_frames"] = [ImageTk.PhotoImage(f.convert("RGBA").resize(icon_size, Image.LANCZOS)) 
                                      for f in ImageSequence.Iterator(lock_pil)]
        print(f"ì ê¸ˆ ì´ë¯¸ì§€ {len(IMAGE_CACHE['lock_frames'])}ê°œ í”„ë ˆì„ ë¡œë“œë¨")
    
    # í™œì„±í™” ìƒíƒœì˜ GIF ë¡œë“œ
    if gif not in IMAGE_CACHE["active_frames"] and os.path.exists(gif_path):
        pil = Image.open(gif_path)
        IMAGE_CACHE["active_frames"][gif] = [ImageTk.PhotoImage(f.convert("RGBA").resize(icon_size, Image.LANCZOS)) 
                                            for f in ImageSequence.Iterator(pil)]
        print(f"{gif} ì´ë¯¸ì§€ {len(IMAGE_CACHE['active_frames'][gif])}ê°œ í”„ë ˆì„ ë¡œë“œë¨")
    
    # ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìƒì„±
    cont = ctk.CTkFrame(master=parent, fg_color="white", corner_radius=16,
                        width=icon_size[0]+8, height=icon_size[1]+8,
                        border_width=1, border_color=BG)
    cont.grid(row=0, column=col, padx=2, pady=4)
    cont.pack_propagate(False)
    
    # ê¸°ë³¸ í”„ë ˆì„ ì„¤ì •
    active_frames = IMAGE_CACHE["active_frames"].get(gif, [])
    lock_frames = IMAGE_CACHE["lock_frames"] or []
    current_frames = active_frames if active_frames else lock_frames
    
    # í˜„ì¬ ì´ë¯¸ì§€ ì°¸ì¡° ìºì‹±
    if current_frames:
        IMAGE_CACHE["current_images"][f"btn_{col}"] = current_frames[0]
        
    # ë ˆì´ë¸”(ë²„íŠ¼) ìƒì„±
    lbl = tk.Label(cont, image=IMAGE_CACHE["current_images"].get(f"btn_{col}"), bg="white")
    lbl.btn_id = f"btn_{col}"  # ë²„íŠ¼ ì‹ë³„ì
    lbl.gif_name = gif  # ì›ë˜ GIF ì´ë¦„ ì €ì¥
    lbl.pack(expand=True)
    popup=None
    
    # ë¹„í™œì„±í™” ìƒíƒœ ì €ì¥ ë³€ìˆ˜
    lbl.is_disabled = False
    
    def show_pop():
        nonlocal popup
        if popup: popup.destroy()
        if lbl.is_disabled: return  # ë¹„í™œì„±í™” ìƒíƒœë©´ íŒì—… í‘œì‹œ ì•ˆí•¨
        
        x = lbl.winfo_rootx() + lbl.winfo_width()//2
        y = lbl.winfo_rooty() - 40
        popup = ctk.CTkToplevel(root)
        popup.overrideredirect(True)
        popup.geometry(f"+{x}+{y}")
        ctk.CTkLabel(master=popup, text=tip,
                     fg_color="#ffe0b2", text_color="black",
                     corner_radius=8, font=("ë§‘ì€ ê³ ë”•",10,"bold"),
                     padx=8,pady=4).pack()
    
    def hide_pop():
        nonlocal popup
        if popup: popup.destroy(); popup=None
    
    def start_anim():
        # í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í”„ë ˆì„ ê²°ì •
        frames = IMAGE_CACHE["active_frames"].get(lbl.gif_name, []) if not lbl.is_disabled else IMAGE_CACHE["lock_frames"]
        if not frames:
            return
            
        def anim(i=0): 
            if hasattr(lbl, 'is_destroyed') and lbl.is_destroyed:
                return
                
            # ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ë¹„í™œì„±í™” ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
            current_frames = IMAGE_CACHE["active_frames"].get(lbl.gif_name, []) if not lbl.is_disabled else IMAGE_CACHE["lock_frames"]
            if current_frames != frames:
                # í”„ë ˆì„ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€í•˜ê³  ë‹¤ì‹œ ì‹œì‘
                stop_anim()
                start_anim()
                return
                
            # í˜„ì¬ í”„ë ˆì„ìœ¼ë¡œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            if frames and len(frames) > 0:
                lbl.config(image=frames[i])
                IMAGE_CACHE["current_images"][lbl.btn_id] = frames[i]  # í˜„ì¬ ì´ë¯¸ì§€ ìºì‹±
                lbl.after_id = lbl.after(SPEED, anim, (i+1)%len(frames))
        anim()
    
    def stop_anim():
        if hasattr(lbl,'after_id'): 
            lbl.after_cancel(lbl.after_id)
            
        # í”„ë ˆì„ ì„ íƒ
        frames = IMAGE_CACHE["active_frames"].get(lbl.gif_name, []) if not lbl.is_disabled else IMAGE_CACHE["lock_frames"]
        if frames and len(frames) > 0:
            lbl.config(image=frames[0])
            IMAGE_CACHE["current_images"][lbl.btn_id] = frames[0]  # í˜„ì¬ ì´ë¯¸ì§€ ìºì‹±
    
    def on_click(e):
        if lbl.is_disabled: return  # ë¹„í™œì„±í™” ìƒíƒœë©´ í´ë¦­ ë¬´ì‹œ
        cb()
    
    # ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë©”ì„œë“œ ì¶”ê°€
    def enable():
        lbl.is_disabled = False
        lbl.configure(bg="white")  # ì¼ë°˜ ë°°ê²½ìƒ‰
        
        # í™œì„±í™” ìƒíƒœì˜ í”„ë ˆì„ ê°€ì ¸ì˜¤ê¸°
        active_frames = IMAGE_CACHE["active_frames"].get(lbl.gif_name, [])
        if active_frames and len(active_frames) > 0:
            lbl.config(image=active_frames[0])
            IMAGE_CACHE["current_images"][lbl.btn_id] = active_frames[0]  # í˜„ì¬ ì´ë¯¸ì§€ ìºì‹±
            print(f"ë²„íŠ¼ {col} ({lbl.gif_name}) í™œì„±í™”ë¨")
        
        lbl.bind("<Enter>", lambda e:(start_anim(),show_pop()))
        lbl.bind("<Leave>", lambda e:(stop_anim(),hide_pop()))
        lbl.bind("<Button-1>", on_click)
    
    def disable():
        lbl.is_disabled = True
        lbl.configure(bg="white")  # í™œì„±í™” ìƒíƒœì™€ ê°™ì€ ë°°ê²½ìƒ‰ ìœ ì§€
        
        # ì ê¸ˆ í”„ë ˆì„ ì‚¬ìš©
        if IMAGE_CACHE["lock_frames"] and len(IMAGE_CACHE["lock_frames"]) > 0:
            lbl.config(image=IMAGE_CACHE["lock_frames"][0])
            IMAGE_CACHE["current_images"][lbl.btn_id] = IMAGE_CACHE["lock_frames"][0]  # í˜„ì¬ ì´ë¯¸ì§€ ìºì‹±
            print(f"ë²„íŠ¼ {col} ({lbl.gif_name}) ë¹„í™œì„±í™”ë¨")
        
        # ë¹„í™œì„±í™” ìƒíƒœì—ì„œë„ í˜¸ë²„ì‹œ ì• ë‹ˆë©”ì´ì…˜ì€ ì§€ì›
        lbl.bind("<Enter>", lambda e: start_anim())
        lbl.bind("<Leave>", lambda e: stop_anim())
        # í´ë¦­ì€ ë¹„í™œì„±í™”
        lbl.unbind("<Button-1>")
        hide_pop()
    
    # ì†Œë©¸ì ëŒ€ì‘
    def on_destroy():
        lbl.is_destroyed = True
        if hasattr(lbl, 'after_id'): 
            lbl.after_cancel(lbl.after_id)
    
    lbl.bind("<Destroy>", lambda e: on_destroy())
    
    # ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™” ìƒíƒœë¡œ ì‹œì‘ (íŒŒì¼ ê°ì§€, ì¢…ë£Œ ë²„íŠ¼)
    # ë‹¤ë¥¸ ë²„íŠ¼ì€ init_appì—ì„œ ë¹„í™œì„±í™” ì„¤ì •
    lbl.enable = enable
    lbl.disable = disable
    enable()
    
    return lbl

def update_button_states(main_file, patients_file, payment_items):
    """íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸"""
    print("\n===== ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ =====")
    print(f"ë©”ì¸ íŒŒì¼: {main_file}")
    print(f"í™˜ì íŒŒì¼: {patients_file}")
    print(f"ê²°ì œ íŒŒì¼: {payment_items}")
    
    # ë²„íŠ¼ì„ ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
    button_frames = group.winfo_children()
    if len(button_frames) < 4:
        print("ë²„íŠ¼ í”„ë ˆì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    # ê° ë²„íŠ¼ í”„ë ˆì„ì—ì„œ ë¼ë²¨ ì°¾ê¸°
    table_update_label = None
    patient_update_label = None
    chart_update_label = None
    
    for idx, frame in enumerate(button_frames):
        for widget in frame.winfo_children():
            if isinstance(widget, tk.Label):
                if idx == 0:  # í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ (ì²« ë²ˆì§¸)
                    table_update_label = widget
                elif idx == 1:  # í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ë²„íŠ¼ (ë‘ ë²ˆì§¸)
                    patient_update_label = widget
                elif idx == 2:  # ë„í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ (ì„¸ ë²ˆì§¸)
                    chart_update_label = widget
    
    # ë©”ì¸ íŒŒì¼ì´ ìˆìœ¼ë©´ í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ë²„íŠ¼ê³¼ ë„í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”
    if main_file:
        print("ë©”ì¸ íŒŒì¼ ì¡´ì¬: í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ë²„íŠ¼ê³¼ ë„í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”")
        
        if patient_update_label and hasattr(patient_update_label, 'enable'):
            patient_update_label.enable()
        
        if chart_update_label and hasattr(chart_update_label, 'enable'):
            chart_update_label.enable()
        
        # ë©”ì¸ íŒŒì¼ê³¼ Patients ë˜ëŠ” Paymentitems íŒŒì¼ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”
        if patients_file or payment_items:
            print("Patients ë˜ëŠ” Paymentitems íŒŒì¼ ì¡´ì¬: í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”")
            if table_update_label and hasattr(table_update_label, 'enable'):
                table_update_label.enable()
        else:
            print("Patientsì™€ Paymentitems íŒŒì¼ ëª¨ë‘ ì—†ìŒ: í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”")
            # í•„ìš”í•œ ë‹¤ë¥¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”
            if table_update_label and hasattr(table_update_label, 'disable'):
                table_update_label.disable()
    else:
        print("ë©”ì¸ íŒŒì¼ ì—†ìŒ: ì„¸ ë²„íŠ¼ ëª¨ë‘ ë¹„í™œì„±í™”")
        # ë©”ì¸ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì„¸ ë²„íŠ¼ ëª¨ë‘ ë¹„í™œì„±í™”
        if patient_update_label and hasattr(patient_update_label, 'disable'):
            patient_update_label.disable()
        if table_update_label and hasattr(table_update_label, 'disable'):
            table_update_label.disable()
        if chart_update_label and hasattr(chart_update_label, 'disable'):
            chart_update_label.disable()
    print("===== ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ =====\n")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë©”ì¸ ìœˆë„ìš° ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BG = "#fff0e5"
root = ctk.CTk()
root.geometry("450x600")  # ì„¸ë¡œ ë†’ì´ë¥¼ 600ìœ¼ë¡œ ì¦ê°€
root.title("ì¼€ì´ë‹¥ ë§ˆí¬7 4.0")
root.configure(fg_color=BG)

# 1) ìƒë‹¨ íƒ€ì´í‹€
ctk.CTkLabel(
    master=root,
    text="ğŸŒŸ ì¼€ì´ë‹¥ ë§ˆí¬7 4.0 ğŸŒŸ",
    font=("ë§‘ì€ ê³ ë”•", 18, "bold"),
    text_color="black"
).pack(pady=(30,8))

# 2) ë„ì›€ë§ ë²„íŠ¼
help_frame = ctk.CTkFrame(master=root, fg_color="transparent")
help_frame.pack(fill="x", padx=16, pady=(0,16))
ctk.CTkButton(
    master=help_frame,
    text="ì‚¬ìš©ë²•",
    font=("ë§‘ì€ ê³ ë”•", 11, "bold"),
    fg_color="#ffe0b2", hover_color="#ffc8a2",
    text_color="black", corner_radius=12,
    width=60, height=30,
    command=on_help
).pack(side="right")

# 3) ì¤‘ì•™ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­
ASSET_DIR = os.path.join(os.path.dirname(__file__), "power")
initial_img = os.path.join(ASSET_DIR, "ì²˜ë¦¬ì ë°°ê²½ì œê±°.png")
if os.path.exists(initial_img):
    pil = Image.open(initial_img)
    center_img = ctk.CTkImage(pil, size=(200,200))
    center_lbl = ctk.CTkLabel(master=root, image=center_img, text="", fg_color="transparent")
    center_lbl.image = center_img
    center_lbl.pack(expand=True, pady=0)
else:
    tk.Frame(root, bg=BG).pack(expand=True, fill="both")

# 4) í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ ì»¨í…Œì´ë„ˆ
group = ctk.CTkFrame(master=root, fg_color="#FFF8E1", corner_radius=20,
                    border_width=1, border_color="#e0e0e0")
group.pack(side="bottom", fill="x", padx=16, pady=(0,16))
for i in range(4): group.grid_columnconfigure(i, weight=1)  # 4ê°œ ë²„íŠ¼ë§Œ ì‚¬ìš©

# 5) ë²„íŠ¼ ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ + íŒì—… ì„¤ëª…
ICON_DIR = os.path.join(os.path.dirname(__file__), "icon")
icon_size = (64,64)
SPEED = 1000//60
buttons = [
    ("í‘œ ì—…ë°ì´íŠ¸.gif", on_table_update, "í‘œ ì—…ë°ì´íŠ¸"),
    ("í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸.gif", on_patient_update, "í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸"),
    ("ë„í‘œ ì—…ë°ì´íŠ¸.gif", on_chart_update, "ë„í‘œ ì—…ë°ì´íŠ¸"),
    ("ì¢…ë£Œ.gif", on_exit, "ì¢…ë£Œ"),
]

for idx,(g,cb,tip) in enumerate(buttons): create_hover_button(group, g, cb, tip, idx)

# 6) ìƒíƒœ í‘œì‹œ
status_frame = ctk.CTkFrame(master=root, fg_color="transparent")
status_frame.pack(side="bottom", fill="x", padx=16, pady=(0,0))
# ìƒíƒœ ë ˆì´ë¸” ì™¼ìª½ ì—¬ë°±ì„ 12pxë¡œ ì„¤ì •í•´ ë©”ì¸íŒŒì¼ ì¹´ë“œì™€ ë™ì¼í•œ ê°„ê²© ìœ ì§€
status_lbl = ctk.CTkLabel(master=status_frame, text="(ìƒíƒœí‘œì‹œ)", font=("ë§‘ì€ ê³ ë”•",11), text_color="#777777")
status_lbl.pack(side="left", padx=(12,0))

# 7) íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ
card = ctk.CTkFrame(master=root, fg_color="white", corner_radius=16, border_width=1, border_color="#e0e0e0")
card.pack(side="bottom", fill="x", padx=16, pady=(0,2))

# ë©”ì¸ íŒŒì¼ ì—…ë¡œë“œ ì·¨ì†Œ í•¨ìˆ˜
def cancel_main_file():
    UPLOADED_FILES["main"] = None
    update_file_labels()
    messagebox.showinfo("ì—…ë¡œë“œ ì·¨ì†Œ", "ë©”ì¸ íŒŒì¼ ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")

# í™˜ì íŒŒì¼ ì—…ë¡œë“œ ì·¨ì†Œ í•¨ìˆ˜
def cancel_patients_file():
    UPLOADED_FILES["patients"] = None
    update_file_labels()
    messagebox.showinfo("ì—…ë¡œë“œ ì·¨ì†Œ", "í™˜ì íŒŒì¼ ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")

# ê²°ì œ íŒŒì¼ ì—…ë¡œë“œ ì·¨ì†Œ í•¨ìˆ˜
def cancel_Paymentitems_file():
    UPLOADED_FILES["Paymentitems"] = None
    update_file_labels()
    messagebox.showinfo("ì—…ë¡œë“œ ì·¨ì†Œ", "ê²°ì œ íŒŒì¼ ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")

# 8) ì‹œì‘ì‹œ ì•± ì´ˆê¸°í™”
def init_app():
    """ì•± ì´ˆê¸°í™”: ê¸°ë³¸ ìƒíƒœ ì„¤ì •"""
    print("ì•± ì´ˆê¸°í™” ì¤‘...")
    # í•„ìš”í•œ í´ë” ìƒì„±
    setup_folders()
    
    # ìƒíƒœ ë ˆì´ë¸” ì´ˆê¸°í™”
    status_lbl.configure(text="íŒŒì¼ ì—…ë¡œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤", text_color="#555555")
    
    # ê¸°ë³¸ ë²„íŠ¼ ìƒíƒœ ì„¤ì • - ì¢…ë£Œ ë²„íŠ¼ë§Œ í™œì„±í™”í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë¹„í™œì„±í™”
    button_frames = group.winfo_children()
    if len(button_frames) >= 4:
        # í‘œ ì—…ë°ì´íŠ¸, í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸, ë„í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”
        for idx, frame in enumerate(button_frames):
            for widget in frame.winfo_children():
                if isinstance(widget, tk.Label):
                    if idx in [0, 1, 2] and hasattr(widget, 'disable'):  # í‘œ ì—…ë°ì´íŠ¸, í™˜ì ì •ë³´, ë„í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼
                        widget.disable()
    
    print("ì•± ì´ˆê¸°í™” ì™„ë£Œ")

# 100ms í›„ì— ì´ˆê¸°í™” ì‹¤í–‰ (UIê°€ ëª¨ë‘ í‘œì‹œëœ í›„)
root.after(100, init_app)

root.mainloop()
