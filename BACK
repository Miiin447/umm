import logging
import PIL
import pandas as pd
from datetime import datetime, timedelta
import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import os
import sys
import re
import threading
import time
import random
import traceback
import shutil
import subprocess
from openpyxl.styles import Font, Alignment, Border, Side
from openpyxl import load_workbook
from openpyxl.utils import range_boundaries, get_column_letter
from copy import copy
from PIL import Image, ImageTk
import numpy as np
import psutil
import platform

# ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
print("=== ë””ë²„ê·¸ ì •ë³´ ===")
print("Python ë²„ì „:", sys.version)
print("í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬:", os.getcwd())
print("sys.path:", sys.path)
print("í•„ìˆ˜ ëª¨ë“ˆ ì²´í¬:")
try:
    print("- pandas:", pd.__version__)
except Exception as e:
    print("- pandas: ì„¤ì¹˜ í•„ìš” (", str(e), ")")
try:
    print("- openpyxl:", openpyxl.__version__)
except Exception as e:
    print("- openpyxl: ì„¤ì¹˜ í•„ìš” (", str(e), ")")
try:
    print("- PIL:", PIL.__version__)
except Exception as e:
    print("- PIL: ì„¤ì¹˜ í•„ìš” (", str(e), ")")

print("\n=== íŒŒì¼ ì‹œìŠ¤í…œ ì •ë³´ ===")
try:
    print("í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:")
    for f in os.listdir('.'):
        print(f"- {f}")
except Exception as e:
    print("íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", str(e))

print("\n=== ì‹œìŠ¤í…œ ì •ë³´ ===")
print("í”Œë«í¼:", sys.platform)
if hasattr(sys, 'getwindowsversion'):
    print("Windows ë²„ì „:", sys.getwindowsversion())

# Try to import chardet, with fallback to using utf-8 encoding
try:
    import chardet
    HAS_CHARDET = True
except ImportError:
    HAS_CHARDET = False
    print("Warning: chardet module not found. Using utf-8 as default encoding.")

# ì˜ˆì™¸ ì²˜ë¦¬ ê°œì„ 
def custom_excepthook(type, value, tb):
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    # ì½˜ì†”ì— ì¶œë ¥
    print(f"\n=== ì˜ˆì™¸ ë°œìƒ ({timestamp}) ===")
    print(f"ì˜ˆì™¸ íƒ€ì…: {type}")
    print(f"ì˜ˆì™¸ ë©”ì‹œì§€: {value}")
    print("\nìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:")
    traceback.print_tb(tb)
    print("\nìƒì„¸ ì˜ˆì™¸ ì •ë³´:")
    trace_details = ''.join(traceback.format_exception(type, value, tb))
    print(trace_details)
    
    # ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
    system_info = f"""
ì‹œìŠ¤í…œ ì •ë³´:
- Python ë²„ì „: {sys.version}
- ìš´ì˜ì²´ì œ: {platform.platform()}
- ë©”ëª¨ë¦¬ ìƒíƒœ: {psutil.virtual_memory() if 'psutil' in sys.modules else 'ì •ë³´ ì—†ìŒ'}
- í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {os.getcwd()}
- ì‹¤í–‰ íŒŒì¼: {sys.argv[0]}
"""
    
    # ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡
    try:
        log_dir = "logs"
        if not os.path.exists(log_dir):
            os.makedirs(log_dir)
        
        log_file = os.path.join(log_dir, f"error_log_{datetime.now().strftime('%Y%m%d')}.txt")
        with open(log_file, "a", encoding="utf-8") as f:
            f.write(f"\n\n=== ì˜ˆì™¸ ë°œìƒ ({timestamp}) ===\n")
            f.write(f"ì˜ˆì™¸ íƒ€ì…: {type}\n")
            f.write(f"ì˜ˆì™¸ ë©”ì‹œì§€: {value}\n\n")
            f.write("ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:\n")
            f.write(trace_details)
            f.write("\n\n")
            f.write(system_info)
            f.write("\n===================================\n")
        
        print(f"ìƒì„¸ ì˜¤ë¥˜ ë¡œê·¸ê°€ {log_file}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as log_error:
        print(f"ë¡œê·¸ íŒŒì¼ì— ì˜¤ë¥˜ ê¸°ë¡ ì‹¤íŒ¨: {str(log_error)}")

sys.excepthook = custom_excepthook

# Helper functions
def adjust_formula(formula, source_row, target_row):
    """Adjust formula by changing row reference"""
    if not formula or not isinstance(formula, str) or not formula.startswith('='):
        return formula
    
    # ì •ê·œì‹ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì‹ ë‚´ì˜ ì…€ ì°¸ì¡° ì—…ë°ì´íŠ¸
    pattern = re.compile(r"([A-Z]+)" + str(source_row))
    new_formula = pattern.sub(lambda m: m.group(1) + str(target_row), formula)
    return new_formula
    
def extract_korean_initials(text):
    """í•œê¸€ ì´ë¦„ì—ì„œ ì´ˆì„±ë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜, ì˜ì–´ ì´ë¦„ì€ ê° ë‹¨ì–´ì˜ ì²« ê¸€ìë§Œ ëŒ€ë¬¸ìë¡œ ìœ ì§€"""
    # ë” ì´ìƒ ì´ˆì„± ë³€í™˜í•˜ì§€ ì•Šê³  ì›ë³¸ ê°’ ê·¸ëŒ€ë¡œ ë°˜í™˜
    return text

def standardize_value(val):
    """
    ê°’ì„ í‘œì¤€í™”í•©ë‹ˆë‹¤. ë‚ ì§œëŠ” YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ, í…ìŠ¤íŠ¸ëŠ” ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ê³  íŠ¹ìˆ˜ë¬¸ìë¥¼ ì œê±°í•©ë‹ˆë‹¤.
    """
    if val is None:
        return ""
    
    # ë‚ ì§œ ì²˜ë¦¬ ì‹œë„
    try:
        dt = pd.to_datetime(val, errors='coerce')
        if pd.notnull(dt):
            return dt.strftime("%Y%m%d")
    except:
        pass
    
    # í…ìŠ¤íŠ¸ ì²˜ë¦¬
    return re.sub(r'[^a-zA-Z0-9ê°€-í£]', '', str(val).lower())

def standardize_date(date_value):
    """
    ë‚ ì§œë¥¼ YYYYMMDD í˜•ì‹ìœ¼ë¡œ í‘œì¤€í™”í•©ë‹ˆë‹¤.
    ë‹¤ì–‘í•œ í˜•ì‹ì˜ ë‚ ì§œë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    """
    if not date_value:
        return None
        
    try:
        # datetime ê°ì²´ì¸ ê²½ìš°
        if isinstance(date_value, datetime):
            return date_value.strftime('%Y%m%d')
            
        # ë¬¸ìì—´ì¸ ê²½ìš°
        if isinstance(date_value, str):
            date_str = date_value.strip()
            
            # "2024ë…„ 3ì›” 15ì¼" í˜•ì‹ ì²˜ë¦¬
            if "ë…„" in date_str and "ì›”" in date_str and "ì¼" in date_str:
                year = int(date_str.split("ë…„")[0].strip())
                month = int(date_str.split("ë…„")[1].split("ì›”")[0].strip())
                day = int(date_str.split("ì›”")[1].split("ì¼")[0].strip())
                return f"{year:04d}{month:02d}{day:02d}"
            
            # "3ì›” 15, 2024" í˜•ì‹ ì²˜ë¦¬
            if "ì›”" in date_str and "," in date_str:
                month = int(date_str.split("ì›”")[0].strip())
                day = int(date_str.split("ì›”")[1].split(",")[0].strip())
                year = int(date_str.split(",")[1].strip())
                return f"{year:04d}{month:02d}{day:02d}"
            
            # ë‹¤ë¥¸ í˜•ì‹ì˜ ë‚ ì§œ ì²˜ë¦¬
            dt = pd.to_datetime(date_str, errors='coerce')
            if pd.notnull(dt):
                return dt.strftime('%Y%m%d')
        
        return None
        
    except Exception as e:
        print(f"ë‚ ì§œ ì •ê·œí™” ì‹¤íŒ¨: {date_value} -> {str(e)}")
        return None

class ExcelProcessor:
    def __init__(self):
        """Initialize the Excel Processor"""
        # ë¡œê±° ì„¤ì •
        self.logger = logging.getLogger("ExcelProcessor")
        
        # PyInstaller í™˜ê²½ í™•ì¸
        self.is_frozen = getattr(sys, 'frozen', False)
        
        # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì—ì„œëŠ” NullHandler ì¶”ê°€
        if self.is_frozen:
            # ì´ë¯¸ íŒŒì¼ ë¡œê¹…ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ propagateë§Œ Trueë¡œ ì„¤ì •
            self.logger.propagate = True
        else:
            # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì¼ë°˜ ë¡œê¹… ì‚¬ìš©
            self.setup_logging()
        
        # ë‹¨ìˆœí•œ ì´ˆê¸°í™” ë¡œê·¸
        self.logger.info("Excel Processor ì´ˆê¸°í™” ì¤‘...")
        
        # ì„¤ì • ì´ˆê¸°í™”
        self.main_file = None
        self.is_monitoring = False
        self.monitor_thread = None
        self.debug_visible = False
        self.last_saved_files = {}
        self.canceled = False
        
        # ì‹œì‘ ë©”ì‹œì§€
        self.logger.info("\n\n======== í”„ë¡œê·¸ë¨ ì‹œì‘ ========")
        self.logger.info(f"Python ë²„ì „: {sys.version}")
        
        # ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ë“±ë¡
        sys.excepthook = custom_excepthook
        
        # ì—¬ê¸°ì„œë¶€í„° ì‹œì‘ ë©”ì‹œì§€ ë’¤ì— ê¸°ë¡
        self.logger.info("ì˜ˆì™¸ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ ë“±ë¡ ì™„ë£Œ")
        
        # GUI ì´ˆê¸°í™”
        self.setup_gui()
        
        # ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ìŒì—ëŠ” ë¡œê·¸ ë ˆë²¨ì„ INFOë¡œ ì„¤ì • (ë””ë²„ê·¸ëŠ” ì²´í¬ë°•ìŠ¤ë¡œ í™œì„±í™”)
        self.logger.setLevel(logging.INFO)
        
        # ë””ë²„ê·¸ ëª¨ë“œ ì´ˆê¸°í™” (í”„ë¡œê·¸ë¨ ì‹œì‘ ì‹œ ì´ìŠ¤í„° ì—ê·¸ í‘œì‹œ - 5% í™•ë¥ )
        if random.random() < 0.05:  # 5% í™•ë¥ 
            self.show_easter_egg()
        
        # ì œì™¸í•  í™˜ì ë° ì˜ì‚¬ëª… ëª©ë¡ (í´ë˜ìŠ¤ ë³€ìˆ˜ë¡œ ì •ì˜)
        self.excluded_patients = {'TELE KDOC', 'NAM Hy'}
        self.excluded_doctors = {'Customer Support Center KDOC'}
    
    def show_easter_egg(self):
        try:
            # ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ ì„¤ì • (ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
            current_dir = os.path.abspath(os.path.dirname(__file__))
            image_paths = [
                os.path.join(current_dir, 'assets', 'yeah.png'),
                os.path.join(current_dir, 'assets', 'yeah2.png')
            ]
            
            # ëœë¤í•˜ê²Œ í•˜ë‚˜ì˜ ì´ë¯¸ì§€ ì„ íƒ
            image_path = random.choice(image_paths)
            
            # ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¦¬í„´
            if not os.path.exists(image_path):
                self.logger.debug(f"ì´ìŠ¤í„°ì—ê·¸ ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {image_path}")
                return
                
            # ë³„ë„ì˜ root window ìƒì„±
            easter_root = tk.Tk()
            easter_root.withdraw()  # ìˆ¨ê¸°ê¸°
            
            # ìƒˆ ì°½ ìƒì„±
            easter_window = tk.Toplevel(easter_root)
            easter_window.title("í˜ë‚´!")
            
            try:
                # ì´ë¯¸ì§€ ë¡œë“œ ë° í‘œì‹œ
                image = Image.open(image_path)
                image = image.resize((300, 300), Image.Resampling.LANCZOS)
                photo = ImageTk.PhotoImage(image, master=easter_window)  # master ì§€ì •
                
                # ì´ë¯¸ì§€ ë¼ë²¨ ìƒì„±
                label = tk.Label(easter_window, image=photo)
                label.image = photo  # ì°¸ì¡° ìœ ì§€
                label.pack()
                
            except Exception as img_error:
                self.logger.debug(f"ì´ë¯¸ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: {str(img_error)}")
                # ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
                label = tk.Label(easter_window, text="í˜ë‚´!", font=("Arial", 24))
                label.pack(pady=20)
            
            # í…ìŠ¤íŠ¸ ì¶”ê°€
            text_label = tk.Label(easter_window, text="í˜ë‚´!", font=("Arial", 16))
            text_label.pack(pady=10)
            
            # ì°½ì„ í™”ë©´ ì¤‘ì•™ì— ìœ„ì¹˜
            window_width = 320
            window_height = 380
            screen_width = easter_window.winfo_screenwidth()
            screen_height = easter_window.winfo_screenheight()
            x = (screen_width - window_width) // 2
            y = (screen_height - window_height) // 2
            easter_window.geometry(f"{window_width}x{window_height}+{x}+{y}")
            
            # ì°½ ì„¤ì •
            easter_window.lift()  # ì°½ì„ ë§¨ ì•ìœ¼ë¡œ
            easter_window.focus_force()  # í¬ì»¤ìŠ¤ ê°•ì œ ì§€ì •
            
            # 5ì´ˆ í›„ ì°½ ë‹«ê¸°
            def cleanup():
                try:
                    easter_window.destroy()
                    easter_root.destroy()
                except Exception as cleanup_error:
                    self.logger.debug(f"ì°½ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(cleanup_error)}")
                
            easter_window.after(5000, cleanup)
            
            # ì´ë²¤íŠ¸ ë£¨í”„ ì‹œì‘ (non-blocking)
            easter_window.after(1, lambda: easter_root.mainloop())
            
        except Exception as e:
            self.logger.debug(f"ì´ìŠ¤í„°ì—ê·¸ ì´ë¯¸ì§€ í‘œì‹œ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            if 'easter_root' in locals():
                try:
                    easter_root.destroy()
                except:
                    pass
    
    def setup_logging(self):
        """Initialize logging system with minimal settings"""
        # ë£¨íŠ¸ ë¡œê±°ì˜ í•¸ë“¤ëŸ¬ê°€ ì—†ì„ ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”
        root_logger = logging.getLogger()
        if not root_logger.handlers:
            # ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì œê±°
            for handler in root_logger.handlers[:]:
                root_logger.removeHandler(handler)
                
            # ë£¨íŠ¸ ë¡œê±° ë ˆë²¨ ì„¤ì •
            root_logger.setLevel(logging.INFO)  # ê¸°ë³¸ì ìœ¼ë¡œ INFO ì´ìƒë§Œ í‘œì‹œ
            
            # ê°„ì†Œí™”ëœ í¬ë§· ì„¤ì •
            simple_formatter = logging.Formatter(
                '[%(asctime)s] %(levelname)s: %(message)s',
                datefmt='%H:%M:%S'
            )
            
            # ì½˜ì†” í•¸ë“¤ëŸ¬ ì¶”ê°€
            console_handler = logging.StreamHandler()
            console_handler.setLevel(logging.INFO)
            console_handler.setFormatter(simple_formatter)
            root_logger.addHandler(console_handler)
            
        # ê°œë³„ ë¡œê±° ì„¤ì • (ExcelProcessor ë¡œê±°)
        self.logger.setLevel(logging.INFO)  # ê¸°ë³¸ì ìœ¼ë¡œ INFO ì´ìƒë§Œ í‘œì‹œ
        self.logger.propagate = True  # ë£¨íŠ¸ ë¡œê±°ë¡œ ì „íŒŒ í—ˆìš©
        
        print("ë¡œê¹… ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ")
        
    def setup_folders(self):
        """Create necessary folders if they don't exist"""
        folders = ['DONE', 'BACK UP', 'SKIPPED']
        for folder in folders:
            if not os.path.exists(folder):
                os.makedirs(folder)
                self.logger.info(f"{folder} í´ë” ìƒì„± ì™„ë£Œ")
                
    def setup_gui(self):
        self.root = tk.Tk()
        self.root.title("ğŸŒ¸ ì˜¤ë¦¬ì˜¨ ì°¬ì–‘í•´ ğŸŒ¸")
        
        # ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
        style = ttk.Style()
        self.root.configure(bg="#FFF8E1")  # í¬ë¦¼ìƒ‰ ë°°ê²½ (ì´ì „: #FFF0F5)
        
        # ì°½ì´ ë‹«í ë•Œ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
        
        # GUI êµ¬ì„± ìš”ì†Œ ìƒì„±
        self.create_gui_elements()
        
    def on_closing(self):
        """í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì²˜ë¦¬"""
        if messagebox.askokcancel("ì¢…ë£Œ", "í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            try:
                # ì¢…ë£Œ ë©”ì‹œì§€ ì¶œë ¥
                self.logger.info("í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
                
                # stdoutì— ì•ˆì „í•˜ê²Œ ì¶œë ¥ ì‹œë„
                try:
                    if hasattr(sys, 'stdout') and sys.stdout and hasattr(sys.stdout, 'write'):
                        sys.stdout.write("í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë©ë‹ˆë‹¤.\n")
                        if hasattr(sys.stdout, 'flush'):
                            sys.stdout.flush()
                except Exception:
                    pass
                
                # ì§„í–‰ í‘œì‹œì¤„ ì¤‘ì§€
                try:
                    if hasattr(self, 'progress_bar'):
                        self.progress_bar.stop()
                except Exception:
                    pass
                
                # ë¦¬ë””ë ‰ì…˜ í•´ì œ - ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                if hasattr(self, 'stdout_redirector'):
                    try:
                        if hasattr(self.stdout_redirector, 'original_stdout'):
                            sys.stdout = self.stdout_redirector.original_stdout
                    except Exception:
                        # ê¸°ë³¸ ì¶œë ¥ìœ¼ë¡œ ë³µì›
                        sys.stdout = sys.__stdout__
                        
                if hasattr(self, 'stderr_redirector'):
                    try:
                        if hasattr(self.stderr_redirector, 'original_stdout'):
                            sys.stderr = self.stderr_redirector.original_stdout
                    except Exception:
                        # ê¸°ë³¸ ì¶œë ¥ìœ¼ë¡œ ë³µì›
                        sys.stderr = sys.__stderr__
            except Exception as e:
                print(f"ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            finally:
                # ì¦‰ì‹œ ê°•ì œ ì¢…ë£Œ
                os._exit(0)
    
    def create_gui_elements(self):
        """Set up the GUI interface"""
        self.root.configure(bg="#FFF8E1")  # í¬ë¦¼ìƒ‰ ë°°ê²½ (ì´ì „: #FFF0F5)
        
        # Set up styles
        style = ttk.Style()
        style.theme_use("clam")
        
        # Define styles
        style.configure('Main.TFrame', background="#FFF8E1")
        style.configure('TLabel', background="#FFF8E1", foreground="#5D4037", font=('Malgun Gothic', 10))
        style.configure('Title.TLabel', font=('Malgun Gothic', 18, 'bold'), foreground="#EC407A", background="#FFF8E1")
        style.configure('Debug.TCheckbutton',
                       background="#FFF8E1",
                       foreground="#5D4037",
                       font=('Malgun Gothic', 10),
                       focuscolor='',
                       indicatorcolor='#FFBDBD')
        
        # Create the main paned window
        self.paned_window = ttk.PanedWindow(self.root, orient=tk.HORIZONTAL)
        self.paned_window.pack(fill=tk.BOTH, expand=True)
        
        # Main frame
        self.main_frame = ttk.Frame(self.paned_window, style='Main.TFrame', padding=10)
        
        # Debug frame (initially hidden)
        self.debug_frame = ttk.Frame(self.paned_window, style='Main.TFrame', padding=10)
        
        # Add the main frame to the paned window
        self.paned_window.add(self.main_frame, weight=1)
        
        # Create a title with cute stars
        title_label = ttk.Label(self.main_frame, text="âœ¨ KDOC ë§ˆí¬7 V3.0 âœ¨", style='Title.TLabel')
        title_label.pack(pady=(20, 20))
        
        # ë„ì›€ë§ ë²„íŠ¼ ìƒì„±
        help_frame = tk.Frame(self.main_frame, bg="#8D6E63", padx=1, pady=1, bd=0)  # ê°ˆìƒ‰ (ì´ì „: #FF85A2)
        help_frame.place(relx=0.98, rely=0.02, anchor="ne")
        
        help_button = tk.Button(
            help_frame,
            text="?",
            font=("Arial", 12, "bold"),
            fg="#FFFFFF",
            bg="#8D6E63",  # ê°ˆìƒ‰ (ì´ì „: #FF85A2)
            relief="flat",
            cursor="hand2",
            command=self.show_help,
            width=1,
            padx=5
        )
        help_button.pack()
        
        # ì›í˜• ëª¨ì–‘ ë§Œë“¤ê¸°
        def make_circle():
            help_frame.update_idletasks()  # ìœ„ì ¯ í¬ê¸° ì—…ë°ì´íŠ¸
            width = help_frame.winfo_width()
            height = help_frame.winfo_height()
            
            # ë” í° ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì›í˜• í¬ê¸° ì„¤ì •
            size = max(width, height)
            
            # ì›í˜•ìœ¼ë¡œ ë§ˆìŠ¤í‚¹í•  ìº”ë²„ìŠ¤ ìƒì„±
            canvas = tk.Canvas(self.main_frame, width=size, height=size, 
                            bg="#FFF8E1", highlightthickness=0)
            canvas.place(relx=0.95, rely=0.03, anchor="ne")
            
            # ì›í˜• ìƒì„±
            canvas.create_oval(0, 0, size, size, fill="#8D6E63", outline="#6D4C41", width=1)  # ê°ˆìƒ‰ (ì´ì „: #FF85A2)
            
            # ì›í˜• ì¤‘ì•™ì— í…ìŠ¤íŠ¸ ë°°ì¹˜
            canvas.create_text(size/2, size/2, text="?", fill="#FFFFFF", 
                            font=("Malgun Gothic", 12, "bold"))
            
            # í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
            canvas.bind("<Button-1>", lambda e: self.show_help())
            canvas.bind("<Enter>", lambda e: canvas.configure(cursor="hand2"))
        
        # UI ë Œë”ë§ í›„ ì›í˜• ë²„íŠ¼ ìƒì„±
        self.root.after(10, lambda: [help_frame.place_forget(), make_circle()])
        
        # íŒŒì¼ ìƒíƒœ í‘œì‹œ í”„ë ˆì„
        file_status_frame = tk.Frame(self.main_frame, bg="#FFF3E0", padx=15, pady=15, bd=1)  # ì—°í•œ í¬ë¦¼ìƒ‰ (ì´ì „: #FFEFF5)
        file_status_frame.pack(fill=tk.X, pady=10)
        
        # ë©”ì¸ íŒŒì¼ ë ˆì´ë¸”
        self.main_file_label = tk.Label(
            file_status_frame,
            text="ë©”ì¸ íŒŒì¼: íŒŒì¼ ê°ì§€ í•„ìš”",
            font=("Malgun Gothic", 10),
            bg="#FFF3E0",  # ì—°í•œ í¬ë¦¼ìƒ‰ (ì´ì „: #FFEFF5)
            fg="#5D4037"
        )
        self.main_file_label.pack(anchor=tk.W, pady=2)
        
        self.patients_label = tk.Label(
            file_status_frame,
            text="Patients íŒŒì¼: íŒŒì¼ ê°ì§€ í•„ìš”",
            font=("Malgun Gothic", 10),
            bg="#FFF3E0",  # ì—°í•œ í¬ë¦¼ìƒ‰ (ì´ì „: #FFEFF5)
            fg="#5D4037"
        )
        self.patients_label.pack(anchor=tk.W, pady=2)
        
        self.payment_label = tk.Label(
            file_status_frame,
            text="PaymentItems íŒŒì¼: íŒŒì¼ ê°ì§€ í•„ìš”",
            font=("Malgun Gothic", 10),
            bg="#FFF3E0",  # ì—°í•œ í¬ë¦¼ìƒ‰ (ì´ì „: #FFEFF5)
            fg="#5D4037"
        )
        self.payment_label.pack(anchor=tk.W, pady=2)
        
        notice_label = tk.Label(
            file_status_frame, 
            text="ğŸ” ì²˜ë¦¬í•  íŒŒì¼ì€ í”„ë¡œê·¸ë¨ê³¼ ê°™ì€ í´ë”ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.", 
            bg="#FFF3E0",  # ì—°í•œ í¬ë¦¼ìƒ‰ (ì´ì „: #FFEFF5)
            fg="#9C6369", 
            font=("Malgun Gothic", 9, "italic")
        )
        notice_label.pack(anchor=tk.W, pady=(10, 2))
        
        # Create buttons frame
        buttons_frame = tk.Frame(self.main_frame, bg="#FFF8E1")
        buttons_frame.pack(fill=tk.X, pady=10)  # íŒ¨ë”© ì¤„ì„
        
        # Create buttons
        self.detect_button = tk.Button(
            file_status_frame,
            text="íŒŒì¼ ê°ì§€",
            font=("Malgun Gothic", 10),
            bg="#F5CBA7",  # í™©í† ìƒ‰ (ì´ì „: ì—†ìŒ ë˜ëŠ” ì‹œìŠ¤í…œ ê¸°ë³¸ê°’)
            fg="#5D4037",
            relief="flat",
            cursor="hand2",
            command=lambda: threading.Thread(target=self.update_file_labels, args=(True,), daemon=True).start()
        )
        self.detect_button.pack(anchor=tk.W, pady=(10, 5))
        
        # ê¸°ëŠ¥ ë²„íŠ¼ë“¤ì€ ì²˜ìŒì— ë¹„í™œì„±í™” ìƒíƒœë¡œ ì‹œì‘
        self.update_tables_btn = self.create_cute_button(buttons_frame, "í‘œ ì—…ë°ì´íŠ¸", "ğŸ“Š", 
                                                        self.on_update_click, state=tk.DISABLED)
        
        self.update_patient_btn = self.create_cute_button(buttons_frame, "í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸", "ğŸ‘¤", 
                                                         self.on_patient_click, state=tk.DISABLED)
        
        self.exit_btn = self.create_cute_button(buttons_frame, "ì¢…ë£Œ", "ğŸšª", 
                                               self.on_exit_click)
        
        # ë²„íŠ¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
        self.buttons = [self.detect_button, self.update_tables_btn, self.update_patient_btn, self.exit_btn]
        
        # ìƒíƒœ í‘œì‹œ ë ˆì´ë¸” ë° ì§„í–‰ í‘œì‹œì¤„ ìƒì„±
        status_frame = tk.Frame(self.main_frame, bg="#FFF8E1")
        status_frame.pack(fill=tk.X, pady=5)
        
        self.status_label = tk.Label(
            status_frame,
            text="íŒŒì¼ ê°ì§€ ì¤‘...",
            font=("Malgun Gothic", 9),
            bg="#FFF8E1",
            fg="black"
        )
        self.status_label.pack(side=tk.LEFT, padx=5)
        
        self.progress_bar = ttk.Progressbar(
            status_frame,
            mode="indeterminate",
            length=200
        )
        self.progress_bar.pack(side=tk.RIGHT, padx=5, fill=tk.X, expand=True)
        
        # Debug toggle - ê·€ì—¬ìš´ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
        debug_frame = tk.Frame(self.main_frame, bg="#FFF8E1")
        debug_frame.pack(fill=tk.X, pady=10, side=tk.BOTTOM)
        
        self.debug_var = tk.BooleanVar(value=False)
        
        # ê·€ì—¬ìš´ ì²´í¬ë°•ìŠ¤ë¡œ ë³€ê²½
        self.debug_check = tk.Checkbutton(
            debug_frame, 
            text="ğŸ ë””ë²„ê·¸ ë¡œê·¸ ë³´ê¸°", 
            variable=self.debug_var, 
            command=self.toggle_debug,
            bg="#FFF8E1",
            fg="#EC407A",
            font=("Malgun Gothic", 10),
            selectcolor="#FFD6E0",
            activebackground="#FFF8E1",
            relief="flat"
        )
        self.debug_check.pack(side=tk.LEFT)
        
        # ë””ë²„ê·¸ ì²´í¬ë°•ìŠ¤ ì˜†ì— ë„ì›€ë§ í‘œì‹œ ì¶”ê°€
        debug_help = tk.Label(
            debug_frame,
            text="(ìƒì„¸ ë¡œê·¸ í‘œì‹œ)",
            font=("Malgun Gothic", 8, "italic"),
            bg="#FFF8E1",
            fg="#888888"
        )
        debug_help.pack(side=tk.LEFT, padx=5)
        
        # Create log text widget inside debug frame with rounded corners
        self.log_text = tk.Text(
            self.debug_frame, 
            height=35,  # ë†’ì´ ì¦ê°€ (30 -> 35)
            width=140,  # ë„ˆë¹„ ì¦ê°€ (120 -> 140)
            wrap=tk.WORD,
            font=('Consolas', 10),  # ê³ ì •í­ í°íŠ¸ ì‚¬ìš©
            bg='#FFFFFF',  # ë°°ê²½ìƒ‰ ë³€ê²½
            bd=1,
            relief="flat",
            padx=8,  # ë‚´ë¶€ íŒ¨ë”© ì¶”ê°€
            pady=8
        )
        
        # Create scrollbar for log text - ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë°°ì¹˜
        scrollbar = ttk.Scrollbar(self.debug_frame, command=self.log_text.yview)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        self.log_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=5, pady=5)
        self.log_text.config(yscrollcommand=scrollbar.set)
        
        # Create GUI log handler
        self.create_gui_log_handler()
        
        # í”„ë¡œê·¸ë¨ ë²„ì „ í‘œì‹œ - ê·€ì—¬ìš´ ìŠ¤íƒ€ì¼
        version_label = tk.Label(
            self.main_frame,
            text="v3.0 ğŸ’•",
            font=("Malgun Gothic", 8),
            fg="#EC407A",
            bg="#FFF8E1"
        )
        version_label.pack(side=tk.BOTTOM, anchor=tk.SE, padx=5, pady=5)
        
        # Set initial window size and position
        self.root.geometry("500x700")  # ë†’ì´ ì¦ê°€
        self.center_window()
        
        # ì²« ì‹¤í–‰ì‹œ íŒŒì¼ ê°ì§€ ìˆ˜í–‰
        self.update_file_labels()
    
    def create_cute_button(self, parent, text, emoji, command, state=tk.NORMAL):
        """Create a cute button with shadow effect"""
        # Shadow frame
        frame = tk.Frame(parent, bg="#D5A67E", padx=2, pady=2, bd=0)  # ê·¸ë¦¼ì ìƒ‰ìƒ (ì´ì „: #FFBDBD)
        frame.pack(fill=tk.X, pady=5)  # í”„ë ˆì„ íŒ¨í‚¹ ì¶”ê°€
        
        # Actual button
        button = tk.Button(
            frame,
            text=f"{emoji} {text}",
            font=("Malgun Gothic", 11),
            bg="#F5CBA7",  # ë²„íŠ¼ ë°°ê²½ìƒ‰ (ì´ì „: #FFE1E1)
            fg="#5D4037",
            relief="flat",
            cursor="hand2",
            command=command,
            state=state,
            activebackground="#E8D8C3"  # í´ë¦­ ì‹œ ë°°ê²½ìƒ‰ (ì´ì „: #FFCCE5)
        )
        button.pack(fill=tk.X, ipady=5)  # ë‚´ë¶€ íŒ¨ë”© ì¤„ì„
        
        # ë§ˆìš°ìŠ¤ í˜¸ë²„ ì´ë²¤íŠ¸
        button.bind("<Enter>", lambda e: self._on_button_hover(button, frame))
        button.bind("<Leave>", lambda e: self._on_button_leave(button, frame))
        
        return button
    
    def _on_button_hover(self, btn, frame):
        """Button hover effect"""
        btn.config(bg="#E8D8C3")  # í™©í† ìƒ‰ ê³„ì—´ (ì´ì „: #FFCCE5)
        frame.config(bg="#C8A382")  # ë” ì§„í•œ ê°ˆìƒ‰ (ì´ì „: #FF9EB5)
    
    def _on_button_leave(self, btn, frame):
        """Button leave effect"""
        btn.config(bg="#F5CBA7")  # ì›ë˜ ìƒ‰ìƒ (ì´ì „: #FFE1E1)
        frame.config(bg="#D5A67E")  # ì›ë˜ ê·¸ë¦¼ì ìƒ‰ìƒ (ì´ì „: #FFBDBD)
    
    def toggle_debug(self):
        """ë””ë²„ê·¸ ëª¨ë“œ í† ê¸€ (ë””ë²„ê·¸ ë¡œê·¸ ì°½ í‘œì‹œ/ìˆ¨ê¹€)"""
        try:
            self.debug_visible = not self.debug_visible
            if self.debug_visible:
                # ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
                logging.getLogger().setLevel(logging.DEBUG)
                self.logger.setLevel(logging.DEBUG)
                
                # ë””ë²„ê·¸ í™œì„±í™” ë¡œê·¸
                self.logger.debug("ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”")
                
                # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì—ì„œ ë¡œê·¸ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (GUIì—ëŠ” í‘œì‹œ ì•ˆ ë¨)
                if self.is_frozen:
                    print("ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”")
                    self.logger.debug("íŒ¨í‚¤ì§•ëœ í™˜ê²½ì—ì„œ ë””ë²„ê·¸ ëª¨ë“œë¥¼ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤.")
                    self.logger.debug("ë¡œê·¸ëŠ” 'logs' í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤.")
                    
                    # ë©”ì‹œì§€ë°•ìŠ¤ë¡œ ì•Œë¦¼
                    messagebox.showinfo("ë””ë²„ê·¸ ëª¨ë“œ", 
                        "ë””ë²„ê·¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\në¡œê·¸ëŠ” 'logs' í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤.")
                    return  # GUI ë³€ê²½ì€ í•˜ì§€ ì•ŠìŒ
                
                # ë””ë²„ê·¸ í”„ë ˆì„ì´ ì¶”ê°€ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                try:
                    panes = self.paned_window.panes()
                    debug_frame_added = len(panes) > 1
                except:
                    debug_frame_added = False
                
                if not debug_frame_added:
                    # ë””ë²„ê·¸ í”„ë ˆì„ ì¶”ê°€
                    self.paned_window.add(self.debug_frame, weight=1)
                
                # ì°½ í¬ê¸° ì¡°ì •
                self.root.geometry("1200x800")
                
                # ì•½ê°„ì˜ ì§€ì—° í›„ íŒ¨ë„ ìœ„ì¹˜ ì¡°ì •
                self.root.after(100, self._adjust_sash_position)
            else:
                # ë””ë²„ê·¸ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ë©´ ë¡œê·¸ ë ˆë²¨ì„ INFOë¡œ ì„¤ì •
                logging.getLogger().setLevel(logging.INFO)
                self.logger.setLevel(logging.INFO)
                self.logger.info("ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™”")
                
                # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì¸ ê²½ìš°
                if self.is_frozen:
                    print("ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™”")
                    return  # GUI ë³€ê²½ì€ í•˜ì§€ ì•ŠìŒ
                    
                # ë””ë²„ê·¸ í”„ë ˆì„ ì œê±°
                try:
                    self.paned_window.forget(self.debug_frame)
                except:
                    pass
                
                # ì°½ í¬ê¸° ì¡°ì •
                self.root.geometry("500x700")
        except Exception as e:
            # ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ ê¸°ë¡
            self.logger.error(f"ë””ë²„ê·¸ ì°½ í† ê¸€ ì¤‘ ì˜¤ë¥˜: {str(e)}")
        
        # ì°½ ì¤‘ì•™ ì •ë ¬
        self.center_window()
    
    def _adjust_sash_position(self):
        """íŒ¨ë„ ë¶„í•  ìœ„ì¹˜ ì¡°ì • (ë³„ë„ ë©”ì„œë“œë¡œ ë¶„ë¦¬)"""
        try:
            pane_size = self.paned_window.winfo_width()
            if pane_size > 100:  # ì¶©ë¶„í•œ ë„ˆë¹„ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¡°ì •
                self.paned_window.sashpos(0, int(pane_size * 0.3))
        except:
            pass
    
    def create_gui_log_handler(self):
        """ë¡œê·¸ ë©”ì‹œì§€ë¥¼ GUIì— í‘œì‹œí•˜ê¸° ìœ„í•œ í•¸ë“¤ëŸ¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤"""
        # PyInstaller í™˜ê²½ì¸ì§€ í™•ì¸
        is_frozen = getattr(sys, 'frozen', False)
        
        # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì—ì„œëŠ” ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ
        if is_frozen:
            return
        
        # í‘œì¤€ ì¶œë ¥ê³¼ í‘œì¤€ ì—ëŸ¬ë¥¼ ê°€ë¡œì±„ê¸° ìœ„í•œ í´ë˜ìŠ¤ ì •ì˜
        class StdoutRedirector:
            """í‘œì¤€ ì¶œë ¥(stdout/stderr)ì„ GUI í…ìŠ¤íŠ¸ ìœ„ì ¯ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” í´ë˜ìŠ¤"""
            def __init__(self, text_widget, level):
                self.text_widget = text_widget
                self.level = level  # 'INFO' ë˜ëŠ” 'ERROR'
                self.buffer = ""
                self.prev_text = None
                self.dup_count = 0
                self.max_output = 500
                self.line_count = 0
                # ì›ë˜ í‘œì¤€ ì¶œë ¥ ì €ì¥
                self.original_stdout = getattr(sys, f'__{level.lower()}__', None)
                
            def write(self, string):
                """í…ìŠ¤íŠ¸ë¥¼ ì“°ê³  GUIì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤"""
                if not string:  # ë¹ˆ ë¬¸ìì—´ì´ë©´ ë¬´ì‹œ
                    return
                    
                # ì›ë˜ stdout/stderr ì¶œë ¥ ì‹œë„ - ì•ˆì „ì¥ì¹˜ ì¶”ê°€
                if not is_frozen:  # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì—ì„œëŠ” ì›ë³¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì¶œë ¥í•˜ì§€ ì•ŠìŒ
                    try:
                        orig_stream = getattr(sys, f'__{self.level.lower()}__', None)
                        if orig_stream and hasattr(orig_stream, 'write'):
                            orig_stream.write(string)
                    except (AttributeError, IOError):
                        # í‘œì¤€ ì¶œë ¥ì´ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ë¬´ì‹œ
                        pass
                
                # í…ìŠ¤íŠ¸ ìœ„ì ¯ì´ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ
                if not self.text_widget:
                    return
                
                # ê°œí–‰ ë¬¸ìë§Œ ìˆëŠ” ê²½ìš° ë²„í¼ ì¶œë ¥ í›„ ì¢…ë£Œ
                if string == '\n' and self.buffer:
                    self._update_gui(self.buffer)
                    self.buffer = ""
                    return
                
                self.buffer += string
                
                # ì™„ì „í•œ ë¼ì¸ì´ ìˆëŠ”ì§€ í™•ì¸
                if '\n' in self.buffer:
                    lines = self.buffer.split('\n')
                    # ë§ˆì§€ë§‰ ë¼ì¸ì€ ì™„ì „í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
                    self.buffer = lines[-1]
                    
                    # ì™„ì „í•œ ë¼ì¸ë“¤ì„ GUIì— ì—…ë°ì´íŠ¸
                    for line in lines[:-1]:
                        if line:  # ë¹ˆ ë¼ì¸ì€ ê±´ë„ˆëœ€
                            self._update_gui(line)
            
            def _update_gui(self, text):
                """GUI í…ìŠ¤íŠ¸ ìœ„ì ¯ì— í…ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤"""
                if not text.strip():  # ë¹ˆ í…ìŠ¤íŠ¸ëŠ” ë¬´ì‹œ
                    return
                
                try:
                    tag = 'INFO' if self.level == 'INFO' else 'ERROR'
                    self.text_widget.after(0, self._insert_text, text, tag)
                except Exception:
                    pass
                
            def _insert_text(self, text, tag):
                """í…ìŠ¤íŠ¸ ìœ„ì ¯ì— í…ìŠ¤íŠ¸ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤"""
                try:
                    if not self.text_widget or not self.text_widget.winfo_exists():
                        return
                    
                    # ì¤‘ë³µ ë©”ì‹œì§€ ê²€ì‚¬
                    if text == self.prev_text:
                        self.dup_count += 1
                        self.text_widget.config(state=tk.NORMAL)
                        
                        # ë§ˆì§€ë§‰ ì¤„ ì—…ë°ì´íŠ¸ ì‹œë„
                        try:
                            last_line = self.text_widget.get("end-2l", "end-1c")
                            if last_line.startswith(text):
                                # ì¤‘ë³µ ì¹´ìš´íŠ¸ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
                                count_match = re.search(r'\((\d+)\)$', last_line)
                                if count_match:
                                    # ê¸°ì¡´ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                                    old_count = count_match.group(1)
                                    self.text_widget.delete("end-" + str(len(old_count) + 3) + "c", "end-1c")
                                    self.text_widget.insert("end-1c", f"({self.dup_count})")
                                else:
                                    # ì¹´ìš´íŠ¸ ìƒˆë¡œ ì¶”ê°€
                                    self.text_widget.delete("end-2l", "end-1c")
                                    self.text_widget.insert("end", f"{text} ({self.dup_count})\n")
                            else:
                                # ë§ˆì§€ë§‰ ì¤„ì´ í˜„ì¬ í…ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ìƒˆ ì¤„ì— ì¶”ê°€
                                self.text_widget.insert("end", f"{text} ({self.dup_count})\n")
                        except:
                            # ì˜¤ë¥˜ ë°œìƒ ì‹œ ê·¸ëƒ¥ ìƒˆ ì¤„ì— ì¶”ê°€
                            self.text_widget.insert("end", f"{text} ({self.dup_count})\n")
                        
                        self.text_widget.see("end")
                        self.text_widget.config(state=tk.DISABLED)
                        return
                    
                    # ìƒˆ ë©”ì‹œì§€
                    self.prev_text = text
                    self.dup_count = 1
                    
                    # ìµœëŒ€ ë¼ì¸ ìˆ˜ ê´€ë¦¬
                    if self.line_count > self.max_output:
                        self.text_widget.config(state=tk.NORMAL)
                        self.text_widget.delete("1.0", "10.0")
                        self.line_count -= 10
                    
                    self.text_widget.config(state=tk.NORMAL)
                    self.text_widget.insert("end", text + '\n', tag)
                    self.text_widget.see("end")
                    self.text_widget.config(state=tk.DISABLED)
                    self.line_count += 1
                except Exception:
                    pass
                    
            def flush(self):
                """ì¶œë ¥ ë²„í¼ë¥¼ ë¹„ì›ë‹ˆë‹¤"""
                if self.buffer:
                    self._update_gui(self.buffer)
                    self.buffer = ""
                
                # ì›ë˜ stdout/stderrë„ í”ŒëŸ¬ì‹œ ì‹œë„
                if not is_frozen:
                    try:
                        orig_stream = getattr(sys, f'__{self.level.lower()}__', None)
                        if orig_stream and hasattr(orig_stream, 'flush'):
                            orig_stream.flush()
                    except (AttributeError, IOError):
                        pass
            
            def isatty(self):
                """í„°ë¯¸ë„ê³¼ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
                return False
        
        class GuiLogHandler(logging.Handler):
            """GUIì— ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ëŠ” í•¸ë“¤ëŸ¬"""
            def __init__(self, app, text_widget):
                super().__init__()
                self.app = app
                self.text_widget = text_widget
                self.log_count = 0
                self.max_logs = 500
                # ìœ„ì ¯ ìœ íš¨ì„± í”Œë˜ê·¸ ì¶”ê°€
                self.is_valid = True
                
                # PyInstaller í™˜ê²½ í™•ì¸
                self.is_frozen = getattr(sys, 'frozen', False)
                
                # ë¡œê·¸ íƒœê·¸ ì„¤ì • - ì˜ˆì™¸ì²˜ë¦¬ ì¶”ê°€
                try:
                    if self.text_widget and self.text_widget.winfo_exists():
                        self.text_widget.tag_configure("ERROR", foreground="red")
                        self.text_widget.tag_configure("WARNING", foreground="orange")
                        self.text_widget.tag_configure("INFO", foreground="blue")
                        self.text_widget.tag_configure("DEBUG", foreground="gray")
                except (tk.TclError, AttributeError, RuntimeError):
                    # ìœ„ì ¯ ë¬¸ì œ ë°œìƒ ì‹œ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ í‘œì‹œ
                    self.is_valid = False
                    
                self.previous_message = None
                self.duplicate_count = 0
                
            def emit(self, record):
                """ë¡œê·¸ ë ˆì½”ë“œë¥¼ ì²˜ë¦¬í•˜ì—¬ GUIì— í‘œì‹œí•©ë‹ˆë‹¤."""
                # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì´ë©´ ë¡œê·¸ë¥¼ ìµœì†Œí™”
                if self.is_frozen:
                    # ì‹¬ê°í•œ ì—ëŸ¬ì¸ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                    if record.levelno >= logging.ERROR:
                        try:
                            print(self.format(record))
                        except:
                            pass
                    return
                
                # ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì²˜ë¦¬ ì¤‘ë‹¨
                if not self.is_valid:
                    return
                    
                try:
                    # í…ìŠ¤íŠ¸ ìœ„ì ¯ì´ ë” ì´ìƒ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ ì²˜ë¦¬ ì¤‘ë‹¨
                    if not self.text_widget:
                        self.is_valid = False
                        return
                        
                    # Tkinter ìœ„ì ¯ ìœ íš¨ì„± í™•ì¸
                    try:
                        if not hasattr(self.text_widget, 'winfo_exists') or not self.text_widget.winfo_exists():
                            self.is_valid = False
                            return
                    except (tk.TclError, AttributeError, RuntimeError):
                        # Tkinter ê´€ë ¨ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ê°„ì£¼
                        self.is_valid = False
                        return
                    
                    # ë¡œê·¸ ë©”ì‹œì§€ í˜•ì‹í™”
                    log_entry = self.format(record)
                    
                    # ì¤‘ë³µ ë©”ì‹œì§€ ì²˜ë¦¬
                    if log_entry == self.previous_message:
                        self.duplicate_count += 1
                        try:
                            self.text_widget.config(state=tk.NORMAL)
                            # ë§ˆì§€ë§‰ ì¤„ì— ì¤‘ë³µ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                            try:
                                self.text_widget.delete(f"end-{len(str(self.duplicate_count-1)) + 3}c linestart", "end-1c lineend")
                                self.text_widget.insert("end-1c linestart", f"{log_entry} ({self.duplicate_count})")
                            except:
                                # ìœ„ ë°©ì‹ì´ ì‹¤íŒ¨í•˜ë©´ ê·¸ëƒ¥ ìƒˆ ì¤„ì— ì¶”ê°€
                                self.text_widget.insert("end", f"{log_entry} ({self.duplicate_count})\n")
                            self.text_widget.see("end")
                            self.text_widget.config(state=tk.DISABLED)
                        except tk.TclError:
                            # Tk ì˜¤ë¥˜ ë°œìƒ ì‹œ ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒìœ¼ë¡œ í‘œì‹œ
                            self.is_valid = False
                            return
                        return
                        
                    self.previous_message = log_entry
                    self.duplicate_count = 1
                    
                    # ìµœëŒ€ ë¡œê·¸ ê°œìˆ˜ ê´€ë¦¬
                    if self.log_count >= self.max_logs:
                        try:
                            self.text_widget.config(state=tk.NORMAL)
                            self.text_widget.delete("1.0", "11.0")
                            self.text_widget.config(state=tk.DISABLED)
                            self.log_count -= 10
                        except tk.TclError:
                            # Tkinter ì˜¤ë¥˜ ë°œìƒ ì‹œ ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒìœ¼ë¡œ í‘œì‹œ
                            self.is_valid = False
                            return
                    
                    # ë¡œê·¸ ì‚½ì… (ìƒ‰ìƒ íƒœê·¸ ì ìš©)
                    try:
                        tag = record.levelname  # ë¡œê·¸ ë ˆë²¨ëª…ì„ íƒœê·¸ë¡œ ì‚¬ìš©
                        self.text_widget.config(state=tk.NORMAL)
                        self.text_widget.insert("end", log_entry + "\n", tag)
                        self.text_widget.see("end")  # í•­ìƒ ë§ˆì§€ë§‰ ë¡œê·¸ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
                        self.text_widget.config(state=tk.DISABLED)
                        self.log_count += 1
                    except tk.TclError:
                        # Tk ì˜¤ë¥˜ ë°œìƒ ì‹œ ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒìœ¼ë¡œ í‘œì‹œ
                        self.is_valid = False
                        return
                    
                except Exception as e:
                    # ë¡œê·¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì¡©ìš©íˆ ë¬´ì‹œ (í‘œì¤€ ì—ëŸ¬ë¡œ ì¶œë ¥)
                    try:
                        # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìœ„ì ¯ì„ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ í‘œì‹œ
                        self.is_valid = False
                        sys.__stderr__.write(f"ë¡œê·¸ ì²˜ë¦¬ ì˜¤ë¥˜: {str(e)}\n")
                    except:
                        pass
            
            def close(self):
                """í•¸ë“¤ëŸ¬ë¥¼ ë‹«ê³  ì •ë¦¬í•©ë‹ˆë‹¤."""
                self.is_valid = False  # ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒìœ¼ë¡œ í‘œì‹œ
                super().close()
            
            def restore(self):
                """ì›ë˜ stdoutê³¼ stderrë¡œ ë³µì›í•©ë‹ˆë‹¤"""
                self.is_valid = False  # ìœ„ì ¯ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒìœ¼ë¡œ í‘œì‹œ
                sys.stdout = sys.__stdout__
                sys.stderr = sys.__stderr__
        
        # í•¸ë“¤ëŸ¬ ìƒì„± ë° ì„¤ì • (self ì°¸ì¡° ì „ë‹¬)
        self.gui_log_handler = GuiLogHandler(self, self.log_text)
        
        # ë””ë²„ê·¸ ë¡œê·¸ í¬ë§·í„°ë¥¼ ë” ìì„¸í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ë„ë¡ ë³€ê²½
        detailed_formatter = logging.Formatter(
            '[%(asctime)s] %(levelname)s: %(message)s',
            datefmt='%H:%M:%S'  # ì‹œê°„ í¬ë§· ê°„ì†Œí™”
        )
        self.gui_log_handler.setFormatter(detailed_formatter)
        self.logger.addHandler(self.gui_log_handler)
        
        # í‘œì¤€ ì¶œë ¥ê³¼ í‘œì¤€ ì—ëŸ¬ë¥¼ ê°€ë¡œì±„ì„œ GUIì—ë„ í‘œì‹œ
        self.stdout_redirector = StdoutRedirector(self.log_text, 'STDOUT')
        self.stderr_redirector = StdoutRedirector(self.log_text, 'STDERR')
        
        # ì›ë³¸ ìŠ¤íŠ¸ë¦¼ ì €ì¥
        self.stdout_redirector.original_stdout = sys.stdout
        self.stderr_redirector.original_stdout = sys.stderr
        
        # ìŠ¤íŠ¸ë¦¼ ë¦¬ë””ë ‰ì…˜
        sys.stdout = self.stdout_redirector
        sys.stderr = self.stderr_redirector
        
        # ë¡œê·¸ ì‹œì‘ ë©”ì‹œì§€
        self.logger.info("ë””ë²„ê·¸ ë¡œê·¸ì°½ ì´ˆê¸°í™” ì™„ë£Œ")
        print("í„°ë¯¸ë„ ì¶œë ¥ì´ ë””ë²„ê·¸ ë¡œê·¸ì°½ì—ë„ í‘œì‹œë©ë‹ˆë‹¤.")
        
        # ìë™ìœ¼ë¡œ ì‹œìŠ¤í…œ ì •ë³´ ë° ë””ë ‰í† ë¦¬ ì •ë³´ ë¡œê¹… (ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ)
        if self.debug_visible:
            self.log_system_info()
            self.log_directory_contents()
        
        # Make log text read-only
        self.log_text.configure(state='disabled')
    
    def log_system_info(self):
        """ì‹œìŠ¤í…œ ì •ë³´ë¥¼ ë¡œê·¸ì— ê¸°ë¡"""
        self.logger.info("======== ì‹œìŠ¤í…œ ì •ë³´ ========")
        self.logger.info(f"ì‘ì—… ë””ë ‰í† ë¦¬: {os.getcwd()}")
        self.logger.info(f"Python ë²„ì „: {sys.version.split()[0]}")
        self.logger.info(f"ìš´ì˜ì²´ì œ: {platform.system()} {platform.release()}")
        
        # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (psutil ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆëŠ” ê²½ìš°)
        try:
            import psutil
            memory = psutil.virtual_memory()
            total_gb = memory.total / (1024 ** 3)
            available_gb = memory.available / (1024 ** 3)
            self.logger.info(f"ë©”ëª¨ë¦¬: ì´ {total_gb:.1f}GB, ì‚¬ìš© ê°€ëŠ¥ {available_gb:.1f}GB ({memory.percent}% ì‚¬ìš© ì¤‘)")
        except ImportError:
            pass
            
        # í™”ë©´ ì •ë³´
        try:
            width = self.root.winfo_screenwidth()
            height = self.root.winfo_screenheight()
            self.logger.info(f"í™”ë©´ í•´ìƒë„: {width}x{height}")
        except:
            pass
            
        self.logger.info("==============================")
    
    def log_directory_contents(self):
        """í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ëª©ë¡ì„ ë¡œê·¸ì— ê¸°ë¡í•©ë‹ˆë‹¤."""
        try:
            # ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
            files = os.listdir()
            self.logger.info(f"í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ (ì´ {len(files)}ê°œ):")
            
            # ì—‘ì…€ ë° CSV íŒŒì¼ë§Œ ë¡œê¹…
            excel_files = [f for f in files if f.endswith(('.xlsx', '.csv'))]
            for file in excel_files:
                self.logger.info(f"  - {file}")
            
        except Exception as e:
            self.logger.error(f"ë””ë ‰í† ë¦¬ ë‚´ìš© ë¡œê¹… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            if self.debug_visible:
                traceback.print_exc()

    def update_file_labels(self, show_alert=False):
        """íŒŒì¼ ìƒíƒœ ë ˆì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
        try:
            # í´ë” ìƒì„± í™•ì¸
            self.setup_folders()
            
            # íŒŒì¼ ì°¾ê¸° (print ë‚´ì¥)
            main_file = self.find_main_file()
            patients_file = self.find_file('patients')
            payment_items = self.find_file('paymentitems')
            
            # ì¤‘ìš” ì •ë³´ë§Œ ê°„ëµíˆ ë¡œê¹… (INFO ë ˆë²¨)
            file_summary = []
            if main_file:
                file_summary.append(f"ë©”ì¸: {main_file}")
            if patients_file:
                file_summary.append(f"Patients: {patients_file}")
            if payment_items:
                file_summary.append(f"PaymentItems: {payment_items}")
            
            if file_summary:
                print(f"íŒŒì¼ ê°ì§€ ê²°ê³¼: {', '.join(file_summary)}")
                
            # ë ˆì´ë¸” ì—…ë°ì´íŠ¸
            self.main_file_label.config(text=f"ë©”ì¸ íŒŒì¼: {main_file if main_file else 'ì—†ìŒ'}")
            self.patients_label.config(text=f"Patients íŒŒì¼: {patients_file if patients_file else 'ì—†ìŒ'}")
            self.payment_label.config(text=f"PaymentItems íŒŒì¼: {payment_items if payment_items else 'ì—†ìŒ'}")
            
            # ìƒíƒœ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
            if not main_file:
                self.status_label.config(text="âš ï¸ ë©”ì¸ íŒŒì¼ ì—†ìŒ", fg="red")
            elif not patients_file and not payment_items:
                self.status_label.config(text="âš ï¸ ì…ë ¥ íŒŒì¼ ì—†ìŒ", fg="orange")
            else:
                self.status_label.config(text="ì¤€ë¹„ ì™„ë£Œ", fg="black")
            
            # ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì„¤ì •
            if main_file:
                # ë©”ì¸ íŒŒì¼ë§Œ ìˆëŠ” ê²½ìš° í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”
                self.update_patient_btn.config(state=tk.NORMAL, text="ğŸ‘¤ í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸")
                
                # ë©”ì¸ íŒŒì¼ê³¼ Patients ë˜ëŠ” PaymentItems íŒŒì¼ì´ ìˆëŠ” ê²½ìš° í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”
                if patients_file or payment_items:
                    self.update_tables_btn.config(state=tk.NORMAL, text="ğŸ“Š í‘œ ì—…ë°ì´íŠ¸")
                else:
                    self.update_tables_btn.config(state=tk.DISABLED, text="ğŸ“Š í‘œ ì—…ë°ì´íŠ¸")
                    self.logger.info("Patients/PaymentItems íŒŒì¼ ì—†ìŒ - í‘œ ì—…ë°ì´íŠ¸ ë¶ˆê°€")
            else:
                # ë©”ì¸ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ëª¨ë“  ê¸°ëŠ¥ ë²„íŠ¼ ë¹„í™œì„±í™”
                self.update_tables_btn.config(state=tk.DISABLED, text="ğŸ“Š í‘œ ì—…ë°ì´íŠ¸")
                self.update_patient_btn.config(state=tk.DISABLED, text="ğŸ‘¤ í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸")
                self.logger.info("ë©”ì¸ íŒŒì¼ ì—†ìŒ - ëª¨ë“  ê¸°ëŠ¥ ë¹„í™œì„±í™”")

            if show_alert:
                # ê°„ê²°í•œ ë©”ì‹œì§€ë¡œ ë³€ê²½
                alert_message = "íŒŒì¼ ìƒíƒœ:\n"
                if main_file:
                    alert_message += f"âœ… ë©”ì¸: {main_file}\n"
                else:
                    alert_message += "âŒ ë©”ì¸ íŒŒì¼ ì—†ìŒ\n"
                    
                if patients_file:
                    alert_message += f"âœ… Patients: {patients_file}\n"
                else:
                    alert_message += "âŒ Patients íŒŒì¼ ì—†ìŒ\n"
                    
                if payment_items:
                    alert_message += f"âœ… PaymentItems: {payment_items}"
                else:
                    alert_message += "âŒ PaymentItems íŒŒì¼ ì—†ìŒ"
                    
                messagebox.showinfo("íŒŒì¼ ê°ì§€ ê²°ê³¼", alert_message)
        
        except Exception as e:
            self.logger.error(f"íŒŒì¼ ê°ì§€ ì¤‘ ì˜¤ë¥˜: {str(e)}")
            # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìƒì„¸ ë¡œê·¸ ì¶”ê°€ (ì‹¤ì œ ë””ë²„ê¹…ì— í•„ìš”í•œ ì •ë³´)
            self.logger.error(traceback.format_exc())
    
    def normalize_date_format(self, date_value):
        """ë‚ ì§œë¥¼ í‘œì¤€í™”í•©ë‹ˆë‹¤."""
        return standardize_date(date_value)

    def normalize_text(self, text):
        """í…ìŠ¤íŠ¸ë¥¼ í‘œì¤€í™”í•©ë‹ˆë‹¤."""
        return standardize_value(text)

    def process_patients_file(self, main_file, patients_file):
        try:
            print(f"Patients íŒŒì¼ ì²˜ë¦¬ ì‹œì‘: {patients_file}")
            
            # ë©”ì¸ íŒŒì¼ê³¼ Patients íŒŒì¼ ì½ê¸°
            wb = load_workbook(main_file)
            patients_df = self.read_csv_with_encoding(patients_file)
            
            if patients_df is None or patients_df.empty:
                print("Patients íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
            
            # Patients ì‹œíŠ¸ì˜ í…Œì´ë¸” ì°¾ê¸°
            patients_sheet = wb['Patients']
            table = self.find_table("í™˜ììë™", wb)
            if not table:
                print("Patients ì‹œíŠ¸ì˜ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
            
            # í…Œì´ë¸” ë²”ìœ„ íŒŒì‹±
            try:
                min_col, min_row, max_col, max_row = range_boundaries(table.ref)
                print(f"í…Œì´ë¸” ë²”ìœ„: min_col={min_col}, min_row={min_row}, max_col={max_col}, max_row={max_row}")
                
                # None ì²´í¬
                if None in (min_col, min_row, max_col, max_row):
                    print("í…Œì´ë¸” ë²”ìœ„ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                    return False
            except Exception as e:
                print(f"í…Œì´ë¸” ë²”ìœ„ íŒŒì‹± ì˜¤ë¥˜: {str(e)}")
                # ê°•ì œë¡œ ì‹œíŠ¸ ì „ì²´ ë²”ìœ„ ì‚¬ìš©
                print("ì‹œíŠ¸ ì „ì²´ ë²”ìœ„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
                min_col, min_row = 1, 1
                max_col = patients_sheet.max_column
                max_row = patients_sheet.max_row
            
            # í—¤ë” ë§¤í•‘ ìƒì„±
            excel_headers = {}
            csv_headers = list(patients_df.columns)
            
            # ì—´ ì´ë¦„ê³¼ ì—´ ì¸ë±ìŠ¤ ë§¤í•‘
            col_to_letter = {}
            
            for col in range(min_col, max_col + 1):
                cell_value = patients_sheet.cell(row=min_row, column=col).value
                if cell_value:
                    header_name = str(cell_value).strip()
                    excel_headers[header_name] = col
                    col_to_letter[header_name] = get_column_letter(col)
                    
            # ì¤‘ë³µ ë°ì´í„° ì²´í¬ë¥¼ ìœ„í•œ ì»¬ëŸ¼ ì°¾ê¸°
            name_col = excel_headers.get("ì´ë¦„")
            email_col = excel_headers.get("ì´ë©”ì¼")
            dob_col = excel_headers.get("ìƒë…„ì›”ì¼")
            
            # ìƒë…„ì›”ì¼ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ìƒë…„ ì»¬ëŸ¼ì„ ì°¾ìŠµë‹ˆë‹¤
            if dob_col is None:
                dob_col = excel_headers.get("ìƒë…„")
                self.logger.info("ìƒë…„ì›”ì¼ ì»¬ëŸ¼ì´ ì—†ì–´ ìƒë…„ ì»¬ëŸ¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
            
            # ì—´ ë§¤í•‘ íŠ¹ë³„ ì²˜ë¦¬: ë‚˜ì´ë¥¼ Ageë¡œ ì·¨ê¸‰
            age_col = excel_headers.get("Age") or excel_headers.get("ë‚˜ì´")
            age_range_col = excel_headers.get("Age_Range")
            reg_date_col = excel_headers.get("ë“±ë¡ ë‚ ì§œ")
            birth_date_col = dob_col  # ìƒë…„ì›”ì¼ ë˜ëŠ” ìƒë…„ ì»¬ëŸ¼
            
            # í˜„ì¬ ìˆëŠ” ì£¼ ì»¬ëŸ¼ ì°¾ê¸° - ë””ë²„ê¹… ê°œì„ 
            state_col = excel_headers.get("í˜„ì¬ ìˆëŠ” ì£¼")
            
            # ì»¬ëŸ¼ ì°¾ê¸° ìƒì„¸ ë¡œê¹…
            self.logger.info(f"ì—‘ì…€ í—¤ë” ì „ì²´ ëª©ë¡: {excel_headers}")
            self.logger.info(f"ì´ë¦„ ì—´: {name_col}")
            self.logger.info(f"ë“±ë¡ ë‚ ì§œ ì—´: {reg_date_col}")
            self.logger.info(f"í˜„ì¬ ìˆëŠ” ì£¼ ì—´: {state_col}")
            
            # ì¤‘ë³µ ì²´í¬ ì»¬ëŸ¼ í™•ì¸
            if reg_date_col is None:
                self.logger.warning("'ë“±ë¡ ë‚ ì§œ' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¤‘ë³µ ì²´í¬ì—ì„œ ì´ í•­ëª©ì€ ë¬´ì‹œë©ë‹ˆë‹¤.")
            
            if state_col is None:
                self.logger.warning("'í˜„ì¬ ìˆëŠ” ì£¼' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¤‘ë³µ ì²´í¬ì—ì„œ ì´ í•­ëª©ì€ ë¬´ì‹œë©ë‹ˆë‹¤.")
            
            # ì¤‘ìš” ì»¬ëŸ¼ ë¡œê¹…
            self.logger.debug(f"ì´ë¦„ ì—´: {name_col} ({col_to_letter.get('ì´ë¦„', '?')})")
            self.logger.debug(f"Age/ë‚˜ì´ ì—´: {age_col} ({col_to_letter.get('ë‚˜ì´', '?')})")
            self.logger.debug(f"Age_Range ì—´: {age_range_col} ({col_to_letter.get('Age_Range', '?')})")
            self.logger.debug(f"ë“±ë¡ ë‚ ì§œ ì—´: {reg_date_col} ({col_to_letter.get('ë“±ë¡ ë‚ ì§œ', '?')})")
            self.logger.debug(f"í˜„ì¬ ìˆëŠ” ì£¼ ì—´: {state_col} ({col_to_letter.get('í˜„ì¬ ìˆëŠ” ì£¼', '?')})")
            
            # ìƒë…„ì›”ì¼ ë˜ëŠ” ìƒë…„ ì»¬ëŸ¼ ë¡œê¹…
            if "ìƒë…„ì›”ì¼" in excel_headers:
                self.logger.debug(f"ìƒë…„ì›”ì¼ ì—´: {birth_date_col} ({col_to_letter.get('ìƒë…„ì›”ì¼', '?')})")
            else:
                self.logger.debug(f"ìƒë…„ ì—´: {birth_date_col} ({col_to_letter.get('ìƒë…„', '?')})")
                
            # ë„ì‹œ ì»¬ëŸ¼ ë¡œê¹… (í•„ìˆ˜ ì•„ë‹˜)
            city_col = excel_headers.get("ë„ì‹œ")
            if city_col:
                self.logger.debug(f"ë„ì‹œ ì—´: {city_col} ({col_to_letter.get('ë„ì‹œ', '?')})")
                
            # ì´ë©”ì¼ ì»¬ëŸ¼ ë¡œê¹… (í•„ìˆ˜ ì•„ë‹˜)
            if email_col:
                self.logger.debug(f"ì´ë©”ì¼ ì—´: {email_col} ({col_to_letter.get('ì´ë©”ì¼', '?')})")
            
            # ì´ë©”ì¼ê³¼ ë„ì‹œëŠ” í•„ìˆ˜ê°€ ì•„ë‹˜, ì´ë¦„ê³¼ ìƒë…„(ì›”ì¼)ë§Œ í•„ìˆ˜ë¡œ ì²´í¬
            if not all([name_col, birth_date_col]):
                if "ìƒë…„ì›”ì¼" in excel_headers:
                    self.logger.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„: {name_col}, ìƒë…„ì›”ì¼: {birth_date_col}")
                else:
                    self.logger.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„: {name_col}, ìƒë…„: {birth_date_col}")
                return False
            
            # ì°¸ì¡°í•  ê³µì‹ ë° ìŠ¤íƒ€ì¼ì´ ìˆëŠ” í–‰ ì°¾ê¸°
            formula_row = None
            for row in range(min_row + 1, max_row + 1):
                # Age_Range ë˜ëŠ” Age ì—´ì— ê³µì‹ì´ ìˆëŠ”ì§€ í™•ì¸
                try:
                    if age_range_col and patients_sheet.cell(row=row, column=age_range_col).value and str(patients_sheet.cell(row=row, column=age_range_col).value).startswith('='):
                        formula_row = row
                        self.logger.debug(f"Age_Range ê³µì‹ì´ ìˆëŠ” í–‰ ë°œê²¬: {row}")
                        break
                    elif age_col and patients_sheet.cell(row=row, column=age_col).value and str(patients_sheet.cell(row=row, column=age_col).value).startswith('='):
                        formula_row = row
                        self.logger.debug(f"Age ê³µì‹ì´ ìˆëŠ” í–‰ ë°œê²¬: {row}")
                        break
                except:
                    continue
            
            # ê¸°ì¡´ ê³µì‹ ì¶”ì¶œ ë¶€ë¶„ ì œê±°
            birth_col_letter = col_to_letter.get("ìƒë…„", col_to_letter.get("ìƒë…„ì›”ì¼", "E"))  # ìƒë…„ ë˜ëŠ” ìƒë…„ì›”ì¼ ì»¬ëŸ¼ ë¬¸ì ê°€ì ¸ì˜¤ê¸°
            
            # ìƒë…„ì›”ì¼ë¡œë¶€í„° ë‚˜ì´ ê³„ì‚° ê³µì‹ - ìƒë…„ì´ ìˆëŠ” ê²½ìš° ì§ì ‘ ê³„ì‚°
            if "ìƒë…„" in excel_headers:
                age_formula_template = f'=YEAR(TODAY())-{birth_col_letter}{{row}}'
            else:
                age_formula_template = f'=DATEDIF(DATE(RIGHT({birth_col_letter}{{row}},4),MONTH(1&LEFT({birth_col_letter}{{row}},FIND("ì›”",{birth_col_letter}{{row}})-1)),MID({birth_col_letter}{{row}},FIND("ì›”",{birth_col_letter}{{row}})+2,FIND(",",{birth_col_letter}{{row}})-FIND("ì›”",{birth_col_letter}{{row}})-2)),TODAY(),"Y")'
            
            age_range_formula_template = f'=LOOKUP({col_to_letter.get("ë‚˜ì´", "D")}{{row}},{{0,20,30,40,50,60,70}},{{"10s","20s","30s","40s","50s","60s","70s+"}})'
            
            # ìƒˆ ë°ì´í„° ì¶”ê°€ ìœ„ì¹˜ ì°¾ê¸° (ë³‘í•© ì…€ ê³ ë ¤)
            next_row = max_row + 1  # ì¼ë‹¨ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            try:
                next_row = self.find_safe_row(patients_sheet, max_row + 1, min_col, max_col)
            except Exception as e:
                self.logger.error(f"ì•ˆì „í•œ í–‰ ì°¾ê¸° ì˜¤ë¥˜: {str(e)}")
                # ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
            
            # ë°ì´í„° ì¶”ê°€
            added_count = 0
            skipped_count = 0
            
            # ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ ê¸°ì¡´ ë°ì´í„° ìˆ˜ì§‘
            existing_records = {}  # í‚¤: (ì´ë¦„, ë‚ ì§œ, ì£¼) ë˜ëŠ” (ì´ë¦„, ë‚ ì§œ)
            existing_names = {}    # í‚¤: ì´ë¦„, ê°’: í–‰ ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸
            self.logger.info("\n=== ê¸°ì¡´ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ ===")
            
            # ì—‘ì…€ íŒŒì¼ì˜ ê¸°ì¡´ ë°ì´í„° ìˆ˜ì§‘
            for excel_row in range(min_row + 1, max_row + 1):
                try:
                    # ì´ë¦„ ì •ê·œí™”
                    name = patients_sheet.cell(row=excel_row, column=name_col).value
                    if not name:
                        continue
                    name = self.normalize_text(name)
                    
                    # ë“±ë¡ ë‚ ì§œ ì •ê·œí™”
                    reg_date = None
                    if reg_date_col is not None:
                        reg_date_cell = patients_sheet.cell(row=excel_row, column=reg_date_col)
                        if reg_date_cell and reg_date_cell.value:
                            reg_date = self.normalize_date_format(reg_date_cell.value)
                    
                    # í˜„ì¬ ìˆëŠ” ì£¼ ì •ê·œí™”
                    state = None
                    if state_col is not None:
                        state_cell = patients_sheet.cell(row=excel_row, column=state_col)
                        if state_cell and state_cell.value:
                            state = self.normalize_text(state_cell.value)
                    
                    # ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ í‚¤ ìƒì„±
                    # í˜„ì¬ ìˆëŠ” ì£¼ê°€ ê³µë€ì´ë©´ ì´ë¦„ê³¼ ë“±ë¡ ë‚ ì§œë§Œìœ¼ë¡œ í‚¤ ìƒì„±
                    if not state:
                        key = (name, reg_date if reg_date is not None else "")
                        self.logger.info(f"ì£¼ ì •ë³´ ì—†ìŒ - ì´ë¦„ê³¼ ë“±ë¡ ë‚ ì§œë§Œìœ¼ë¡œ ì¤‘ë³µ ì²´í¬ í‚¤ ìƒì„±: {key}")
                    else:
                        key = (name, reg_date if reg_date is not None else "", state)
                        
                    existing_records[key] = excel_row
                    
                    # ì´ë¦„ë§Œìœ¼ë¡œ êµ¬ì„±ëœ í‚¤ë„ ë³„ë„ë¡œ ì €ì¥ (ì™„ì „íˆ ë‹¤ë¥¸ ë”•ì…”ë„ˆë¦¬ì— ì €ì¥)
                    if name not in existing_names:
                        existing_names[name] = []
                    existing_names[name].append(excel_row)
                    
                    self.logger.info(f"ê¸°ì¡´ ë ˆì½”ë“œ ìˆ˜ì§‘ (í–‰ {excel_row}):\n  ì´ë¦„: {name}\n  ë“±ë¡ë‚ ì§œ: {reg_date}\n  í˜„ì¬ìˆëŠ”ì£¼: {state}")
                    
                except Exception as e:
                    self.logger.warning(f"ê¸°ì¡´ ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ (í–‰ {excel_row}): {str(e)}")
                    continue

            self.logger.info(f"\n=== ìˆ˜ì§‘ëœ ê¸°ì¡´ ë ˆì½”ë“œ ìˆ˜: {len(existing_records)} ===")
            self.logger.info("=== ìˆ˜ì§‘ëœ ê¸°ì¡´ ë ˆì½”ë“œ ëª©ë¡ ===")
            for key, row in existing_records.items():
                self.logger.info(f"í–‰ {row}: {key}")

            # CSV ë°ì´í„° ì²˜ë¦¬
            self.logger.info("\n=== CSV ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ ===")
            for idx, row in patients_df.iterrows():
                try:
                    # ì´ë¦„ ì •ê·œí™”
                    name = row.get("ì´ë¦„", "")
                    if not name:
                        skipped_count += 1
                        self.logger.warning("ì´ë¦„ì´ ì—†ëŠ” ë ˆì½”ë“œ ê±´ë„ˆë›°ê¸°")
                        continue
                    name = self.normalize_text(name)
                    
                    # ë“±ë¡ ë‚ ì§œ ì •ê·œí™”
                    reg_date = self.normalize_date_format(row.get("ë“±ë¡ ë‚ ì§œ"))
                    
                    # í˜„ì¬ ìˆëŠ” ì£¼ ì •ê·œí™”
                    state = self.normalize_text(row.get("í˜„ì¬ ìˆëŠ” ì£¼", ""))
                    
                    # ì¤‘ë³µ ì²´í¬
                    # í˜„ì¬ ìˆëŠ” ì£¼ê°€ ê³µë€ì´ë©´ ì´ë¦„ê³¼ ë“±ë¡ ë‚ ì§œë§Œìœ¼ë¡œ í‚¤ ìƒì„±
                    if not state:
                        key = (name, reg_date if reg_date is not None else "")
                        self.logger.info(f"ì£¼ ì •ë³´ ì—†ìŒ - ì´ë¦„ê³¼ ë“±ë¡ ë‚ ì§œë§Œìœ¼ë¡œ ì¤‘ë³µ ì²´í¬: {key}")
                    else:
                        key = (name, reg_date if reg_date is not None else "", state)
                        
                    self.logger.info(f"\nê²€ì‚¬í•  ë ˆì½”ë“œ (í–‰ {idx + 2}):\n  ì´ë¦„: {name}\n  ë“±ë¡ë‚ ì§œ: {reg_date}\n  í˜„ì¬ìˆëŠ”ì£¼: {state}")
                    self.logger.info(f"ì¤‘ë³µ ì²´í¬ í‚¤: {key}")
                    
                    # ì¤‘ë³µ í‚¤ ê²€ì‚¬ - 3ë‹¨ê³„ë¡œ í™•ì¸
                    is_duplicate = False
                    existing_row = None
                    duplicate_type = ""
                    
                    # 1ë‹¨ê³„: ì •í™•í•œ í‚¤ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸ (ì´ë¦„+ë“±ë¡ë‚ ì§œ+í˜„ì¬ìˆëŠ”ì£¼ ë˜ëŠ” ì´ë¦„+ë“±ë¡ë‚ ì§œ)
                    if key in existing_records:
                        is_duplicate = True
                        existing_row = existing_records[key]
                        duplicate_type = "ì™„ì „ ì¼ì¹˜"
                    
                    # 2ë‹¨ê³„: ì´ë¦„ê³¼ ë‚ ì§œë§Œìœ¼ë¡œ ì¤‘ë³µ í™•ì¸ (ëª¨ë“  ì£¼ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì˜ ì¶”ê°€ ê²€ì‚¬)
                    elif len(key) == 3 and not is_duplicate:
                        short_key = (name, reg_date if reg_date is not None else "")
                        for exist_key, exist_row in existing_records.items():
                            # ì´ë¦„ê³¼ ë“±ë¡ë‚ ì§œê°€ ë™ì¼í•˜ê³ , ì£¼ ì •ë³´ëŠ” í•˜ë‚˜ë¼ë„ ìˆëŠ” ê²½ìš° (ì£¼ ì •ë³´ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
                            if isinstance(exist_key, tuple) and len(exist_key) > 1:
                                exist_name = exist_key[0] if exist_key[0] else ""
                                exist_date = exist_key[1] if len(exist_key) > 1 and exist_key[1] else ""
                                
                                if exist_name == name and exist_date == reg_date:
                                    is_duplicate = True
                                    existing_row = exist_row
                                    duplicate_type = "ì´ë¦„, ë‚ ì§œ ì¼ì¹˜ (ì£¼ ë‹¤ë¦„)"
                                    break
                    
                    # 3ë‹¨ê³„: ì´ë¦„ì´ ê°™ê³  ë“±ë¡ ë‚ ì§œê°€ ê°™ì€ ë ˆì½”ë“œê°€ ìˆëŠ”ì§€ í™•ì¸ (ì¶”ê°€ ê²€ì‚¬)
                    if not is_duplicate and name in existing_names:
                        for row_num in existing_names[name]:
                            # ë“±ë¡ ë‚ ì§œ ë¹„êµ
                            excel_date = None
                            if reg_date_col is not None:
                                date_cell = patients_sheet.cell(row=row_num, column=reg_date_col)
                                if date_cell and date_cell.value:
                                    excel_date = self.normalize_date_format(date_cell.value)
                            
                            # ë‘ ë‚ ì§œê°€ ë¹„ìŠ·í•œì§€ í™•ì¸ (ë‘˜ ë‹¤ ìˆê³  ê°™ì€ ê²½ìš°)
                            if reg_date and excel_date and reg_date == excel_date:
                                is_duplicate = True
                                existing_row = row_num
                                duplicate_type = "ì´ë¦„, ë‚ ì§œ ì¼ì¹˜ (3ë‹¨ê³„ í™•ì¸)"
                                break
                    
                    if is_duplicate:
                        # ì¤‘ë³µ ë ˆì½”ë“œì˜ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        excel_name = patients_sheet.cell(row=existing_row, column=name_col).value if name_col else "N/A"
                        excel_date = patients_sheet.cell(row=existing_row, column=reg_date_col).value if reg_date_col is not None else "N/A"
                        excel_state = patients_sheet.cell(row=existing_row, column=state_col).value if state_col is not None else "N/A"
                        
                        self.logger.info(
                            f">>> ì¤‘ë³µ ë°œê²¬ <<< ({duplicate_type})\n"
                            f"CSV ë°ì´í„° (í–‰ {idx + 2}):\n"
                            f"  - ì´ë¦„: {name}\n"
                            f"  - ë“±ë¡ë‚ ì§œ: {reg_date}\n"
                            f"  - í˜„ì¬ìˆëŠ”ì£¼: {state}\n"
                            f"ì—‘ì…€ ë°ì´í„° (í–‰ {existing_row}):\n"
                            f"  - ì´ë¦„: {excel_name}\n"
                            f"  - ë“±ë¡ë‚ ì§œ: {excel_date}\n"
                            f"  - í˜„ì¬ìˆëŠ”ì£¼: {excel_state}"
                        )
                        skipped_count += 1
                        continue
                    else:
                        self.logger.info(">>> ìƒˆë¡œìš´ ë ˆì½”ë“œ - ì¶”ê°€ ì§„í–‰ <<<")
                    
                    # ì¤‘ë³µì´ ì•„ë‹Œ ê²½ìš° existing_recordsì— ì¶”ê°€
                    existing_records[key] = next_row
                    # ì´ë¦„ë³„ ì¸ë±ìŠ¤ì—ë„ ì¶”ê°€
                    if name not in existing_names:
                        existing_names[name] = []
                    existing_names[name].append(next_row)
                    
                except Exception as e:
                    self.logger.warning(f"ì¤‘ë³µ ì²´í¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                    skipped_count += 1
                    continue

                # ê° ì—‘ì…€ ì»¬ëŸ¼ì— ë°ì´í„° ì¶”ê°€
                for excel_header, col_index in excel_headers.items():
                    try:
                        cell = patients_sheet.cell(row=next_row, column=col_index)
                        
                        # CSV í—¤ë”ì— í•´ë‹¹í•˜ëŠ” ê°’ì´ ìˆëŠ” ê²½ìš° ì¶”ê°€
                        csv_value = None
                        if excel_header in csv_headers:
                            csv_value = row.get(excel_header)
                        
                        # ë°ì´í„° ì¶”ê°€
                        if excel_header == "Age" or excel_header == "ë‚˜ì´":
                            # ìƒë…„ì›”ì¼ ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë„ ê³µì‹ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •
                            cell.value = None  # ê³µì‹ ëŒ€ì‹  ê³µë€ìœ¼ë¡œ ì„¤ì •
                        elif excel_header == "Age_Range":
                            # ìƒë…„ì›”ì¼ ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë„ ê³µì‹ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •
                            cell.value = None  # ê³µì‹ ëŒ€ì‹  ê³µë€ìœ¼ë¡œ ì„¤ì •
                        elif excel_header == "ë“±ë¡ ë‚ ì§œ" and csv_value is not None:
                            # ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€ê²½
                            try:
                                # "3ì›” 29, 20"ê³¼ ê°™ì€ í˜•ì‹ ì²˜ë¦¬
                                if isinstance(csv_value, str) and 'ì›”' in csv_value and ',' in csv_value:
                                    month_str = csv_value.split('ì›”')[0].strip()
                                    day_str = csv_value.split('ì›”')[1].split(',')[0].strip()
                                    year_str = csv_value.split(',')[1].strip()
                                    
                                    # ë‘ ìë¦¬ ë…„ë„ë¥¼ ë„¤ ìë¦¬ë¡œ ë³€í™˜ (20 -> 2020)
                                    if len(year_str) == 2:
                                        year_str = '20' + year_str
                                    
                                    # ë‚ ì§œ ê°ì²´ ìƒì„±
                                    month = int(month_str)
                                    day = int(day_str)
                                    year = int(year_str)
                                    dt = datetime(year, month, day)
                                    cell.value = f"{dt.year}ë…„ {dt.month}ì›” {dt.day}ì¼"
                                else:
                                    dt = pd.to_datetime(csv_value, errors='coerce')
                                    if pd.notnull(dt):
                                        cell.value = dt.strftime("%Yë…„ %mì›” %dì¼")
                                    else:
                                        cell.value = csv_value
                            except Exception as e:
                                self.logger.warning(f"ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€í™˜ ì‹¤íŒ¨: {csv_value} -> {str(e)}")
                                cell.value = csv_value
                        elif excel_header == "ìƒë…„" and "ìƒë…„ì›”ì¼" in row:
                            # CSVì—ì„œëŠ” "ìƒë…„ì›”ì¼" ì»¬ëŸ¼ì´ê³  ì—‘ì…€ì—ì„œëŠ” "ìƒë…„" ì»¬ëŸ¼ì¸ ê²½ìš°
                            birth_date_value = row.get("ìƒë…„ì›”ì¼")
                            if birth_date_value:
                                try:
                                    if isinstance(birth_date_value, datetime):
                                        cell.value = birth_date_value.year
                                    elif isinstance(birth_date_value, str):
                                        # ë‹¤ì–‘í•œ í˜•ì‹ ì²˜ë¦¬
                                        date_patterns = [
                                            r'(\d{4})[/\-\.](0?[1-9]|1[0-2])[/\-\.](0?[1-9]|[12][0-9]|3[01])',  # YYYY/MM/DD
                                            r'(0?[1-9]|1[0-2])[/\-\.](0?[1-9]|[12][0-9]|3[01])[/\-\.](\d{4})',  # MM/DD/YYYY
                                            r'(0?[1-9]|[12][0-9]|3[01])[/\-\.](0?[1-9]|1[0-2])[/\-\.](\d{4})',  # DD/MM/YYYY
                                            r'(\d{4})ë…„\s*(0?[1-9]|1[0-2])ì›”\s*(0?[1-9]|[12][0-9]|3[01])ì¼',     # YYYYë…„ MMì›” DDì¼
                                            r'(\d{4})',  # ì—°ë„ë§Œ (YYYY)
                                            r'(?:0?[1-9]|1[0-2])ì›”\s*(?:0?[1-9]|[12][0-9]|3[01]),\s*(\d{4})'  # MMì›” DD, YYYY
                                        ]
                                        
                                        for pattern in date_patterns:
                                            match = re.search(pattern, birth_date_value)
                                            if match:
                                                if 'ë…„' in pattern:  # í•œêµ­ì‹
                                                    cell.value = int(match.group(1))
                                                elif pattern == r'(\d{4})':  # ì—°ë„ë§Œ
                                                    cell.value = int(match.group(1))
                                                elif pattern.endswith(r'(\d{4})'):  # MMì›” DD, YYYY
                                                    cell.value = int(match.group(1))
                                                elif '/' in pattern or '-' in pattern or '.' in pattern:
                                                    # íŒ¨í„´ì— ë”°ë¼ ì—°ë„ ìœ„ì¹˜ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
                                                    if pattern.startswith(r'(\d{4})'):  # YYYY/MM/DD
                                                        cell.value = int(match.group(1))
                                                    else:  # MM/DD/YYYY ë˜ëŠ” DD/MM/YYYY
                                                        cell.value = int(match.group(3))
                                                break
                                        
                                        if cell.value is None:
                                            # íŒ¨í„´ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ datetime ë³€í™˜ ì‹œë„
                                            dt = pd.to_datetime(birth_date_value, errors='coerce')
                                            if pd.notnull(dt):
                                                cell.value = dt.year
                                            else:
                                                cell.value = birth_date_value  # ì›ë˜ ê°’ ê·¸ëŒ€ë¡œ ìœ ì§€
                                except Exception as e:
                                    self.logger.warning(f"ìƒë…„ì›”ì¼ì—ì„œ ì—°ë„ ì¶”ì¶œ ì‹¤íŒ¨: {birth_date_value} -> {str(e)}")
                                    cell.value = birth_date_value
                        elif excel_header == "ì´ë¦„" and csv_value is not None:
                            # ì´ë¦„ì€ ì´ˆì„±ë§Œ ì €ì¥ (ìˆ˜ì •: ì´ì œ ì›ë˜ ì´ë¦„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
                            cell.value = csv_value
                            self.logger.debug(f"ì´ë¦„ ê·¸ëŒ€ë¡œ ì‚¬ìš©: {csv_value}")
                        elif csv_value is not None:
                            cell.value = csv_value
                        
                        # ì…€ ìŠ¤íƒ€ì¼ ë³µì‚¬ (ì²« ë²ˆì§¸ ë°ì´í„° í–‰ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
                        if next_row > min_row + 1:
                            try:
                                source_cell = patients_sheet.cell(row=min_row + 1, column=col_index)
                                self.copy_cell_style(source_cell, cell)
                            except Exception as e:
                                self.logger.warning(f"ì…€ ìŠ¤íƒ€ì¼ ë³µì‚¬ ì˜¤ë¥˜: {str(e)}")
                    except Exception as e:
                        self.logger.warning(f"ì…€ {excel_header} ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                        traceback.print_exc()
                
                # ë“±ë¡ ë‚ ì§œê°€ ì œëŒ€ë¡œ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•˜ê³ , Ageì™€ Age_Rangeê°€ ê³µì‹ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
                self.logger.debug(f"ë“±ë¡ ë‚ ì§œ ê°’: {patients_sheet.cell(row=next_row, column=reg_date_col).value}")
                
                # ìƒë…„ì›”ì¼ ë˜ëŠ” ìƒë…„ ê°’ ë¡œê¹…
                if "ìƒë…„ì›”ì¼" in excel_headers:
                    self.logger.debug(f"ìƒë…„ì›”ì¼ ê°’: {patients_sheet.cell(row=next_row, column=birth_date_col).value}")
                else:
                    self.logger.debug(f"ìƒë…„ ê°’: {patients_sheet.cell(row=next_row, column=birth_date_col).value}")
                
                if age_col:
                    self.logger.debug(f"Age ê°’: {patients_sheet.cell(row=next_row, column=age_col).value}")
                if age_range_col:
                    self.logger.debug(f"Age_Range ê°’: {patients_sheet.cell(row=next_row, column=age_range_col).value}")
                
                next_row += 1
                added_count += 1
            
            # í…Œì´ë¸” ë²”ìœ„ í™•ì¥
            if added_count > 0:
                try:
                    table.ref = f"{get_column_letter(min_col)}{min_row}:{get_column_letter(max_col)}{next_row-1}"
                except Exception as e:
                    self.logger.error(f"í…Œì´ë¸” ë²”ìœ„ í™•ì¥ ì˜¤ë¥˜: {str(e)}")
            
            # íŒŒì¼ ì €ì¥
            wb.save(main_file)
            
            # ê²°ê³¼ ì²˜ë¦¬
            if skipped_count == len(patients_df):
                self.logger.warning(f"ëª¨ë“  ë‚´ìš©ì´ ì¤‘ë³µëœ íŒŒì¼: {patients_file}")
                
                # ì¤‘ë³µëœ ë ˆì½”ë“œë“¤ì˜ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
                duplicate_details = []
                for _, row in patients_df.iterrows():
                    name = row.get('ì´ë¦„', '')
                    reg_date = self.normalize_date_format(row.get('ë“±ë¡ ë‚ ì§œ', ''))
                    state = row.get('í˜„ì¬ ìˆëŠ” ì£¼', '')
                    duplicate_details.append(f"â–¶ ì¤‘ë³µ ë ˆì½”ë“œ\n  - ì´ë¦„: {name}\n  - ë“±ë¡ ë‚ ì§œ: {reg_date}\n  - í˜„ì¬ ìˆëŠ” ì£¼: {state}\n")
                
                details = (
                    f"íŒŒì¼ëª…: {patients_file}\n"
                    f"ì´ ë ˆì½”ë“œ ìˆ˜: {len(patients_df)}ê°œ\n"
                    f"ì¤‘ë³µ ë ˆì½”ë“œ ìˆ˜: {skipped_count}ê°œ\n\n"
                    f"=== ì¤‘ë³µëœ ë ˆì½”ë“œ ëª©ë¡ ===\n\n"
                    + "\n".join(duplicate_details)
                )
                
                self.show_detailed_result(
                    "ì¤‘ë³µ íŒŒì¼",
                    "ëª¨ë“  ë‚´ìš©ì´ ì¤‘ë³µëœ íŒŒì¼ì…ë‹ˆë‹¤.\nì´ íŒŒì¼ì€ SKIPPED í´ë”ë¡œ ì´ë™ë©ë‹ˆë‹¤.",
                    details
                )
                target_folder = "SKIPPED"
            else:
                self.logger.info(f"Patients íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ: ì¶”ê°€ {added_count}ê±´, ì¤‘ë³µ {skipped_count}ê±´")
                
                # ì¤‘ë³µëœ ë ˆì½”ë“œë“¤ì˜ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
                duplicate_details = []
                skipped_records = []  # ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ ì •ë³´ ì €ì¥
                for _, row in patients_df.iterrows():
                    name = row.get('ì´ë¦„', '')
                    reg_date = self.normalize_date_format(row.get('ë“±ë¡ ë‚ ì§œ', ''))
                    state = row.get('í˜„ì¬ ìˆëŠ” ì£¼', '')
                    key = (name, reg_date, state)
                    if key in existing_records:
                        skipped_records.append(f"â–¶ ì¤‘ë³µ ë ˆì½”ë“œ\n  - ì´ë¦„: {name}\n  - ë“±ë¡ ë‚ ì§œ: {reg_date}\n  - í˜„ì¬ ìˆëŠ” ì£¼: {state}\n")
                
                details = (
                    f"ì²˜ë¦¬ëœ íŒŒì¼: {patients_file}\n\n"
                    f"â–¶ ì²˜ë¦¬ ê²°ê³¼\n"
                    f"- ì´ ë ˆì½”ë“œ ìˆ˜: {len(patients_df)}ê°œ\n"
                    f"- ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ëœ ë ˆì½”ë“œ: {added_count}ê°œ\n"
                    f"- ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ: {skipped_count}ê°œ\n\n"
                    f"â–¶ í…Œì´ë¸” ì •ë³´\n"
                    f"- ì‹œì‘ í–‰: {min_row}\n"
                    f"- ì¢…ë£Œ í–‰: {next_row-1}\n"
                    f"- ì²˜ë¦¬ëœ ì»¬ëŸ¼: {', '.join(excel_headers.keys())}\n\n"
                )
                
                if skipped_records:
                    details += f"=== ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ ëª©ë¡ ===\n\n" + "\n".join(skipped_records)
                
                details += "\níŒŒì¼ì€ DONE í´ë”ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."
                
                self.show_detailed_result(
                    "ì²˜ë¦¬ ì™„ë£Œ",
                    f"Patients íŒŒì¼ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì¶”ê°€: {added_count}ê±´, ì¤‘ë³µ: {skipped_count}ê±´",
                    details
                )
                target_folder = "DONE"
            
            # íŒŒì¼ ì´ë™
            target_file = os.path.join(target_folder, os.path.basename(patients_file))
            shutil.move(patients_file, target_file)
            
            return True
            
        except Exception as e:
            self.logger.error(f"Patients íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            traceback.print_exc()  # ìƒì„¸ ì˜¤ë¥˜ ì •ë³´ ì¶œë ¥
            return False
    
    def process_payment_items(self, main_file, payment_file):
        """Process payment items and update the customer management table"""
        try:
            self.logger.info(f"PaymentItems íŒŒì¼ ì²˜ë¦¬ ì‹œì‘: {payment_file}")
            
            # ë³€ìˆ˜ ì´ˆê¸°í™”
            skipped_count = 0  # ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ í•­ëª© ìˆ˜
            exception_count = 0  # ì˜ˆì™¸ ì‚¬í•­ ìˆ˜
            processed_count = 0
            # ì¤‘ë³µ ë ˆì½”ë“œ ì •ë³´ ì €ì¥ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
            skipped_records = []  # ì¤‘ë³µ ë ˆì½”ë“œ
            exception_records = []  # ì˜ˆì™¸ ì‚¬í•­ ë ˆì½”ë“œ
            
            # ì˜ˆì™¸ ì²˜ë¦¬í•  ì˜ì‚¬ëª… ê´€ë ¨ ë°ì´í„° ì €ì¥ (ì¤‘ë³µ ì¹´ìš´íŒ… ë°©ì§€)
            excluded_record_keys = set()  # ì´ë¯¸ ì˜ˆì™¸ ì²˜ë¦¬ëœ ë ˆì½”ë“œì˜ í‚¤ (date_str, name_value)
            
            # íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ìë™ìœ¼ë¡œ chunk_size ê²°ì •
            file_size = os.path.getsize(payment_file)
            chunk_size = None
            if file_size > 5 * 1024 * 1024:  # 5MB ì´ìƒ
                chunk_size = 10000
                
            # íŒŒì¼ ì½ê¸°
            payment_df = self.read_csv_with_encoding(payment_file, chunk_size=chunk_size)
            if payment_df is None or payment_df.empty:
                self.logger.warning("PaymentItems íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return False
            
            # CSV ì»¬ëŸ¼ í™•ì¸ ë° ë¡œê¹…
            self.logger.info(f"CSV íŒŒì¼ ì»¬ëŸ¼: {list(payment_df.columns)}")
            
            # ë©”ì¸ íŒŒì¼ ì—´ê¸°
            wb = load_workbook(main_file)
            
            # Sales ì‹œíŠ¸ ì„ íƒ
            if 'Sales' in wb.sheetnames:
                sheet = wb['Sales']
            else:
                sheet = wb.active
                self.logger.warning(f"'Sales' ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ í˜„ì¬ í™œì„± ì‹œíŠ¸({sheet.title})ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
                
            # ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ì°¾ê¸°
            table = self.find_table("ê³ ê°ê´€ë¦¬ìë™", wb)
            if not table:
                self.logger.error("ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                messagebox.showerror("ì˜¤ë¥˜", "ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
                return False
            
            # í…Œì´ë¸” ë²”ìœ„ íŒŒì‹±
            min_col, min_row, max_col, max_row = range_boundaries(table.ref)
            self.logger.info(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ë²”ìœ„: í–‰({min_row}~{max_row}), ì—´({min_col}~{max_col})")
            
            # í—¤ë” ë§¤í•‘ ìƒì„±
            headers = []
            for col in range(min_col, max_col + 1):
                cell_value = sheet.cell(row=min_row, column=col).value
                headers.append(cell_value if cell_value else '')
            
            self.logger.info(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” í—¤ë”: {headers}")
            
            # í•„ìš”í•œ ì»¬ëŸ¼ ì°¾ê¸°
            header_mapping = {}
            for i, header in enumerate(headers):
                col_index = i + min_col
                if header == 'No.' or header == 'No' or header == 'ë²ˆí˜¸':
                    header_mapping['No.'] = col_index
                elif header == 'ë‚ ì§œ' or 'date' in str(header).lower():
                    header_mapping['ë‚ ì§œ'] = col_index
                elif header == 'í™˜ì ëª…' or 'í™˜ìëª…' in header or 'í™˜ì' in header:
                    header_mapping['í™˜ì ëª…'] = col_index
                elif header == 'ì§„ë‹¨ ì˜ì‚¬ëª…' or 'ì˜ì‚¬ëª…' in header:
                    header_mapping['ì§„ë‹¨ ì˜ì‚¬ëª…'] = col_index
                elif header == 'Note' or header == 'ì„¤ëª…' or header == 'ë©”ëª¨':
                    header_mapping['Note'] = col_index
                elif header == 'Price Table' or header == 'ê°€ê²©':
                    header_mapping['Price Table'] = col_index
                elif header == 'ì„±ë³„' or 'gender' in str(header).lower():
                    header_mapping['ì„±ë³„'] = col_index
                elif header == 'States' or header == 'ìƒíƒœ' or 'í˜„ì¬ ìˆëŠ” ì£¼' in str(header):
                    header_mapping['States'] = col_index
                
            # ëª¨ë“  í—¤ë” ë§¤í•‘ ë¡œê¹…
            self.logger.info(f"ì „ì²´ í—¤ë” ë§¤í•‘: {header_mapping}")
            
            # ì¤‘ë³µ ë°ì´í„° í™•ì¸ì„ ìœ„í•œ ê¸°ì¡´ ë°ì´í„° ìˆ˜ì§‘
            existing_data = set()
            if 'ë‚ ì§œ' in header_mapping and 'í™˜ì ëª…' in header_mapping:
                for row in range(min_row + 1, max_row + 1):
                    date_value = sheet.cell(row=row, column=header_mapping['ë‚ ì§œ']).value
                    name_value = sheet.cell(row=row, column=header_mapping['í™˜ì ëª…']).value
                    if date_value and name_value:
                        if isinstance(date_value, datetime):
                            date_str = date_value.strftime('%Y-%m-%d %H:%M')
                        else:
                            date_str = str(date_value)
                        existing_data.add((date_str, str(name_value)))
            
            # ëª¨ë“  ë°ì´í„°ê°€ ì¤‘ë³µì¸ì§€ í™•ì¸
            all_duplicate = True
            duplicate_count = 0
            non_duplicate_count = 0
            
            # ì¤‘ë³µ ì—¬ë¶€ë§Œ í™•ì¸í•˜ê¸° ìœ„í•œ ì„ì‹œ ì„¸íŠ¸ ìƒì„±
            temp_check_set = existing_data.copy()
            
            for _, row in payment_df.iterrows():
                date_value = self.format_date(row.get('ë‚ ì§œ', ''), include_time=True)
                name_value = row.get('í™˜ì', '')
                doctor_name = row.get('ì˜ë£Œì¸ ì´ë¦„', '')
                
                # í™˜ìëª…ì´ ì œì™¸ ëª©ë¡ì— ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                if hasattr(self, 'excluded_patients') and name_value and name_value.strip() in self.excluded_patients:
                    self.logger.info(f"ì œì™¸í•  í™˜ìëª… ê°ì§€: {name_value}, ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°")
                    exception_records.append({
                        'í™˜ìëª…': name_value,
                        'ë‚ ì§œ': date_value,
                        'ì§„ë‹¨ ì˜ì‚¬ëª…': doctor_name,
                        'ì„¤ëª…': row.get('ì„¤ëª…', ''),
                        'ê°€ê²©': row.get('ê°€ê²©', '') or f"{row.get('ì–‘', '')} {row.get('í†µí™”', '')}",
                        'ê±´ë„ˆë›´ ì´ìœ ': 'ì˜ˆì™¸ í™˜ìëª…'
                    })
                    exception_count += 1
                    continue
                
                # ì˜ì‚¬ëª…ì´ ì œì™¸ ëª©ë¡ì— ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸° - ì˜ˆì™¸ ì‚¬í•­ìœ¼ë¡œ ì²˜ë¦¬
                try:
                    if hasattr(self, 'excluded_doctors') and doctor_name and doctor_name.strip() in self.excluded_doctors:
                        self.logger.info(f"ì œì™¸í•  ì˜ì‚¬ëª… ê°ì§€: {doctor_name}, ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°")
                        exception_records.append({
                            'í™˜ìëª…': name_value,
                            'ë‚ ì§œ': date_value,
                            'ì§„ë‹¨ ì˜ì‚¬ëª…': doctor_name,
                            'ì„¤ëª…': row.get('ì„¤ëª…', ''),
                            'ê°€ê²©': row.get('ê°€ê²©', '') or f"{row.get('ì–‘', '')} {row.get('í†µí™”', '')}",
                            'ê±´ë„ˆë›´ ì´ìœ ': 'ì˜ˆì™¸ ì‚¬í•­'
                        })
                        exception_count += 1
                        
                        # ì´ë¯¸ ì²˜ë¦¬í•œ ì˜ˆì™¸ ë ˆì½”ë“œ í‚¤ ì €ì¥
                        if isinstance(date_value, datetime):
                            date_str = date_value.strftime('%Y-%m-%d %H:%M')
                        else:
                            date_str = str(date_value)
                        excluded_record_keys.add((date_str, str(name_value)))
                        
                        continue
                except:
                    pass
                
                if date_value and name_value:
                    if isinstance(date_value, datetime):
                        date_str = date_value.strftime('%Y-%m-%d %H:%M')
                    else:
                        date_str = str(date_value)
                    
                    # ì›ë³¸ ì´ë¦„ìœ¼ë¡œ ì¤‘ë³µ í™•ì¸ (ì„ì‹œ ì„¸íŠ¸ ì‚¬ìš©)
                    if (date_str, str(name_value)) in temp_check_set:
                        # ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë‚˜ ë ˆì½”ë“œ ì¶”ê°€ë¥¼ í•˜ì§€ ì•Šê³  ì¹´ìš´íŠ¸ë§Œ ì¦ê°€
                        duplicate_count += 1
                    else:
                        all_duplicate = False
                        non_duplicate_count += 1
                        # ì„ì‹œ ì„¸íŠ¸ì—ë§Œ ì¶”ê°€í•˜ê³  existing_dataëŠ” ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
                        temp_check_set.add((date_str, str(name_value)))
            
            # ì „ì²´ ì¤‘ë³µ ì—¬ë¶€ ê²°ì • (ì˜ˆì™¸ ì‚¬í•­ì€ ì¤‘ë³µì—ì„œ ì œì™¸)
            all_duplicate = (non_duplicate_count == 0 and duplicate_count > 0)
            
            # ëª¨ë“  ë°ì´í„°ê°€ ì¤‘ë³µì´ë©´ SKIPPED í´ë”ë¡œ ì´ë™
            if all_duplicate and len(exception_records) == 0:
                self.logger.info("ëª¨ë“  ë°ì´í„°ê°€ ì¤‘ë³µë˜ì–´ SKIPPED í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.")
                skipped_dir = os.path.join(os.path.dirname(payment_file), "SKIPPED")
                os.makedirs(skipped_dir, exist_ok=True)
                
                target_file = os.path.join(skipped_dir, os.path.basename(payment_file))
                if os.path.exists(target_file):
                    base, ext = os.path.splitext(target_file)
                    target_file = f"{base}_{datetime.now().strftime('%Y%m%d_%H%M%S')}{ext}"
                
                # ì¤‘ë³µ ë°ì´í„° ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
                duplicate_details = []
                for record in skipped_records:
                    duplicate_details.append(
                        f"â–¶ ì¤‘ë³µ ë ˆì½”ë“œ\n"
                        f"  - í™˜ìëª…: {record['í™˜ìëª…']}\n"
                        f"  - ë‚ ì§œ: {record['ë‚ ì§œ']}\n"
                        f"  - ì§„ë‹¨ ì˜ì‚¬ëª…: {record['ì§„ë‹¨ ì˜ì‚¬ëª…']}\n"
                        f"  - ê°€ê²©: {record['ê°€ê²©']}\n"
                        f"  - ì„¤ëª…: {record['ì„¤ëª…']}\n"
                    )
                
                # ìƒì„¸ ì •ë³´ êµ¬ì„±
                details = (
                    f"ì²˜ë¦¬ëœ íŒŒì¼: {payment_file}\n\n"
                    f"â–¶ í…Œì´ë¸” ì •ë³´\n"
                    f"- ì‹œì‘ í–‰: {min_row}\n"
                    f"- ì¢…ë£Œ í–‰: {max_row}\n"
                    f"- ì²˜ë¦¬ëœ ì»¬ëŸ¼: {', '.join(header_mapping.keys())}\n\n"
                    f"â–¶ ì²˜ë¦¬ ê²°ê³¼\n"
                    f"- ì´ ë ˆì½”ë“œ ìˆ˜: {len(payment_df)}ê°œ\n"
                    f"- ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ: {duplicate_count}ê°œ\n\n"
                )
                
                if duplicate_details:
                    details += f"=== ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ ëª©ë¡ ===\n\n" + "\n".join(duplicate_details)
                
                details += "\níŒŒì¼ì€ SKIPPED í´ë”ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."
                
                shutil.move(payment_file, target_file)
                self.logger.info(f"ì¤‘ë³µ íŒŒì¼ ì´ë™: {target_file}")
                
                # ê²°ê³¼ ì•Œë¦¼ì°½ í‘œì‹œ
                self.show_detailed_result(
                    "ì²˜ë¦¬ ì™„ë£Œ",
                    f"PaymentItems íŒŒì¼ì´ ëª¨ë‘ ì¤‘ë³µë˜ì–´ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤.\nì´ {len(payment_df)}ê±´ì˜ ì¤‘ë³µ ë ˆì½”ë“œ",
                    details
                )
                return True
            
            # ë§ˆì§€ë§‰ No. ê°’ ê°€ì ¸ì˜¤ê¸°
            last_no = 0
            if 'No.' in header_mapping:
                for row in range(min_row + 1, max_row + 1):
                    cell_value = sheet.cell(row=row, column=header_mapping['No.']).value
                    if cell_value is not None:
                        try:
                            if isinstance(cell_value, str):
                                num_str = ''.join(filter(str.isdigit, cell_value))
                                if num_str:
                                    last_no = max(last_no, int(num_str))
                            else:
                                last_no = max(last_no, int(cell_value))
                        except (ValueError, TypeError):
                            pass
            
            # ë°ì´í„° ì¶”ê°€
            current_row = max_row + 1
            processed_count = 0
            
            for _, row in payment_df.iterrows():
                # ì¤‘ë³µ í™•ì¸
                date_value = self.format_date(row.get('ë‚ ì§œ', ''), include_time=True)
                name_value = row.get('í™˜ì', '')
                doctor_name = row.get('ì˜ë£Œì¸ ì´ë¦„', '')
                
                # í™˜ìëª…ì´ ì œì™¸ ëª©ë¡ì— ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                if hasattr(self, 'excluded_patients') and name_value and name_value.strip() in self.excluded_patients:
                    self.logger.info(f"ì œì™¸í•  í™˜ìëª… ê°ì§€: {name_value}, ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°")
                    continue
                
                # ì˜ì‚¬ëª…ì´ ì œì™¸ ëª©ë¡ì— ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸° - ì˜ˆì™¸ ì‚¬í•­ìœ¼ë¡œ ì²˜ë¦¬
                try:
                    if hasattr(self, 'excluded_doctors') and doctor_name and doctor_name.strip() in self.excluded_doctors:
                        # ì´ë¯¸ ì´ì „ ë‹¨ê³„ì—ì„œ ì²˜ë¦¬í•œ ì˜ˆì™¸ ë ˆì½”ë“œì¸ì§€ í™•ì¸
                        if isinstance(date_value, datetime):
                            date_str = date_value.strftime('%Y-%m-%d %H:%M')
                        else:
                            date_str = str(date_value)
                            
                        if (date_str, str(name_value)) in excluded_record_keys:
                            # ì´ë¯¸ ì²˜ë¦¬ëœ ì˜ˆì™¸ ë ˆì½”ë“œëŠ” ê±´ë„ˆë›°ê¸°
                            continue
                            
                        self.logger.info(f"ì œì™¸í•  ì˜ì‚¬ëª… ê°ì§€: {doctor_name}, ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°")
                        exception_records.append({
                            'í™˜ìëª…': name_value,
                            'ë‚ ì§œ': date_value,
                            'ì§„ë‹¨ ì˜ì‚¬ëª…': doctor_name,
                            'ì„¤ëª…': row.get('ì„¤ëª…', ''),
                            'ê°€ê²©': row.get('ê°€ê²©', '') or f"{row.get('ì–‘', '')} {row.get('í†µí™”', '')}",
                            'ê±´ë„ˆë›´ ì´ìœ ': 'ì˜ˆì™¸ ì‚¬í•­'
                        })
                        exception_count += 1
                        continue
                except:
                    pass
                
                if date_value and name_value:
                    if isinstance(date_value, datetime):
                        date_str = date_value.strftime('%Y-%m-%d %H:%M')
                    else:
                        date_str = str(date_value)
                    
                    # ì¤‘ë³µ ë ˆì½”ë“œ í™•ì¸ ë° ì²˜ë¦¬
                    if (date_str, str(name_value)) in existing_data:
                        self.logger.warning(f"ì¤‘ë³µ ë°ì´í„°: {date_str}, {name_value}")
                        skipped_records.append({
                            'í™˜ìëª…': name_value,
                            'ë‚ ì§œ': date_value,
                            'ì§„ë‹¨ ì˜ì‚¬ëª…': doctor_name,
                            'ì„¤ëª…': row.get('ì„¤ëª…', ''),
                            'ê°€ê²©': row.get('ê°€ê²©', '') or f"{row.get('ì–‘', '')} {row.get('í†µí™”', '')}",
                            'ê±´ë„ˆë›´ ì´ìœ ': 'ì¤‘ë³µ ë°ì´í„°'
                        })
                        skipped_count += 1
                        continue
                    
                    existing_data.add((date_str, str(name_value)))
                
                # No. í•„ë“œ ì—…ë°ì´íŠ¸
                if 'No.' in header_mapping:
                    last_no += 1
                    sheet.cell(row=current_row, column=header_mapping['No.']).value = last_no
                
                # ë‚ ì§œ í•„ë“œ ì—…ë°ì´íŠ¸
                if 'ë‚ ì§œ' in header_mapping and 'ë‚ ì§œ' in row:
                    cell = sheet.cell(row=current_row, column=header_mapping['ë‚ ì§œ'])
                    cell.value = date_value
                    cell.number_format = 'yyyy-mm-dd hh:mm'
                
                # í™˜ì ëª… í•„ë“œ ì—…ë°ì´íŠ¸
                if 'í™˜ì ëª…' in header_mapping and 'í™˜ì' in row:
                    sheet.cell(row=current_row, column=header_mapping['í™˜ì ëª…']).value = row['í™˜ì']
                
                # ì§„ë‹¨ ì˜ì‚¬ëª… í•„ë“œ ì—…ë°ì´íŠ¸
                if 'ì§„ë‹¨ ì˜ì‚¬ëª…' in header_mapping and 'ì˜ë£Œì¸ ì´ë¦„' in row:
                    sheet.cell(row=current_row, column=header_mapping['ì§„ë‹¨ ì˜ì‚¬ëª…']).value = row['ì˜ë£Œì¸ ì´ë¦„']
                
                # Note í•„ë“œ ì—…ë°ì´íŠ¸
                if 'Note' in header_mapping and 'ì„¤ëª…' in row:
                    sheet.cell(row=current_row, column=header_mapping['Note']).value = row['ì„¤ëª…']
                
                # Price Table í•„ë“œ ì—…ë°ì´íŠ¸ (ì–‘ê³¼ í†µí™” ê²°í•©)
                if 'Price Table' in header_mapping:
                    if 'ì–‘' in row and 'í†µí™”' in row:
                        amount = row['ì–‘']
                        currency = row['í†µí™”']
                        if pd.notnull(amount) and pd.notnull(currency):
                            if currency.upper() == 'USD':
                                price_value = f'${amount}'
                            else:
                                price_value = f'{amount} {currency}'
                            sheet.cell(row=current_row, column=header_mapping['Price Table']).value = price_value
                    elif 'ê°€ê²©' in row:
                        # 'ê°€ê²©' ì—´ì´ ìˆëŠ” ê²½ìš° ì§ì ‘ ì‚¬ìš©
                        sheet.cell(row=current_row, column=header_mapping['Price Table']).value = row['ê°€ê²©']
                
                current_row += 1
                processed_count += 1
            
            # í…Œì´ë¸” ë²”ìœ„ í™•ì¥
            if processed_count > 0:
                new_range = f"{get_column_letter(min_col)}{min_row}:{get_column_letter(max_col)}{max_row + processed_count}"
                table.ref = new_range
                self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ í™•ì¥: {table.ref}")
            
            # ë³€ê²½ì‚¬í•­ ì €ì¥
            wb.save(main_file)
            
            # ê²°ê³¼ ë©”ì‹œì§€ êµ¬ì„± - ì˜ˆì™¸ì™€ ì¤‘ë³µ êµ¬ë¶„
            summary_parts = []
            summary_parts.append(f"PaymentItems ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ {len(payment_df)}ê±´ ì¤‘ {processed_count}ê±´ ì²˜ë¦¬ë¨")
            
            if skipped_count > 0:
                summary_parts.append(f"{skipped_count}ê±´ ì¤‘ë³µ ì œì™¸")
                
            if exception_count > 0:
                summary_parts.append(f"{exception_count}ê±´ ì˜ˆì™¸ ì‚¬í•­ ì œì™¸")
            
            summary = ", ".join(summary_parts)
            
            # ì¤‘ë³µ ë ˆì½”ë“œ ìƒì„¸ ì •ë³´ êµ¬ì„±
            duplicate_details = []
            for record in skipped_records:
                duplicate_details.append(
                    f"â–¶ ì¤‘ë³µ ë ˆì½”ë“œ\n"
                    f"  - í™˜ìëª…: {record['í™˜ìëª…']}\n"
                    f"  - ë‚ ì§œ: {record['ë‚ ì§œ']}\n"
                    f"  - ì§„ë‹¨ ì˜ì‚¬ëª…: {record['ì§„ë‹¨ ì˜ì‚¬ëª…']}\n"
                    f"  - ê°€ê²©: {record['ê°€ê²©']}\n"
                    f"  - ì„¤ëª…: {record['ì„¤ëª…']}\n"
                )
            
            # ì˜ˆì™¸ í•­ëª© ìƒì„¸ ì •ë³´ êµ¬ì„±
            exception_details = []
            for record in exception_records:
                exception_details.append(
                    f"â–¶ ì˜ˆì™¸ ì‚¬í•­\n"
                    f"  - í™˜ìëª…: {record['í™˜ìëª…']}\n"
                    f"  - ë‚ ì§œ: {record['ë‚ ì§œ']}\n"
                    f"  - ì§„ë‹¨ ì˜ì‚¬ëª…: {record['ì§„ë‹¨ ì˜ì‚¬ëª…']}\n"
                    f"  - ê°€ê²©: {record['ê°€ê²©']}\n"
                    f"  - ì„¤ëª…: {record['ì„¤ëª…']}\n"
                )
                
            # ìƒì„¸ ì •ë³´ êµ¬ì„±
            details = (
                f"ì²˜ë¦¬ëœ íŒŒì¼: {payment_file}\n\n"
                f"â–¶ í…Œì´ë¸” ì •ë³´\n"
                f"- ì‹œì‘ í–‰: {min_row}\n"
                f"- ì¢…ë£Œ í–‰: {max_row + processed_count}\n"
                f"- ì²˜ë¦¬ëœ ì»¬ëŸ¼: {', '.join(header_mapping.keys())}\n\n"
                f"â–¶ ì²˜ë¦¬ ê²°ê³¼\n"
                f"- CSV íŒŒì¼ ë ˆì½”ë“œ ìˆ˜: {len(payment_df)}ê°œ\n"
                f"- ì²˜ë¦¬ëœ ë ˆì½”ë“œ: {processed_count}ê°œ\n"
                f"- ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ: {skipped_count}ê°œ\n"
                f"- ì˜ˆì™¸ ì‚¬í•­ìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ: {exception_count}ê°œ\n"
                f"- í•©ê³„: {processed_count + skipped_count + exception_count}ê°œ\n"
            )
            
            # ì˜ˆì™¸ í•­ëª© ì •ë³´ ì¶”ê°€
            if exception_count > 0 and exception_details:
                details += f"\n=== ì˜ˆì™¸ ì‚¬í•­ìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ ëª©ë¡ ({exception_count}ê±´) ===\n\n" + "\n".join(exception_details)
            
            # ì¤‘ë³µ ë ˆì½”ë“œ ì •ë³´ ì¶”ê°€
            if skipped_count > 0 and duplicate_details:
                details += f"\n=== ì¤‘ë³µìœ¼ë¡œ ê±´ë„ˆë›´ ë ˆì½”ë“œ ëª©ë¡ ({skipped_count}ê±´) ===\n\n" + "\n".join(duplicate_details)
            
            # ì²˜ë¦¬ëœ íŒŒì¼ ì´ë™
            done_dir = os.path.join(os.path.dirname(payment_file), "DONE")
            os.makedirs(done_dir, exist_ok=True)
            
            target_file = os.path.join(done_dir, os.path.basename(payment_file))
            if os.path.exists(target_file):
                base, ext = os.path.splitext(target_file)
                target_file = f"{base}_{datetime.now().strftime('%Y%m%d_%H%M%S')}{ext}"
            
            shutil.move(payment_file, target_file)
            self.logger.info(f"ì²˜ë¦¬ëœ íŒŒì¼ ì´ë™: {target_file}")
            
            # ê²°ê³¼ ì•Œë¦¼ì°½ í‘œì‹œ
            self.show_detailed_result("ì²˜ë¦¬ ì™„ë£Œ", summary, details)
            
            return True
            
        except Exception as e:
            self.logger.error(f"ê²°ì œ í•­ëª© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            self.logger.error(traceback.format_exc())
            messagebox.showerror("ì˜¤ë¥˜", f"PaymentItems ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n{str(e)}")
            return False
    
    def standardize_register_dates_in_patient_table(self, sheet, table):
        """Convert 'ë“±ë¡ ë‚ ì§œ' column format to 'ë…„,ì›”,ì¼'"""
        # Get table range
        table_range = table.ref
        min_col, min_row, max_col, max_row = range_boundaries(table_range)
        
        # Find 'ë“±ë¡ ë‚ ì§œ' column
        header_row = []
        for col in range(min_col, max_col + 1):
            cell_value = sheet.cell(row=min_row, column=col).value
            header_row.append(cell_value if cell_value else f"Column_{col}")
            
        reg_date_col = next((i + min_col for i, header in enumerate(header_row) if header == "ë“±ë¡ ë‚ ì§œ"), None)
        
        if reg_date_col is None:
            print("'ë“±ë¡ ë‚ ì§œ' ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return
            
        # Update registration dates
        for row in range(min_row + 1, max_row + 1):
            date_cell = sheet.cell(row=row, column=reg_date_col)
            date_value = date_cell.value
            
            if date_value:
                try:
                    # ì´ë¯¸ 'ë…„,ì›”,ì¼' í˜•ì‹ì¸ ê²½ìš° ê±´ë„ˆë›°ê¸°
                    if isinstance(date_value, str) and "ë…„" in date_value and "ì›”" in date_value and "ì¼" in date_value:
                        continue
                        
                    # '7ì›” 15, 2024' í˜•ì‹ ì²˜ë¦¬
                    if isinstance(date_value, str) and "ì›”" in date_value and "," in date_value:
                        try:
                            # ì›”, ì¼, ì—°ë„ ì¶”ì¶œ
                            month = int(date_value.split("ì›”")[0])
                            day = int(date_value.split(",")[0].split("ì›”")[1].strip())
                            year = int(date_value.split(",")[1].strip())
                            dt = pd.Timestamp(year=year, month=month, day=day)
                        except:
                            dt = pd.to_datetime(date_value, errors='coerce')
                    else:
                        dt = pd.to_datetime(date_value, errors='coerce')
                    
                    if pd.notnull(dt):
                        formatted_date = f"{dt.year}ë…„,{dt.month}ì›”,{dt.day}ì¼"
                        date_cell.value = formatted_date
                        print(f"ë‚ ì§œ ë³€í™˜ ì„±ê³µ ({row}í–‰): {date_value} -> {formatted_date}")
                    else:
                        print(f"ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨ ({row}í–‰): {date_value}")
                except Exception as e:
                    print(f"ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜ ({row}í–‰, ê°’: {date_value}): {str(e)}")
    
    def update_patient_info(self):
        """Update patient information in the customer management table"""
        try:
            self.logger.info("í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì‘ì—… ì‹œì‘")
            
            # ë©”ì¸ íŒŒì¼ í™•ì¸
            main_file = self.find_main_file()
            if not main_file:
                self.logger.error("ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
                messagebox.showerror("ì˜¤ë¥˜", "ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê°ì§€ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
                self.enable_buttons()
                return
            
            self.logger.info(f"ë©”ì¸ íŒŒì¼ ë°œê²¬: {main_file}")
            
            # íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            if not self.check_file_access(main_file):
                self.logger.error(f"ë©”ì¸ íŒŒì¼ ì ‘ê·¼ ë¶ˆê°€: {main_file}")
                messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì´ ì—´ë ¤ìˆê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”: {main_file}")
                self.enable_buttons()
                return
            
            # Create backup
            try:
                backup_dir = os.path.join(os.path.dirname(main_file), "BACK UP")
                os.makedirs(backup_dir, exist_ok=True)
                backup_file = os.path.join(backup_dir, f"BACKUP_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{os.path.basename(main_file)}")
                self.logger.info(f"ë°±ì—… í´ë” ìƒì„±/í™•ì¸: {backup_dir}")
                self.logger.info(f"ë°±ì—… íŒŒì¼ ìƒì„± ì‹œë„: {backup_file}")
                shutil.copy2(main_file, backup_file)
                self.logger.info(f"ë©”ì¸ íŒŒì¼ ë°±ì—… ìƒì„± ì™„ë£Œ: {backup_file}")
            except Exception as e:
                self.logger.error(f"ë°±ì—… ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                if not os.path.exists(main_file):
                    self.logger.error(f"ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {main_file}")
                    messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {main_file}")
                    self.enable_buttons()
                    return
                else:
                    self.logger.warning("ë°±ì—… ìƒì„±ì€ ì‹¤íŒ¨í–ˆì§€ë§Œ ë©”ì¸ íŒŒì¼ì€ ì¡´ì¬í•¨. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
            
            # Load workbook
            self.logger.info("ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì¤‘...")
            wb = load_workbook(main_file)
            
            # Find the tables
            self.logger.info("í…Œì´ë¸” ê²€ìƒ‰ ì¤‘...")
            patient_table = self.find_table("í™˜ììë™", wb)
            customer_table = self.find_table("ê³ ê°ê´€ë¦¬ìë™", wb)
            
            if not patient_table:
                self.logger.error("'í™˜ììë™' í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ")
                messagebox.showerror("ì˜¤ë¥˜", "'í™˜ììë™' í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
                self.enable_buttons()
                return
                
            if not customer_table:
                self.logger.error("'ê³ ê°ê´€ë¦¬ìë™' í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                messagebox.showerror("ì˜¤ë¥˜", "'ê³ ê°ê´€ë¦¬ìë™' í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
                self.enable_buttons()
                return
                
            # Get patient table data
            patient_range = patient_table.ref
            p_min_col, p_min_row, p_max_col, p_max_row = range_boundaries(patient_range)
            self.logger.info(f"í™˜ììë™ í…Œì´ë¸” ë²”ìœ„: ì‹œì‘ í–‰={p_min_row}, ë í–‰={p_max_row}, ì‹œì‘ ì—´={p_min_col}, ë ì—´={p_max_col}")
            
            # Read patient table headers
            patient_headers = []
            for col in range(p_min_col, p_max_col + 1):
                cell_value = wb['Patients'].cell(row=p_min_row, column=col).value
                patient_headers.append(cell_value if cell_value else f"Column_{col}")
            
            self.logger.debug(f"í™˜ììë™ í…Œì´ë¸” í—¤ë”: {patient_headers}")
                
            # Find columns in patient table (0-based index)
            p_name_col = next((i for i, header in enumerate(patient_headers) if header == "ì´ë¦„"), None)
            p_email_col = next((i for i, header in enumerate(patient_headers) if header == "ì´ë©”ì¼"), None)
            p_dob_col = next((i for i, header in enumerate(patient_headers) if header == "ìƒë…„ì›”ì¼"), None)  # ìƒë…„ì›”ì¼ë¡œ ê²€ìƒ‰
            # ìƒë…„ì›”ì¼ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ìƒë…„ ì»¬ëŸ¼ì„ ì°¾ìŠµë‹ˆë‹¤
            if p_dob_col is None:
                p_dob_col = next((i for i, header in enumerate(patient_headers) if header == "ìƒë…„"), None)
            p_gender_col = next((i for i, header in enumerate(patient_headers) if header == "ì„±ë³„"), None)
            p_state_col = next((i for i, header in enumerate(patient_headers) if header == "í˜„ì¬ ìˆëŠ” ì£¼"), None)
            p_age_col = next((i for i, header in enumerate(patient_headers) if header == "ë‚˜ì´"), None)
            p_reg_date_col = next((i for i, header in enumerate(patient_headers) if header == "ë“±ë¡ ë‚ ì§œ"), None)
            p_city_col = next((i for i, header in enumerate(patient_headers) if header == "ë„ì‹œ"), None)
            
            # ì»¬ëŸ¼ ì°¾ê¸° ê²°ê³¼ ë¡œê¹…
            self.logger.info("\n=== í™˜ììë™ í…Œì´ë¸” ì»¬ëŸ¼ ì •ë³´ ===")
            self.logger.info(f"ì´ë¦„ ì»¬ëŸ¼: {p_name_col}")
            self.logger.info(f"ë“±ë¡ ë‚ ì§œ ì»¬ëŸ¼: {p_reg_date_col}")
            self.logger.info(f"ìƒë…„/ìƒë…„ì›”ì¼ ì»¬ëŸ¼: {p_dob_col}")
            self.logger.info(f"í˜„ì¬ ìˆëŠ” ì£¼ ì»¬ëŸ¼: {p_state_col}")
            self.logger.info(f"ì„±ë³„ ì»¬ëŸ¼: {p_gender_col}")
            self.logger.info(f"ë‚˜ì´ ì»¬ëŸ¼: {p_age_col}")
            
            # ì´ë©”ì¼ê³¼ ë„ì‹œë¥¼ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­ì—ì„œ ì œì™¸ (ì´ë¦„ê³¼ ìƒë…„ë§Œ í•„ìˆ˜)
            if not all([p_name_col, p_dob_col]):
                self.logger.error(f"í•„ìˆ˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„: {p_name_col}, ìƒë…„: {p_dob_col}")
                return False
                
            # í™˜ììë™ í…Œì´ë¸”ì˜ ìƒë…„ì›”ì¼ í—¤ë”ë¥¼ ìƒë…„ìœ¼ë¡œ ë³€ê²½
            patients_sheet = wb['Patients']
            cell = patients_sheet.cell(row=p_min_row, column=p_min_col + p_dob_col)
            old_value = cell.value
            cell.value = "ìƒë…„"
            self.logger.info(f"í™˜ììë™ í…Œì´ë¸” í—¤ë” ë³€ê²½: '{old_value}' â†’ 'ìƒë…„'")

            # í—¤ë” ëª©ë¡ ì—…ë°ì´íŠ¸
            patient_headers[p_dob_col] = "ìƒë…„"
            
            # í™˜ììë™ í…Œì´ë¸”ì˜ ë„ì‹œì™€ ì´ë©”ì¼ ì»¬ëŸ¼ ì‚­ì œ
            cols_to_delete = []
            
            # ë„ì‹œ ì»¬ëŸ¼ ì°¾ê¸°
            p_city_col = next((i for i, header in enumerate(patient_headers) if header == "ë„ì‹œ"), None)
            if p_city_col is not None:
                cols_to_delete.append(p_min_col + p_city_col)
                self.logger.info(f"ë„ì‹œ ì»¬ëŸ¼ ì‚­ì œ ì˜ˆì •: ì—´ {p_min_col + p_city_col}")
            
            # ì´ë©”ì¼ ì»¬ëŸ¼ ì°¾ê¸°
            if p_email_col is not None:
                cols_to_delete.append(p_min_col + p_email_col)
                self.logger.info(f"ì´ë©”ì¼ ì»¬ëŸ¼ ì‚­ì œ ì˜ˆì •: ì—´ {p_min_col + p_email_col}")
            
            # ì»¬ëŸ¼ ì‚­ì œ (ì¸ë±ìŠ¤ê°€ í° ìˆœì„œëŒ€ë¡œ ì‚­ì œí•´ì•¼ ì¸ë±ìŠ¤ ë³€ê²½ ë¬¸ì œ ì—†ìŒ)
            if cols_to_delete:
                for col_idx in sorted(cols_to_delete, reverse=True):
                    try:
                        self.logger.info(f"ì»¬ëŸ¼ ì‚­ì œ ì‹œë„: ì—´ {col_idx}")
                        patients_sheet.delete_cols(col_idx, 1)
                        self.logger.info(f"ì»¬ëŸ¼ ì‚­ì œ ì„±ê³µ: ì—´ {col_idx}")
                        
                        # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸
                        p_max_col -= 1
                        
                        # í…Œì´ë¸” ì°¸ì¡° ì—…ë°ì´íŠ¸
                        patient_table.ref = f"{get_column_letter(p_min_col)}{p_min_row}:{get_column_letter(p_max_col)}{p_max_row}"
                        self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸: {patient_table.ref}")
                    except Exception as e:
                        self.logger.error(f"ì»¬ëŸ¼ ì‚­ì œ ì‹¤íŒ¨: {str(e)}")
            
            # ìƒë…„ì›”ì¼ ë°ì´í„°ë¥¼ ìƒë…„(ì—°ë„)ë§Œ ì¶”ì¶œí•˜ì—¬ ì €ì¥
            birth_year_updates = 0
            for p_row in range(p_min_row + 1, p_max_row + 1):
                birth_date = patients_sheet.cell(row=p_row, column=p_min_col + p_dob_col).value
                if birth_date:
                    try:
                        # ë‚ ì§œ ê°ì²´ì¸ ê²½ìš°
                        if isinstance(birth_date, datetime):
                            birth_year = birth_date.year
                            patients_sheet.cell(row=p_row, column=p_min_col + p_dob_col).value = birth_year
                            birth_year_updates += 1
                        # ë¬¸ìì—´ì—ì„œ ì—°ë„ ì¶”ì¶œ
                        elif isinstance(birth_date, str):
                            # ë‹¤ì–‘í•œ í˜•ì‹ ì²˜ë¦¬
                            date_patterns = [
                                r'(\d{4})[/\-\.](0?[1-9]|1[0-2])[/\-\.](0?[1-9]|[12][0-9]|3[01])',  # YYYY/MM/DD
                                r'(0?[1-9]|1[0-2])[/\-\.](0?[1-9]|[12][0-9]|3[01])[/\-\.](\d{4})',  # MM/DD/YYYY
                                r'(0?[1-9]|[12][0-9]|3[01])[/\-\.](0?[1-9]|1[0-2])[/\-\.](\d{4})',  # DD/MM/YYYY
                                r'(\d{4})ë…„\s*(0?[1-9]|1[0-2])ì›”\s*(0?[1-9]|[12][0-9]|3[01])ì¼',     # YYYYë…„ MMì›” DDì¼
                                r'(\d{4})',  # ì—°ë„ë§Œ (YYYY)
                                r'(?:0?[1-9]|1[0-2])ì›”\s*(?:0?[1-9]|[12][0-9]|3[01]),\s*(\d{4})'  # MMì›” DD, YYYY
                            ]
                            
                            birth_year = None
                            for pattern in date_patterns:
                                match = re.search(pattern, birth_date)
                                if match:
                                    if 'ë…„' in pattern:  # í•œêµ­ì‹
                                        birth_year = int(match.group(1))
                                    elif pattern == r'(\d{4})':  # ì—°ë„ë§Œ
                                        birth_year = int(match.group(1))
                                    elif pattern.endswith(r'(\d{4})'):  # MMì›” DD, YYYY
                                        birth_year = int(match.group(1))
                                    elif '/' in pattern or '-' in pattern or '.' in pattern:
                                        # íŒ¨í„´ì— ë”°ë¼ ì—°ë„ ìœ„ì¹˜ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
                                        if pattern.startswith(r'(\d{4})'):  # YYYY/MM/DD
                                            birth_year = int(match.group(1))
                                        else:  # MM/DD/YYYY ë˜ëŠ” DD/MM/YYYY
                                            birth_year = int(match.group(3))
                                        break
                            
                            if birth_year:
                                patients_sheet.cell(row=p_row, column=p_min_col + p_dob_col).value = birth_year
                                birth_year_updates += 1
                                
                        # ìˆ«ìì¸ ê²½ìš° (ì—‘ì…€ ë‚´ë¶€ í‘œí˜„)
                        elif isinstance(birth_date, (int, float)) and 1900 <= birth_date <= 2100:
                            birth_year = int(birth_date)
                            # ì´ë¯¸ ì—°ë„ë§Œ ìˆëŠ” ê²½ìš°ì´ë¯€ë¡œ ì¶”ê°€ ë³€í™˜ ë¶ˆí•„ìš”
                        # ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼ ë„˜ë²„ì¸ ê²½ìš°
                        elif isinstance(birth_date, (int, float)):
                            # ì—‘ì…€ì˜ ë‚ ì§œëŠ” 1900ë…„ 1ì›” 1ì¼ë¶€í„°ì˜ ì¼ìˆ˜
                            excel_date = datetime(1899, 12, 30) + timedelta(days=int(birth_date))
                            birth_year = excel_date.year
                            patients_sheet.cell(row=p_row, column=p_min_col + p_dob_col).value = birth_year
                            birth_year_updates += 1
                    except Exception as e:
                        self.logger.error(f"ìƒë…„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ (í–‰ {p_row}): {e}")
            
            self.logger.info(f"ìƒë…„ì›”ì¼ ë°ì´í„°ë¥¼ ìƒë…„(ì—°ë„)ë§Œìœ¼ë¡œ ë³€í™˜ ì™„ë£Œ: ì´ {birth_year_updates}ê±´")
            
            # ë¡œê·¸ì— ë„ì‹œì™€ ì´ë©”ì¼ ì»¬ëŸ¼ ì •ë³´ë„ í¬í•¨ (ìˆëŠ” ê²½ìš°ë§Œ)
            log_message = f"í™˜ììë™ í…Œì´ë¸” ì»¬ëŸ¼ ì •ë³´: ì´ë¦„={p_name_col}, ìƒë…„={p_dob_col}, ì„±ë³„={p_gender_col}, í˜„ì¬ ìˆëŠ” ì£¼={p_state_col}, ë‚˜ì´={p_age_col}"
            if p_email_col is not None:
                log_message += f", ì´ë©”ì¼={p_email_col}"
            if p_city_col is not None:
                log_message += f", ë„ì‹œ={p_city_col}"
            self.logger.info(log_message)
            
            # Get customer management table data
            customer_range = customer_table.ref
            c_min_col, c_min_row, c_max_col, c_max_row = range_boundaries(customer_range)
            self.logger.info(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ë²”ìœ„: ì‹œì‘ í–‰={c_min_row}, ë í–‰={c_max_row}, ì‹œì‘ ì—´={c_min_col}, ë ì—´={c_max_col}")
            
            # Read customer management table headers
            customer_headers = []
            for col in range(c_min_col, c_max_col + 1):
                cell_value = wb['Sales'].cell(row=c_min_row, column=col).value
                customer_headers.append(cell_value if cell_value else f"Column_{col}")
            
            self.logger.debug(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” í—¤ë”: {customer_headers}")
                
            # Find columns in customer management table
            c_patient_name_col = next((i for i, header in enumerate(customer_headers) if 'í™˜ì ëª…' in str(header) or 'patient' in str(header).lower()), None)
            c_no_col = next((i for i, header in enumerate(customer_headers) if header == "No."), None)
            c_age_col = next((i for i, header in enumerate(customer_headers) if 'ages' in str(header).lower()), None)
            c_birth_year_col = next((i for i, header in enumerate(customer_headers) if 'ìƒë…„' in str(header) or 'birth' in str(header).lower()), None)
            c_gender_col = next((i for i, header in enumerate(customer_headers) if 'ì„±ë³„' in str(header) or 'gender' in str(header).lower()), None)
            c_state_col = next((i for i, header in enumerate(customer_headers) if 'states' in str(header).lower()), None)
            c_price_col = next((i for i, header in enumerate(customer_headers) if 'price table' in str(header).lower()), None)
            c_doctor_col = next((i for i, header in enumerate(customer_headers) if 'ì§„ë‹¨ ì˜ì‚¬ëª…' in str(header) or 'ì˜ì‚¬' in str(header) or 'doctor' in str(header).lower()), None)
            
            self.logger.debug(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” í—¤ë”: {customer_headers}")
            self.logger.debug(f"í™˜ìëª… ì»¬ëŸ¼: {c_patient_name_col}, No. ì»¬ëŸ¼: {c_no_col}, Ages ì»¬ëŸ¼: {c_age_col}, ìƒë…„ ì»¬ëŸ¼: {c_birth_year_col}")
            self.logger.debug(f"ì„±ë³„ ì»¬ëŸ¼: {c_gender_col}, States ì»¬ëŸ¼: {c_state_col}, Price Table ì»¬ëŸ¼: {c_price_col}, ì˜ì‚¬ëª… ì»¬ëŸ¼: {c_doctor_col}")
            
            if c_patient_name_col is None:
                self.logger.error("ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸”ì—ì„œ 'í™˜ì ëª…' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                return
                
            # ì •ê·œí™” í•¨ìˆ˜ ì •ì˜
            def normalize_name(name):
                if name is None:
                    return ""
                # ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì œê±°, ê³µë°± ì œê±°, íŠ¹ìˆ˜ë¬¸ì ì œê±°
                return re.sub(r'[^\w\s]', '', str(name).lower().strip()).replace(" ", "")
            
            # ì´ë¦„ ìœ ì‚¬ë„ ê²€ì‚¬ (80% ì´ìƒ ìœ ì‚¬í•˜ë©´ ë§¤ì¹˜)
            def name_similarity(name1, name2):
                if not name1 or not name2:
                    return 0
                
                name1 = name1.lower().strip()
                name2 = name2.lower().strip()
                
                # ì™„ì „ ë™ì¼í•œ ê²½ìš°
                if name1 == name2:
                    return 1.0
                
                # í•œìª½ì´ ë‹¤ë¥¸ìª½ì— ì™„ì „íˆ í¬í•¨ëœ ê²½ìš°
                if name1 in name2 or name2 in name1:
                    return 0.9
                
                # ë ˆë²¤ìŠˆíƒ€ì¸ ê±°ë¦¬ ê³„ì‚° (ë¬¸ìì—´ í¸ì§‘ ê±°ë¦¬)
                max_len = max(len(name1), len(name2))
                if max_len == 0:
                    return 0
                
                # í¸ì§‘ ê±°ë¦¬ ê³„ì‚°
                distance = 0
                for c1, c2 in zip(name1, name2):
                    if c1 != c2:
                        distance += 1
                
                # ê¸¸ì´ ì°¨ì´ ì¶”ê°€
                distance += abs(len(name1) - len(name2))
                
                # ìœ ì‚¬ë„ ì ìˆ˜ ê³„ì‚° (0~1)
                similarity = 1 - (distance / max_len)
                return similarity
            
            # ì´ˆê¸°í™” ë³€ìˆ˜ë“¤
            update_count = 0
            age_updates = 0
            gender_updates = 0
            state_updates = 0
            no_updates = 0
            birth_year_updates = 0
            skipped_count = 0
            deleted_count = 0  # ì‚­ì œëœ í–‰ ìˆ˜ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
            gender_skipped_count = 0  # ì„±ë³„ í•„ë“œê°€ ì´ë¯¸ ìˆì–´ì„œ ìŠ¤í‚µëœ í•­ëª© ìˆ˜
            state_skipped_count = 0  # States í•„ë“œê°€ ì´ë¯¸ ìˆì–´ì„œ ìŠ¤í‚µëœ í•­ëª© ìˆ˜
            
            self.logger.info("í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì‹œì‘...")
            
            # í…Œì´ë¸”ì—ì„œ ê°€ì¥ í° No. ê°’ ì°¾ê¸°
            max_no = 0
            if c_no_col is not None:
                for row in range(c_min_row + 1, c_max_row + 1):
                    cell_value = wb['Sales'].cell(row=row, column=c_min_col + c_no_col).value
                    if isinstance(cell_value, (int, float)) and cell_value > max_no:
                        max_no = int(cell_value)
                self.logger.debug(f"í˜„ì¬ í…Œì´ë¸”ì˜ ê°€ì¥ í° No. ê°’: {max_no}")
            
            # ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸”ì˜ ëª¨ë“  í™˜ìëª… ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            all_patients = []
            for c_row in range(c_min_row + 1, c_max_row + 1):
                patient_name = wb['Sales'].cell(row=c_row, column=c_min_col + c_patient_name_col).value if c_patient_name_col is not None else None
                if patient_name:
                    all_patients.append(f"{patient_name} (í–‰: {c_row})")
            
            self.logger.debug(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸”ì˜ ëª¨ë“  í™˜ì: {', '.join(all_patients)}")
            
            # í™˜ììë™ í…Œì´ë¸”ì˜ ëª¨ë“  ì´ë¦„ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            all_names = []
            for p_row in range(p_min_row + 1, p_max_row + 1):
                p_name = wb['Patients'].cell(row=p_row, column=p_min_col + p_name_col).value if p_name_col is not None else None
                if p_name:
                    all_names.append(f"{p_name} (í–‰: {p_row})")
            
            self.logger.debug(f"í™˜ììë™ í…Œì´ë¸”ì˜ ëª¨ë“  ì´ë¦„: {', '.join(all_names)}")
            
            # ì œì™¸í•  í™˜ì ëª©ë¡
            self.logger.info(f"ì œì™¸í•  í™˜ì ëª©ë¡: {', '.join(self.excluded_patients)}")
            
            # ì œì™¸í•  ì˜ì‚¬ëª… ëª©ë¡ ì¶”ê°€
            self.logger.info(f"ì œì™¸í•  ì˜ì‚¬ëª… ëª©ë¡: {', '.join(self.excluded_doctors)}")
            
            # ë¨¼ì € ì œì™¸í•  í™˜ìì˜ í–‰ ì°¾ê¸°
            rows_to_delete = set()
            for row in range(c_min_row + 1, c_max_row + 1):
                patient_name = wb['Sales'].cell(row=row, column=c_min_col + c_patient_name_col).value
                if patient_name and patient_name.strip() in self.excluded_patients:
                    rows_to_delete.add(row)
                    self.logger.info(f"ì œì™¸í•  í™˜ì ë°œê²¬: '{patient_name}', í–‰ {row}")
            
            # ì œì™¸í•  í™˜ìì˜ í–‰ ì‚­ì œ
            if rows_to_delete:
                for row in sorted(rows_to_delete, reverse=True):
                    wb['Sales'].delete_rows(row)
                    self.logger.info(f"ì œì™¸í•  í™˜ì í–‰ {row} ì‚­ì œ ì™„ë£Œ")
                
                # í…Œì´ë¸” ë²”ìœ„ ì¡°ì •
                deleted_count = len(rows_to_delete)  # ì‚­ì œëœ í–‰ ìˆ˜ ê¸°ë¡
                c_max_row -= deleted_count
                self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ ì¡°ì •: ì‚­ì œëœ í–‰ ìˆ˜ = {deleted_count}, ìƒˆë¡œìš´ ë§ˆì§€ë§‰ í–‰ = {c_max_row}")
                
                # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸
                try:
                    sales_sheet = wb['Sales']
                    if hasattr(sales_sheet, 'tables') and sales_sheet.tables:
                        table = next(iter(sales_sheet.tables.values()))
                        current_ref = table.ref
                        new_ref = f"{current_ref.split(':')[0]}:{openpyxl.utils.get_column_letter(c_max_col)}{c_max_row}"
                        table.ref = new_ref
                        self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸: {current_ref} â†’ {new_ref}")
                except Exception as e:
                    self.logger.error(f"í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                    self.logger.error(traceback.format_exc())
            
            # Process customer management table rows
            for c_row in range(c_min_row + 1, c_max_row + 1):
                # ì‹¤ì œ ì›Œí¬ë¶ì˜ í–‰/ì—´ ì¸ë±ìŠ¤ë¡œ ë³€í™˜
                c_row_idx = c_row
                
                # í™˜ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                patient_name_idx = c_min_col + c_patient_name_col
                patient_name = wb['Sales'].cell(row=c_row_idx, column=patient_name_idx).value
                
                # Skip if patient name is empty or in excluded list
                if not patient_name or patient_name.strip() in self.excluded_patients:
                    continue
                    
                self.logger.debug(f"ì²˜ë¦¬ ì¤‘ì¸ í™˜ì: {patient_name} (í–‰: {c_row_idx})")
                
                # í™˜ììë™ í…Œì´ë¸”ì—ì„œ ì¼ì¹˜í•˜ëŠ” í™˜ì ì°¾ê¸°
                best_match = None
                highest_similarity = 0
                match_row = None
                
                # ì´ë¯¸ ì´ˆì„±/ì´ë‹ˆì…œë¡œ ë³€í™˜ëœ í™˜ì ì´ë¦„ì„ ì›ë˜ í˜•íƒœë¡œ ë³µì›í•˜ëŠ” ë§¤ì¹­ ì‘ì—…ì´ í•„ìš”í•¨
                for p_row in range(p_min_row + 1, p_max_row + 1):
                    p_name = wb['Patients'].cell(row=p_row, column=p_min_col + p_name_col).value
                    if not p_name:
                        continue
                    
                    # ì´ë¦„ ê¸°ë°˜ìœ¼ë¡œ ë§¤ì¹­ (ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° ìš°ì„ )
                    if p_name == patient_name:
                        best_match = p_name
                        match_row = p_row
                        highest_similarity = 1.0
                        self.logger.debug(f"ì´ë¦„ ì •í™•íˆ ì¼ì¹˜: {p_name} <-> {patient_name}")
                        break
                    
                    # ê¸°ì¡´ ìœ ì‚¬ë„ ë¹„êµ ë¡œì§ ìœ ì§€ (ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
                    similarity = name_similarity(p_name, patient_name)
                    if similarity > highest_similarity and similarity >= 0.8:  # 80% ì´ìƒ ìœ ì‚¬ë„
                        highest_similarity = similarity
                        best_match = p_name
                        match_row = p_row
                
                # ì¼ì¹˜í•˜ëŠ” í™˜ì ì •ë³´ê°€ ìˆì„ ê²½ìš°
                if best_match:
                    self.logger.debug(f"í™˜ì '{patient_name}'ì˜ ë§¤ì¹­ ê²°ê³¼: '{best_match}' (ìœ ì‚¬ë„: {highest_similarity:.2f})")
                    self.logger.debug(f"ë§¤ì¹˜ëœ í–‰: {match_row}")
                    
                    # í™˜ì ëª…ì„ ì›ë˜ ì´ë¦„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì´ˆì„±/ì´ë‹ˆì…œ ë³€í™˜ ì œê±°)
                    wb['Sales'].cell(row=c_row_idx, column=patient_name_idx).value = best_match
                    self.logger.debug(f"í™˜ì ëª… ì›ë³¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©: {best_match}")
                    
                    # ê³ ê°ê´€ë¦¬ í…Œì´ë¸”ì— í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸
                    birth_year = None
                    gender = None
                    state = None
                    
                    # ìƒë…„ ì»¬ëŸ¼ì—ì„œ ì—°ë„ ê°€ì ¸ì˜¤ê¸°
                    if p_dob_col is not None:
                        birth_date = wb['Patients'].cell(row=match_row, column=p_min_col + p_dob_col).value
                        if birth_date:
                            try:
                                # ì´ë¯¸ ìˆ«ìì¸ ê²½ìš° (ì—°ë„ë§Œ ìˆëŠ” ê²½ìš°)
                                if isinstance(birth_date, (int, float)) and 1900 <= birth_date <= 2100:
                                    birth_year = int(birth_date)
                                # ê·¸ ì™¸ ê²½ìš°ëŠ” ë¬¸ìì—´ì´ë‚˜ ë‚ ì§œ ê°ì²´ì¼ ìˆ˜ ìˆìŒ
                                else:
                                    self.logger.debug(f"ìƒë…„ ë°ì´í„° í˜•ì‹: {type(birth_date)}, ê°’: {birth_date}")
                                    # ë¬¸ìì—´ì´ë©´ ì§ì ‘ ì •ìˆ˜ë¡œ ë³€í™˜ ì‹œë„
                                    if isinstance(birth_date, str) and birth_date.isdigit():
                                        birth_year = int(birth_date)
                                    else:
                                        # ê°ì²´ê°€ ë‚ ì§œ í˜•ì‹ì´ë©´ ì—°ë„ ì¶”ì¶œ
                                        try:
                                            if isinstance(birth_date, datetime):
                                                birth_year = birth_date.year
                                            else:
                                                # ë‹¤ë¥¸ í˜•ì‹ì´ë©´ ë³€í™˜ ì‹œë„
                                                dt = pd.to_datetime(birth_date, errors='coerce')
                                                if pd.notnull(dt):
                                                    birth_year = dt.year
                                        except:
                                            self.logger.warning(f"ìƒë…„ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: {birth_date}")
                            except Exception as e:
                                self.logger.error(f"ìƒë…„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
                    
                    if p_gender_col is not None:
                        gender = wb['Patients'].cell(row=match_row, column=p_min_col + p_gender_col).value
                        # ì˜ë¬¸ ì„±ë³„ì„ í•œê¸€ë¡œ ë³€í™˜
                        if gender:
                            gender = str(gender).strip()
                            if gender.lower() in ['male', 'm']:
                                gender = 'ë‚¨'
                            elif gender.lower() in ['female', 'f']:
                                gender = 'ì—¬'
                    
                    if p_state_col is not None:
                        state = wb['Patients'].cell(row=match_row, column=p_min_col + p_state_col).value
                    
                    # ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                    self.logger.debug(f"í™˜ì {best_match}ì˜ ìƒë…„: {birth_date}, ì¶”ì¶œ ì—°ë„: {birth_year}")
                    self.logger.debug(f"í™˜ì {best_match}ì˜ ì„±ë³„: {gender}")
                    self.logger.debug(f"í™˜ì {best_match}ì˜ í˜„ì¬ ìˆëŠ” ì£¼: {state}")
                    
                    # ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸”ì— ì •ë³´ ì—…ë°ì´íŠ¸
                    updated = False
                    
                    # Ages ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
                    if c_age_col is not None and birth_year:
                        age_idx = c_min_col + c_age_col
                        current_age = wb['Sales'].cell(row=c_row_idx, column=age_idx).value
                        
                        # ì…€ì´ ë¹„ì–´ìˆê±°ë‚˜ ê°’ì´ ì—†ëŠ” ê²½ìš° ì—…ë°ì´íŠ¸
                        if not current_age:
                            # ìƒë…„ ì»¬ëŸ¼ ì°¸ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ í–‰ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ì´ ê³„ì‚° ìˆ˜ì‹ ìƒì„±
                            birth_year_idx_letter = get_column_letter(c_min_col + c_birth_year_col)
                            # ì ˆëŒ€ ì°¸ì¡°ë¡œ ìˆ˜ì • (í–‰ì´ ì‚­ì œë˜ì–´ë„ ì°¸ì¡°ê°€ ìœ ì§€ë¨)
                            formula = f"=YEAR(NOW())-{birth_year_idx_letter}{c_row_idx}"
                            wb['Sales'].cell(row=c_row_idx, column=age_idx).value = formula
                            age_updates += 1
                            updated = True
                            self.logger.debug(f"Ages ì—…ë°ì´íŠ¸: ìˆ˜ì‹ {formula}")
                    
                    # ìƒë…„ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
                    if c_birth_year_col is not None and birth_year:
                        wb['Sales'].cell(row=c_row_idx, column=c_min_col + c_birth_year_col).value = birth_year
                        birth_year_updates += 1
                        updated = True
                        self.logger.debug(f"ìƒë…„ ì—…ë°ì´íŠ¸: {birth_year}")
                    
                    # ì„±ë³„ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
                    if c_gender_col is not None and gender:
                        gender_idx = c_min_col + c_gender_col
                        current_gender = wb['Sales'].cell(row=c_row_idx, column=gender_idx).value
                        
                        # ì…€ì´ ë¹„ì–´ìˆê±°ë‚˜ ê°’ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                        if not current_gender or str(current_gender).strip() == '':
                            wb['Sales'].cell(row=c_row_idx, column=gender_idx).value = gender
                            gender_updates += 1
                            updated = True
                            self.logger.info(f"ì„±ë³„ ì—…ë°ì´íŠ¸: {patient_name}, {gender}")
                        else:
                            self.logger.info(f"ì„±ë³„ ê°’ì´ ì´ë¯¸ ì¡´ì¬í•¨ ({patient_name}): '{current_gender}' - ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€")
                            if 'gender_skipped_count' in locals():
                                gender_skipped_count += 1  # ìŠ¤í‚µ ì¹´ìš´í„° ì¦ê°€
                    
                    # States ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
                    if c_state_col is not None and state:
                        state_idx = c_min_col + c_state_col
                        current_state = wb['Sales'].cell(row=c_row_idx, column=state_idx).value
                        
                        # ì…€ì´ ë¹„ì–´ìˆê±°ë‚˜ ê°’ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                        if not current_state or str(current_state).strip() == '':
                            wb['Sales'].cell(row=c_row_idx, column=state_idx).value = state
                            state_updates += 1
                            updated = True
                            self.logger.info(f"States ì—…ë°ì´íŠ¸: {patient_name}, í˜„ì¬ ìˆëŠ” ì£¼ = {state}")
                        else:
                            self.logger.info(f"States ê°’ì´ ì´ë¯¸ ì¡´ì¬í•¨ ({patient_name}): '{current_state}' - ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€")
                            if 'state_skipped_count' in locals():
                                state_skipped_count += 1  # ìŠ¤í‚µ ì¹´ìš´í„° ì¦ê°€
                    
                    if updated:
                        update_count += 1
                else:
                    self.logger.warning(f"í™˜ì '{patient_name}'ì˜ ë§¤ì¹­ ê²°ê³¼ ì—†ìŒ")
                
                # Check if all fields are already filled
                has_all_data = True
            
            # ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€í™˜ ë° ê°€ìš´ë° ì •ë ¬
            date_format_updates = 0
            if p_reg_date_col is not None:
                self.logger.info("ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€í™˜ ì‘ì—… ì‹œì‘...")
                for p_row in range(p_min_row + 1, p_max_row + 1):
                    reg_date = wb['Patients'].cell(row=p_row, column=p_reg_date_col + p_min_col).value
                    if reg_date:
                        try:
                            # ì´ë¯¸ í˜•ì‹ì´ 'ë…„ ì›” ì¼' í˜•íƒœì¸ì§€ í™•ì¸
                            if isinstance(reg_date, str) and "ë…„" in reg_date and "ì›”" in reg_date and "ì¼" in reg_date:
                                continue
                                
                            # '7ì›” 15, 2024' í˜•ì‹ ì²˜ë¦¬
                            if isinstance(reg_date, str) and "ì›”" in reg_date and "," in reg_date:
                                try:
                                    # ì›”, ì¼, ì—°ë„ ì¶”ì¶œ
                                    month = int(reg_date.split("ì›”")[0])
                                    day = int(reg_date.split(",")[0].split("ì›”")[1].strip())
                                    year = int(reg_date.split(",")[1].strip())
                                    dt = pd.Timestamp(year=year, month=month, day=day)
                                except:
                                    dt = pd.to_datetime(reg_date, errors='coerce')
                            else:
                                dt = pd.to_datetime(reg_date, errors='coerce')
                            
                            if pd.notnull(dt):
                                formatted_date = f"{dt.year}ë…„ {dt.month}ì›” {dt.day}ì¼"
                                wb['Patients'].cell(row=p_row, column=p_reg_date_col + p_min_col).value = formatted_date
                                date_format_updates += 1
                                self.logger.debug(f"ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€í™˜: {reg_date} â†’ {formatted_date}")
                        except Exception as e:
                            self.logger.warning(f"ë“±ë¡ ë‚ ì§œ ì²˜ë¦¬ ì˜¤ë¥˜ ({p_row}í–‰): {str(e)}")
                
                self.logger.info(f"ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€í™˜ ì™„ë£Œ: ì´ {date_format_updates}ê±´")
            
            # Save workbook
            self.logger.info("ì—…ë°ì´íŠ¸ëœ ë‚´ìš© ì €ì¥ ì¤‘...")
            
            # í™˜ë¶ˆ ì²˜ë¦¬ (Price Table ì»¬ëŸ¼ì— ìŒìˆ˜ ê°’ì´ ìˆëŠ” í•­ëª© ì²˜ë¦¬)
            if c_price_col is not None and c_patient_name_col is not None and c_doctor_col is not None:
                self.logger.info("í™˜ë¶ˆ ì²˜ë¦¬ ì‘ì—… ì‹œì‘...")
                sales_sheet = wb['Sales']
                refund_rows_to_delete = set()  # ì‚­ì œí•  í–‰ ëª©ë¡
                refund_processed = 0    # í™˜ë¶ˆ ì²˜ë¦¬ëœ ê±´ìˆ˜
                
                # í…Œì´ë¸” ëª¨ë“  í–‰ì„ ìˆœíšŒí•˜ë©° ìŒìˆ˜ ê¸ˆì•¡ ê²€ìƒ‰
                for row in range(c_min_row + 1, c_max_row + 1):
                    price_cell = sales_sheet.cell(row=row, column=c_min_col + c_price_col).value
                    
                    if price_cell and '-' in str(price_cell):
                        # í™˜ìëª…ê³¼ ì˜ì‚¬ëª… ê°€ì ¸ì˜¤ê¸°
                        patient_name = sales_sheet.cell(row=row, column=c_min_col + c_patient_name_col).value
                        doctor_name = sales_sheet.cell(row=row, column=c_min_col + c_doctor_col).value
                        
                        # ê¸ˆì•¡ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ (ë¶€í˜¸ ì œì™¸)
                        price_str = str(price_cell)
                        amount_with_sign = ''.join(c for c in price_str if c.isdigit() or c == '.' or c == '-')
                        
                        try:
                            amount = float(amount_with_sign)
                            absolute_amount = abs(amount)
                            
                            if amount < 0:  # ìŒìˆ˜ ê¸ˆì•¡ì¸ ê²½ìš°
                                self.logger.info(f"ìŒìˆ˜ ê¸ˆì•¡ ê°ì§€: {amount}, í™˜ì: {patient_name}, ì˜ì‚¬ëª…: {doctor_name}")
                                
                                # ë™ì¼ í™˜ìëª…ê³¼ ì˜ì‚¬ëª…ì„ ê°€ì§„ í–‰ ì¤‘ ì ˆëŒ€ê°’ì´ ê°™ì€ ì–‘ìˆ˜ ê¸ˆì•¡ì„ ê°€ì§„ í–‰ ì°¾ê¸°
                                match_row = None
                                
                                # ìµœê·¼ í–‰ë¶€í„° ì—­ìˆœìœ¼ë¡œ ê²€ìƒ‰ (ê°€ì¥ ìµœê·¼ ê²ƒ ë¨¼ì € ì°¾ê¸° ìœ„í•´)
                                for r in range(c_max_row, c_min_row, -1):
                                    if r == row:  # í˜„ì¬ í–‰ì€ ê±´ë„ˆë›°ê¸°
                                        continue
                                        
                                    r_patient = sales_sheet.cell(row=r, column=c_min_col + c_patient_name_col).value
                                    r_doctor = sales_sheet.cell(row=r, column=c_min_col + c_doctor_col).value
                                    r_price = sales_sheet.cell(row=r, column=c_min_col + c_price_col).value
                                    
                                    # í™˜ìëª…ê³¼ ì˜ì‚¬ëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                                    if r_patient == patient_name and r_doctor == doctor_name and r_price:
                                        # ê¸ˆì•¡ ì¶”ì¶œ ë° ë¹„êµ
                                        r_price_str = str(r_price)
                                        r_amount_str = ''.join(c for c in r_price_str if c.isdigit() or c == '.')
                                        
                                        try:
                                            r_amount = float(r_amount_str)
                                            # ì ˆëŒ€ê°’ì´ ê°™ì€ì§€ í™•ì¸ (ë¶€ë™ì†Œìˆ˜ì  ë¹„êµ ì˜¤ì°¨ ê°ì•ˆ)
                                            if abs(r_amount - absolute_amount) < 0.01:
                                                match_row = r
                                                self.logger.info(f"ì‚­ì œí•  í–‰ ì°¾ìŒ: {r}, ê¸ˆì•¡: {r_price}")
                                                break
                                        except (ValueError, TypeError):
                                            continue
                                
                                # ì¼ì¹˜í•˜ëŠ” í–‰ì´ ìˆìœ¼ë©´ ì‚­ì œ ëª©ë¡ì— ì¶”ê°€
                                if match_row:
                                    refund_rows_to_delete.add(match_row)
                                    refund_rows_to_delete.add(row)  # ë§ˆì´ë„ˆìŠ¤ ê¸ˆì•¡ì´ ìˆëŠ” í˜„ì¬ í–‰ë„ ì‚­ì œ
                                    refund_processed += 1
                                else:
                                    self.logger.warning(f"ì‚­ì œí•  í–‰ì„ ì°¾ì§€ ëª»í•¨: í™˜ì {patient_name}, ì˜ì‚¬ëª… {doctor_name}, ê¸ˆì•¡ {absolute_amount}")
                        except (ValueError, TypeError) as e:
                            self.logger.warning(f"ê¸ˆì•¡ ë³€í™˜ ì˜¤ë¥˜: {str(e)}")
                
                # ì‚­ì œí•  í–‰ ëª©ë¡ í™•ì¸
                if refund_rows_to_delete:
                    self.logger.info(f"\n=== í™˜ë¶ˆ ì²˜ë¦¬ë¡œ ì‚­ì œí•  í–‰ ëª©ë¡ ({len(refund_rows_to_delete)}ê°œ) ===")
                    for row in sorted(refund_rows_to_delete):
                        price = sales_sheet.cell(row=row, column=c_min_col + c_price_col).value
                        patient = sales_sheet.cell(row=row, column=c_min_col + c_patient_name_col).value
                        self.logger.info(f"í–‰ {row}: {patient} ({price})")

                    # í–‰ ì‚­ì œ (í° ë²ˆí˜¸ë¶€í„°)
                    for row in sorted(refund_rows_to_delete, reverse=True):
                        sales_sheet.delete_rows(row)
                        self.logger.info(f"í–‰ {row} ì‚­ì œ ì™„ë£Œ")

                    # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸
                    new_max_row = c_max_row - len(refund_rows_to_delete)
                    old_ref = customer_table.ref
                    customer_table.ref = f"{get_column_letter(c_min_col)}{c_min_row}:{get_column_letter(c_max_col)}{new_max_row}"
                    self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸: {old_ref} -> {customer_table.ref}")
                    
                    # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸ í›„ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    c_max_row = new_max_row
                
                # í™˜ë¶ˆ ì²˜ë¦¬ ê²°ê³¼ ë¡œê¹…
                self.logger.info(f"í™˜ë¶ˆ ì²˜ë¦¬ ì™„ë£Œ: ì´ {refund_processed}ê±´, ì‚­ì œëœ í–‰: {len(refund_rows_to_delete)}ê°œ")
                
                # í™˜ë¶ˆ ì²˜ë¦¬ ê²°ê³¼ ì•Œë¦¼ì°½ ì œê±°
                # if refund_processed > 0:
                #     messagebox.showinfo("í™˜ë¶ˆ ì²˜ë¦¬ ì™„ë£Œ", f"í™˜ë¶ˆ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n- ì²˜ë¦¬ëœ í™˜ë¶ˆ ê±´ìˆ˜: {refund_processed}ê±´\n- ì‚­ì œëœ í–‰: {len(refund_rows_to_delete)}ê°œ")
                
            else:
                self.logger.warning("í™˜ë¶ˆ ì²˜ë¦¬ì— í•„ìš”í•œ ì»¬ëŸ¼(ê°€ê²©, í™˜ìëª…, ì˜ì‚¬ëª…)ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ í™˜ë¶ˆ ì²˜ë¦¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
            
            # ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ë¹ˆ í–‰ ì‚­ì œ ì²˜ë¦¬
            self.logger.info("ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ë¹ˆ í–‰ ì‚­ì œ ì‘ì—… ì‹œì‘...")
            sales_sheet = wb['Sales']
            empty_sales_rows_to_delete = set()  # ì‚­ì œí•  ë¹ˆ í–‰ ëª©ë¡
            
            # í…Œì´ë¸” ëª¨ë“  í–‰ì„ ìˆœíšŒí•˜ë©° ë¹ˆ í–‰ ê²€ìƒ‰
            total_rows = 0
            for row in range(c_min_row + 1, c_max_row + 1):
                total_rows += 1
                is_empty_row = True
                for col in range(c_min_col, c_max_col + 1):
                    cell_value = sales_sheet.cell(row=row, column=col).value
                    if cell_value is not None and str(cell_value).strip() != '':
                        is_empty_row = False
                        break
                
                if is_empty_row:
                    empty_sales_rows_to_delete.add(row)
                    self.logger.info(f"ê³ ê°ê´€ë¦¬ìë™ ë¹ˆ í–‰ ê°ì§€: {row}")
            
            # ë¹ˆ í–‰ ì‚­ì œ (í…Œì´ë¸”ì— ë¹ˆ í–‰ë§Œ ì¡´ì¬í•˜ëŠ” ê²½ìš°ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ)
            empty_sales_rows_deleted = 0
            if empty_sales_rows_to_delete and len(empty_sales_rows_to_delete) < total_rows:
                self.logger.info(f"\n=== ì‚­ì œí•  ê³ ê°ê´€ë¦¬ìë™ ë¹ˆ í–‰ ëª©ë¡ ({len(empty_sales_rows_to_delete)}ê°œ) ===")
                for row in sorted(empty_sales_rows_to_delete):
                    self.logger.info(f"ë¹ˆ í–‰: {row}")
                
                # í° ë²ˆí˜¸ë¶€í„° í–‰ ì‚­ì œ
                for row in sorted(empty_sales_rows_to_delete, reverse=True):
                    sales_sheet.delete_rows(row)
                    self.logger.info(f"ë¹ˆ í–‰ {row} ì‚­ì œ ì™„ë£Œ")
                    empty_sales_rows_deleted += 1
                
                # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸
                if empty_sales_rows_deleted > 0:
                    new_max_row = c_max_row - empty_sales_rows_deleted
                    old_ref = customer_table.ref
                    customer_table.ref = f"{get_column_letter(c_min_col)}{c_min_row}:{get_column_letter(c_max_col)}{new_max_row}"
                    self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸: {old_ref} -> {customer_table.ref}")
                    
                    # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸ í›„ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    c_max_row = new_max_row
                    
                    # ë¹ˆ í–‰ ì‚­ì œ í›„ ìˆ˜ì‹ ì¬ì ìš© - ëª¨ë“  Ages ì—´ì˜ ìˆ˜ì‹ì„ ë‹¤ì‹œ ê²€ì‚¬í•˜ê³  ì—…ë°ì´íŠ¸
                    if c_age_col is not None and c_birth_year_col is not None:
                        self.logger.info("ë¹ˆ í–‰ ì‚­ì œ í›„ Ages ìˆ˜ì‹ ì¬ì¡°ì • ì‹œì‘...")
                        formula_fixes = 0
                        
                        for row in range(c_min_row + 1, c_max_row + 1):
                            # ìƒë…„ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
                            birth_year_cell = sales_sheet.cell(row=row, column=c_min_col + c_birth_year_col)
                            if birth_year_cell.value:
                                age_cell = sales_sheet.cell(row=row, column=c_min_col + c_age_col)
                                current_formula = age_cell.value
                                
                                # ìˆ˜ì‹ì´ ìˆì§€ë§Œ í–‰ ì°¸ì¡°ê°€ ë§ì§€ ì•Šê±°ë‚˜ ìˆ˜ì‹ì´ ì—†ëŠ” ê²½ìš° ì—…ë°ì´íŠ¸
                                if current_formula is None or (isinstance(current_formula, str) and "YEAR(NOW())" in current_formula):
                                    birth_year_idx_letter = get_column_letter(c_min_col + c_birth_year_col)
                                    new_formula = f"=YEAR(NOW())-{birth_year_idx_letter}{row}"
                                    age_cell.value = new_formula
                                    formula_fixes += 1
                                    self.logger.debug(f"Ages ìˆ˜ì‹ ì¬ì¡°ì •: í–‰ {row}, ìˆ˜ì‹ {new_formula}")
                        
                        self.logger.info(f"Ages ìˆ˜ì‹ ì¬ì¡°ì • ì™„ë£Œ: ì´ {formula_fixes}ê±´ ìˆ˜ì •ë¨")
            elif len(empty_sales_rows_to_delete) == total_rows:
                self.logger.info("í…Œì´ë¸”ì— ë¹ˆ í–‰ë§Œ ì¡´ì¬í•˜ì—¬ ì‚­ì œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
            
            # ë¹ˆ í–‰ ì‚­ì œ ê²°ê³¼ ë¡œê¹…
            self.logger.info(f"ê³ ê°ê´€ë¦¬ìë™ ë¹ˆ í–‰ ì‚­ì œ ì™„ë£Œ: ì´ {empty_sales_rows_deleted}ê°œ í–‰ ì‚­ì œë¨")
            
            # í™˜ììë™ í…Œì´ë¸” ë¹ˆ í–‰ ì‚­ì œ ì²˜ë¦¬
            self.logger.info("í™˜ììë™ í…Œì´ë¸” ë¹ˆ í–‰ ì‚­ì œ ì‘ì—… ì‹œì‘...")
            patients_sheet = wb['Patients']
            empty_patients_rows_to_delete = set()  # ì‚­ì œí•  ë¹ˆ í–‰ ëª©ë¡
            
            # í…Œì´ë¸” ëª¨ë“  í–‰ì„ ìˆœíšŒí•˜ë©° ë¹ˆ í–‰ ê²€ìƒ‰
            total_rows = 0
            for row in range(p_min_row + 1, p_max_row + 1):
                total_rows += 1
                is_empty_row = True
                for col in range(p_min_col, p_max_col + 1):
                    cell_value = patients_sheet.cell(row=row, column=col).value
                    if cell_value is not None and str(cell_value).strip() != '':
                        is_empty_row = False
                        break
                
                if is_empty_row:
                    empty_patients_rows_to_delete.add(row)
                    self.logger.info(f"í™˜ììë™ ë¹ˆ í–‰ ê°ì§€: {row}")
            
            # ë¹ˆ í–‰ ì‚­ì œ (í…Œì´ë¸”ì— ë¹ˆ í–‰ë§Œ ì¡´ì¬í•˜ëŠ” ê²½ìš°ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ)
            empty_patients_rows_deleted = 0
            if empty_patients_rows_to_delete and len(empty_patients_rows_to_delete) < total_rows:
                self.logger.info(f"\n=== ì‚­ì œí•  í™˜ììë™ ë¹ˆ í–‰ ëª©ë¡ ({len(empty_patients_rows_to_delete)}ê°œ) ===")
                for row in sorted(empty_patients_rows_to_delete):
                    self.logger.info(f"ë¹ˆ í–‰: {row}")
                
                # í° ë²ˆí˜¸ë¶€í„° í–‰ ì‚­ì œ
                for row in sorted(empty_patients_rows_to_delete, reverse=True):
                    patients_sheet.delete_rows(row)
                    self.logger.info(f"ë¹ˆ í–‰ {row} ì‚­ì œ ì™„ë£Œ")
                    empty_patients_rows_deleted += 1
                
                # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸
                if empty_patients_rows_deleted > 0:
                    new_max_row = p_max_row - empty_patients_rows_deleted
                    old_ref = patient_table.ref
                    patient_table.ref = f"{get_column_letter(p_min_col)}{p_min_row}:{get_column_letter(p_max_col)}{new_max_row}"
                    self.logger.info(f"í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸: {old_ref} -> {patient_table.ref}")
                    
                    # í…Œì´ë¸” ë²”ìœ„ ì—…ë°ì´íŠ¸ í›„ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    p_max_row = new_max_row
            elif len(empty_patients_rows_to_delete) == total_rows:
                self.logger.info("í…Œì´ë¸”ì— ë¹ˆ í–‰ë§Œ ì¡´ì¬í•˜ì—¬ ì‚­ì œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
            
            # ë¹ˆ í–‰ ì‚­ì œ ê²°ê³¼ ë¡œê¹…
            self.logger.info(f"í™˜ììë™ ë¹ˆ í–‰ ì‚­ì œ ì™„ë£Œ: ì´ {empty_patients_rows_deleted}ê°œ í–‰ ì‚­ì œë¨")
            
            # í™˜ììë™ í…Œì´ë¸”ì— ë‚˜ì´ ê³„ì‚° ê³µì‹ ì¶”ê°€
            if p_age_col is not None and p_dob_col is not None:
                self.logger.info("í™˜ììë™ í…Œì´ë¸”ì˜ ë‚˜ì´ ê³„ì‚° ê³µì‹ ì—…ë°ì´íŠ¸ ì‹œì‘...")
                age_formula_updates = 0
                
                for row in range(p_min_row + 1, p_max_row + 1):
                    # ìƒë…„ ì»¬ëŸ¼ì˜ ê°’ì´ ìˆì„ ë•Œë§Œ ê³µì‹ ì¶”ê°€
                    birth_year = patients_sheet.cell(row=row, column=p_min_col + p_dob_col).value
                    if birth_year:
                        age_cell = patients_sheet.cell(row=row, column=p_min_col + p_age_col)
                        # í…Œì´ë¸” ì°¸ì¡° í˜•ì‹ì˜ ê³µì‹ ì‚¬ìš©
                        birth_col_letter = get_column_letter(p_min_col + p_dob_col)
                        
                        # ìš”ì²­í•œ ê³µì‹ ì ìš©: =DATEDIF(DATE(VALUE(RIGHT([@ìƒë…„],4)),1,1), TODAY(), "Y")
                        # í…Œì´ë¸” ì°¸ì¡° ë°©ì‹ìœ¼ë¡œ [@ì»¬ëŸ¼ëª…] ëŒ€ì‹  ì‹¤ì œ ì…€ ì°¸ì¡°ë¡œ ë³€í™˜
                        formula = f'=DATEDIF(DATE(VALUE(RIGHT({birth_col_letter}{row},4)),1,1), TODAY(), "Y")'
                        
                        # ê³µì‹ì´ ì—†ê±°ë‚˜ ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° ì—…ë°ì´íŠ¸
                        current_formula = age_cell.value
                        if not current_formula or (isinstance(current_formula, str) and not current_formula.startswith('=DATEDIF')):
                            age_cell.value = formula
                            age_formula_updates += 1
                
                self.logger.info(f"í™˜ììë™ í…Œì´ë¸” ë‚˜ì´ ê³„ì‚° ê³µì‹ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì´ {age_formula_updates}ê±´")
                
                # Age_Range ì—´ ì—…ë°ì´íŠ¸
                self.logger.info("í™˜ììë™ í…Œì´ë¸”ì˜ Age_Range ê³µì‹ ì—…ë°ì´íŠ¸ ì‹œì‘...")
                age_range_col = None
                age_range_formula_updates = 0
                
                # Age_Range ì—´ ì°¾ê¸°
                for i, header in enumerate(patient_headers):
                    if header == "Age_Range":
                        age_range_col = i
                        break
                
                if age_range_col is not None:
                    age_col_letter = get_column_letter(p_min_col + p_age_col)
                    
                    for row in range(p_min_row + 1, p_max_row + 1):
                        # ë‚˜ì´ ì…€ì— ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ Age_Range ì—…ë°ì´íŠ¸
                        age_value = patients_sheet.cell(row=row, column=p_min_col + p_age_col).value
                        if age_value:
                            age_range_cell = patients_sheet.cell(row=row, column=p_min_col + age_range_col)
                            
                            # ìš”ì²­í•œ Age_Range ê³µì‹ ì ìš©
                            lookup_formula = f'=LOOKUP({age_col_letter}{row},{{0,20,30,40,50,60,70}},{{"10s","20s","30s","40s","50s","60s","70s+"}})'
                            
                            # ê³µì‹ì´ ì—†ê±°ë‚˜ LOOKUP í•¨ìˆ˜ê°€ ì•„ë‹Œ ê²½ìš° ì—…ë°ì´íŠ¸
                            current_formula = age_range_cell.value
                            if not current_formula or (isinstance(current_formula, str) and not current_formula.startswith('=LOOKUP')):
                                age_range_cell.value = lookup_formula
                                age_range_formula_updates += 1
                    
                    self.logger.info(f"í™˜ììë™ í…Œì´ë¸” Age_Range ê³µì‹ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì´ {age_range_formula_updates}ê±´")
                else:
                    self.logger.warning("í™˜ììë™ í…Œì´ë¸”ì—ì„œ Age_Range ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ Age_Range ê³„ì‚° ê³µì‹ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
            else:
                self.logger.warning("í™˜ììë™ í…Œì´ë¸”ì—ì„œ ë‚˜ì´ ë˜ëŠ” ìƒë…„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ë‚˜ì´ ê³„ì‚° ê³µì‹ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
            
            # ìµœì¢… ê°€ìš´ë° ì •ë ¬ ì ìš© - ì €ì¥ ì§ì „ì— ì‹¤í–‰
            self.logger.info("ëª¨ë“  í…Œì´ë¸”ì— ê°€ìš´ë° ì •ë ¬ ìµœì¢… ì ìš© ì¤‘...")
            center_alignment = Alignment(horizontal='center', vertical='center')
            
            # í™˜ììë™ í…Œì´ë¸” ê°€ìš´ë° ì •ë ¬ (ëª…ì‹œì  ì‹œíŠ¸ëª… ì‚¬ìš©)
            patients_aligned = 0
            patients_sheet = wb['Patients']
            self.logger.debug(f"í™˜ììë™ í…Œì´ë¸” ë²”ìœ„: í–‰({p_min_row}~{p_max_row}), ì—´({p_min_col}~{p_max_col})")
            
            try:
                for row in range(p_min_row, p_max_row + 1):
                    for col in range(p_min_col, p_max_col + 1):
                        cell = patients_sheet.cell(row=row, column=col)
                        # ëª¨ë“  ì…€ì— ê°•ì œë¡œ ê°€ìš´ë° ì •ë ¬ ì ìš©
                        cell.alignment = center_alignment
                        patients_aligned += 1
                self.logger.info(f"í™˜ììë™ í…Œì´ë¸” ê°€ìš´ë° ì •ë ¬ ì™„ë£Œ: {patients_aligned}ê°œ ì…€")
            except Exception as e:
                self.logger.error(f"í™˜ììë™ í…Œì´ë¸” ê°€ìš´ë° ì •ë ¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                self.logger.error(traceback.format_exc())
            
            # ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ê°€ìš´ë° ì •ë ¬
            customers_aligned = 0
            sales_sheet = wb['Sales']
            
            try:
                for row in range(c_min_row, c_max_row + 1):
                    for col in range(c_min_col, c_max_col + 1):
                        cell = sales_sheet.cell(row=row, column=col)
                        # ëª¨ë“  ì…€ì— ê°•ì œë¡œ ê°€ìš´ë° ì •ë ¬ ì ìš©
                        cell.alignment = center_alignment
                        customers_aligned += 1
                self.logger.info(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ê°€ìš´ë° ì •ë ¬ ì™„ë£Œ: {customers_aligned}ê°œ ì…€")
                self.logger.info("â€» ëª¨ë“  ë°ì´í„°ê°€ ê°€ìš´ë° ì •ë ¬ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")
            except Exception as e:
                self.logger.error(f"ê³ ê°ê´€ë¦¬ìë™ í…Œì´ë¸” ê°€ìš´ë° ì •ë ¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                self.logger.error(traceback.format_exc())
            
            wb.save(main_file)
            self.logger.info(f"íŒŒì¼ ì €ì¥ ì™„ë£Œ: {main_file}")
            
            # íŒŒì¼ ê°ì§€ ë‹¤ì‹œ ì‹¤í–‰
            self.update_file_labels()
            
            # ì—…ë°ì´íŠ¸ ìš”ì•½ ì •ë³´
            summary = f"í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì´ {update_count}ê±´\n"
            summary += f"- Ages ì—…ë°ì´íŠ¸: {age_updates}ê±´\n"
            summary += f"- ì„±ë³„ ì—…ë°ì´íŠ¸: {gender_updates}ê±´ (ê¸°ì¡´ ê°’ ìˆìŒ: {gender_skipped_count}ê±´)\n"
            summary += f"- States ì—…ë°ì´íŠ¸: {state_updates}ê±´ (ê¸°ì¡´ ê°’ ìˆìŒ: {state_skipped_count}ê±´)\n"
            summary += f"- ë“±ë¡ ë‚ ì§œ í˜•ì‹ ë³€í™˜: {date_format_updates}ê±´\n"
            if 'refund_processed' in locals() and refund_processed > 0:
                summary += f"- í™˜ë¶ˆ ì²˜ë¦¬: {refund_processed}ê±´ (ì‚­ì œëœ í–‰: {len(refund_rows_to_delete) if 'refund_rows_to_delete' in locals() else 0}ê°œ)\n"
            if 'empty_sales_rows_deleted' in locals() and empty_sales_rows_deleted > 0:
                summary += f"- ê³ ê°ê´€ë¦¬ìë™ ë¹ˆ í–‰ ì‚­ì œ: {empty_sales_rows_deleted}ê°œ\n"
            if 'empty_patients_rows_deleted' in locals() and empty_patients_rows_deleted > 0:
                summary += f"- í™˜ììë™ ë¹ˆ í–‰ ì‚­ì œ: {empty_patients_rows_deleted}ê°œ\n"
            if 'age_formula_updates' in locals() and age_formula_updates > 0:
                summary += f"- í™˜ììë™ ë‚˜ì´ ê³„ì‚° ê³µì‹ ì—…ë°ì´íŠ¸: {age_formula_updates}ê±´\n"
            if 'age_range_formula_updates' in locals() and age_range_formula_updates > 0:
                summary += f"- í™˜ììë™ Age_Range ê³„ì‚° ê³µì‹ ì—…ë°ì´íŠ¸: {age_range_formula_updates}ê±´\n"
            summary += f"- ê±´ë„ˆë›´ í•­ëª© (ì´ë¯¸ ë°ì´í„° ìˆìŒ): {skipped_count}ê±´\n"
            summary += f"- ëª¨ë“  í‘œ ë°ì´í„° ê°€ìš´ë° ì •ë ¬ ì ìš©ë¨"
            
            self.logger.info(summary.replace('\n', ' | '))
            messagebox.showinfo("ì²˜ë¦¬ ì™„ë£Œ", summary)
            
            # Ask if user wants to open the file
            if messagebox.askyesno("ì‘ì—… ì™„ë£Œ", "ì—‘ì…€ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                subprocess.Popen([main_file], shell=True)
                
        except Exception as e:
            error_msg = f"í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}\n\n{traceback.format_exc()}"
            self.logger.error(error_msg)
            messagebox.showerror("ì˜¤ë¥˜", f"í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        finally:
            self.enable_buttons()
    
    def update_sheets(self):
        """Update Excel sheets with new info or format"""
        self.logger.info("ì—‘ì…€ ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘...")
        
        # ì´ˆê¸°í™”
        tables_to_update = []
        valid_tables = 0
        updated_tables = 0
        skipped_tables = 0
        error_tables = 0
        error_messages = []
        show_excel_confirmation = True  # ì—‘ì…€ í™•ì¸ ì—¬ë¶€ ì°½ì„ í‘œì‹œí• ì§€ ì—¬ë¶€
        
        try:
            # ë©”ì¸ íŒŒì¼ ì°¾ê¸°
            main_file = self.find_main_file()
            if not main_file:
                self.logger.error("ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                messagebox.showerror("ì˜¤ë¥˜", "ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê°ì§€ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
                self.enable_buttons()
                return "ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            # ë©”ì¸ íŒŒì¼ ê²½ë¡œ
            file_path = main_file  # ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
            
            self.logger.info(f"ë©”ì¸ íŒŒì¼ ê²½ë¡œ: {file_path}")
            
            # í•„ìš”í•œ íŒŒì¼ì´ í•˜ë‚˜ë„ ì—†ëŠ” ê²½ìš° ê²½ê³ 
            patients_file = self.find_file('patients')
            payment_file = self.find_file('paymentitems')
            
            if not patients_file and not payment_file:
                messagebox.showwarning("íŒŒì¼ ì—†ìŒ", "Patients íŒŒì¼ê³¼ PaymentItems íŒŒì¼ì´ ëª¨ë‘ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ê°ì§€ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
                self.enable_buttons()
                return
                
            # Check if main file is accessible
            if not self.check_file_access(main_file):
                messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì´ ì—´ë ¤ìˆê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”: {main_file}")
                self.enable_buttons()
                return
                
            # Create backup
            try:
                backup_dir = os.path.join(os.path.dirname(main_file), "BACK UP")
                os.makedirs(backup_dir, exist_ok=True)
                backup_file = os.path.join(backup_dir, f"BACKUP_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{os.path.basename(main_file)}")
                self.logger.info(f"ë°±ì—… í´ë” ìƒì„±/í™•ì¸: {backup_dir}")
                self.logger.info(f"ë°±ì—… íŒŒì¼ ìƒì„± ì‹œë„: {backup_file}")
                shutil.copy2(main_file, backup_file)
                self.logger.info(f"ë©”ì¸ íŒŒì¼ ë°±ì—… ìƒì„± ì™„ë£Œ: {backup_file}")
            except Exception as e:
                self.logger.error(f"ë°±ì—… ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                if not os.path.exists(main_file):
                    self.logger.error(f"ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {main_file}")
                    messagebox.showerror("ì˜¤ë¥˜", f"ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {main_file}")
                    self.enable_buttons()
                    return
                else:
                    self.logger.warning("ë°±ì—… ìƒì„±ì€ ì‹¤íŒ¨í–ˆì§€ë§Œ ë©”ì¸ íŒŒì¼ì€ ì¡´ì¬í•¨. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
            
            # Process Patients file first
            if patients_file:
                self.process_patients_file(main_file, patients_file)
            else:
                self.logger.warning("Patients íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                
            # Then process Payment Items file
            if payment_file:
                self.process_payment_items(main_file, payment_file)
            else:
                self.logger.warning("PaymentItems íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            
            # í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì—¬ë¶€ í™•ì¸
            if messagebox.askyesno("í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸", "í™˜ì ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                self.update_patient_info()
                show_excel_confirmation = False  # í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ì—ì„œ ì´ë¯¸ í™•ì¸ ì°½ì„ í‘œì‹œí–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
            
            # ì‹œíŠ¸ ì—…ë°ì´íŠ¸ í›„ ê°€ìš´ë° ì •ë ¬ ì ìš© ì¶”ê°€
            self.logger.info("ëª¨ë“  ì‹œíŠ¸ì— ê°€ìš´ë° ì •ë ¬ ì ìš© ì¤‘...")
            
            try:
                # ì›Œí¬ë¶ ë¡œë“œ
                wb = load_workbook(file_path)
                center_alignment = Alignment(horizontal='center', vertical='center')
                
                # ê° ì›Œí¬ì‹œíŠ¸ í™•ì¸
                for sheet_name in wb.sheetnames:
                    sheet = wb[sheet_name]
                    self.logger.debug(f"ì‹œíŠ¸ '{sheet_name}' ê°€ìš´ë° ì •ë ¬ ì ìš© ì¤‘...")
                    
                    # ë°ì´í„°ê°€ ìˆëŠ” ë²”ìœ„ í™•ì¸
                    min_row = 1
                    min_col = 1
                    max_row = sheet.max_row
                    max_col = sheet.max_column
                    
                    # ëª¨ë“  ì…€ì— ê°€ìš´ë° ì •ë ¬ ì ìš©
                    align_count = 0
                    for row in range(min_row, max_row + 1):
                        for col in range(min_col, max_col + 1):
                            cell = sheet.cell(row=row, column=col)
                            # ëª¨ë“  ì…€ì— ê°•ì œë¡œ ê°€ìš´ë° ì •ë ¬ ì ìš©
                            cell.alignment = center_alignment
                            align_count += 1
                    
                    self.logger.info(f"ì‹œíŠ¸ '{sheet_name}' ê°€ìš´ë° ì •ë ¬ ì™„ë£Œ: {align_count}ê°œ ì…€")
                
                # ìˆ˜ì •ëœ ì›Œí¬ë¶ ì €ì¥
                wb.save(file_path)
                self.logger.info(f"ê°€ìš´ë° ì •ë ¬ ì ìš© ë° íŒŒì¼ ì €ì¥ ì™„ë£Œ: {file_path}")
            
            except Exception as e:
                error_msg = f"ê°€ìš´ë° ì •ë ¬ ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
                self.logger.error(error_msg)
                self.logger.error(traceback.format_exc())
                error_messages.append(error_msg)
                
            # íŒŒì¼ ê°ì§€ ë‹¤ì‹œ ì‹¤í–‰
            self.update_file_labels()
            
            # í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ì—ì„œ ì´ë¯¸ í™•ì¸ ì°½ì„ í‘œì‹œí•˜ì§€ ì•Šì•˜ì„ ê²½ìš°ì—ë§Œ í‘œì‹œ
            if show_excel_confirmation and messagebox.askyesno("ì‘ì—… ì™„ë£Œ", "ì—‘ì…€ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                subprocess.Popen([main_file], shell=True)
                
        except Exception as e:
            error_msg = f"í‘œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}\n\n{traceback.format_exc()}"
            self.logger.error(error_msg)
            messagebox.showerror("ì˜¤ë¥˜", f"í‘œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        finally:
            self.enable_buttons()
        
        # ì—…ë°ì´íŠ¸ ê²°ê³¼ ìš”ì•½
        summary = "ì—‘ì…€ íŒŒì¼ ì—…ë°ì´íŠ¸ ê²°ê³¼ ìš”ì•½:\n"
        summary += f"- í…Œì´ë¸” ì²˜ë¦¬: {len(tables_to_update)}ê°œ\n"
        summary += f"- ìœ íš¨í•œ í…Œì´ë¸”: {valid_tables}ê°œ\n"
        summary += f"- ì—…ë°ì´íŠ¸ëœ í…Œì´ë¸”: {updated_tables}ê°œ\n"
        summary += f"- ìŠ¤í‚µëœ í…Œì´ë¸”: {skipped_tables}ê°œ\n"
        summary += f"- ì—ëŸ¬ ë°œìƒ í…Œì´ë¸”: {error_tables}ê°œ\n"
        summary += f"- ëª¨ë“  ì‹œíŠ¸ ê°€ìš´ë° ì •ë ¬ ì™„ë£Œ\n"
        
        if error_messages:
            summary += "\nì˜¤ë¥˜ ì„¸ë¶€ ì •ë³´:\n"
            for error in error_messages:
                summary += f"- {error}\n"
        
        self.logger.info(summary)
        return summary
    
    def on_update_click(self):
        """Handle update button click"""
        # ë²„íŠ¼ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ í•„ìš”í•œ íŒŒì¼ì´ ì´ë¯¸ ê°ì§€ëœ ìƒíƒœ
        # ë°”ë¡œ ì²˜ë¦¬ ì§„í–‰
        self.disable_buttons("â³ ì²˜ë¦¬ ì¤‘...")
        threading.Thread(target=self.update_sheets, daemon=True).start()
        
    def on_patient_click(self):
        """Handle patient info update button click"""
        self.disable_buttons("â³ í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘...")
        
        # í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì „ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        if messagebox.askyesno("í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸", "í™˜ì ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            threading.Thread(target=self.update_patient_info, daemon=True).start()
        else:
            self.enable_buttons()
        
    def on_exit_click(self):
        """ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬"""
        self.logger.info("ì¢…ë£Œ ë²„íŠ¼ í´ë¦­")
        # on_closing ë©”ì„œë“œ í˜¸ì¶œí•˜ì—¬ ì¢…ë£Œ ì²˜ë¦¬
        self.on_closing()
    
    def disable_buttons(self, processing_text):
        """Disable all buttons during processing"""
        # ê¸°ëŠ¥ ë²„íŠ¼ë§Œ ë¹„í™œì„±í™” (ì¢…ë£Œ ë²„íŠ¼ê³¼ íŒŒì¼ ê°ì§€ ë²„íŠ¼ì€ ì œì™¸)
        self.update_tables_btn.configure(state=tk.DISABLED)
        self.update_patient_btn.configure(state=tk.DISABLED)
        
        self.status_label.config(text=processing_text, fg="purple")
        self.progress_bar.start(10)  # ì§„í–‰ í‘œì‹œì¤„ ì‹œì‘
        self.root.update()  # UI ì—…ë°ì´íŠ¸ ê°•ì œ
            
    def enable_buttons(self):
        """Re-enable buttons after processing"""
        self.progress_bar.stop()  # ì§„í–‰ í‘œì‹œì¤„ ì¤‘ì§€
        
        # íŒŒì¼ ê°ì§€ ê²°ê³¼ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ìƒíƒœ ë©”ì‹œì§€ ì„¤ì •
        main_file = self.find_main_file()
        patients_file = self.find_file('patients')
        payment_items = self.find_file('paymentitems')
        
        # íŒŒì¼ ê°ì§€ ê²°ê³¼ì— ë”°ë¼ ìƒíƒœ ë©”ì‹œì§€ ì„¤ì •
        if not main_file:
            self.status_label.config(text="âš ï¸ ë©”ì¸ íŒŒì¼ ì—†ìŒ", fg="red")
        elif not patients_file and not payment_items:
            self.status_label.config(text="âš ï¸ ì…ë ¥ íŒŒì¼ ì—†ìŒ", fg="orange")
        else:
            self.status_label.config(text="ì¤€ë¹„ ì™„ë£Œ", fg="black")
            
        # íŒŒì¼ ê°ì§€ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        self.update_file_labels(show_alert=False)
        
        # ì¢…ë£Œ ë²„íŠ¼ê³¼ íŒŒì¼ ê°ì§€ ë²„íŠ¼ì€ í•­ìƒ í™œì„±í™” ìƒíƒœë¡œ ìœ ì§€
        self.detect_button.config(text="ğŸ” íŒŒì¼ ê°ì§€ ì—…ë°ì´íŠ¸", state=tk.NORMAL)
        self.exit_btn.config(text="ğŸšª ì¢…ë£Œ", state=tk.NORMAL)
    
    def get_base_path(self):
        """
        Returns the base path for files
        """
        return ""  # í˜„ì¬ ë””ë ‰í† ë¦¬ (ìƒëŒ€ ê²½ë¡œ)
    
    def read_csv_with_encoding(self, file_path, chunk_size=None):
        """
        CSV íŒŒì¼ì„ ë‹¤ì–‘í•œ ì¸ì½”ë”©ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ì½ìŒ (ìµœì í™” ë²„ì „)
        
        Args:
            file_path: CSV íŒŒì¼ ê²½ë¡œ
            chunk_size: ì²­í¬ ë‹¨ìœ„ë¡œ ì½ì„ ë•Œ ì‚¬ìš©í•  í¬ê¸° (ëŒ€ìš©ëŸ‰ íŒŒì¼ìš©)
            
        Returns:
            DataFrame: ì½ì–´ë“¤ì¸ CSV ë°ì´í„°
        """
        encodings = ['utf-8', 'cp949', 'euc-kr', 'latin1']
        
        # ë¨¼ì € íŒŒì¼ í¬ê¸° í™•ì¸
        file_size = os.path.getsize(file_path)
        # íŒŒì¼ì´ 5MBë³´ë‹¤ í¬ë©´ ìë™ìœ¼ë¡œ ì²­í¬ ì²˜ë¦¬
        if file_size > 5 * 1024 * 1024 and chunk_size is None:  # 5MB
            chunk_size = 10000  # ê¸°ë³¸ ì²­í¬ í¬ê¸°
            self.logger.info(f"ëŒ€ìš©ëŸ‰ íŒŒì¼ ê°ì§€ ({file_size/1024/1024:.1f}MB), ì²­í¬ ì²˜ë¦¬ ëª¨ë“œë¡œ ì½ê¸°")
        
        for encoding in encodings:
            try:
                # ì²­í¬ ì²˜ë¦¬ í•„ìš”í•œ ê²½ìš°
                if chunk_size:
                    chunks = []
                    for chunk in pd.read_csv(file_path, encoding=encoding, chunksize=chunk_size):
                        chunks.append(chunk)
                    df = pd.concat(chunks, ignore_index=True)
                else:
                    df = pd.read_csv(file_path, encoding=encoding)
                
                self.logger.info(f"íŒŒì¼ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œ: {file_path} (ì¸ì½”ë”©: {encoding})")
                return df
            except UnicodeDecodeError:
                continue
            except pd.errors.EmptyDataError:
                self.logger.warning(f"ë¹ˆ CSV íŒŒì¼: {file_path}")
                return pd.DataFrame()
            except Exception as e:
                self.logger.error(f"íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ ({encoding}): {str(e)}")
                continue
                
        self.logger.error(f"CSV íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŒ: {file_path}")
        return None
    
    def check_file_access(self, file_path):
        """Check if a file can be accessed (not locked by another process)"""
        if not os.path.exists(file_path):
            self.logger.error(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {file_path}")
            return False
            
        try:
            # Try to open the file in read-write mode to check if it's locked
            with open(file_path, 'r+b') as f:
                return True
        except IOError:
            # File is locked by another process
            self.logger.warning(f"íŒŒì¼ì´ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì ê²¨ ìˆìŠµë‹ˆë‹¤: {file_path}")
            return False
    
    def find_table(self, table_name, workbook):
        """
        ì›Œí¬ë¶ì—ì„œ ì§€ì •ëœ ì´ë¦„ì˜ í…Œì´ë¸”ì„ ì°¾ëŠ” í•¨ìˆ˜ (ìºì‹± ì¶”ê°€)
        """
        # í…Œì´ë¸” ì´ë¦„ ìºì‹± (ë™ì¼ í•¨ìˆ˜ í˜¸ì¶œ ë‚´ì—ì„œ ì¬ì‚¬ìš©)
        if not hasattr(self, '_table_cache'):
            self._table_cache = {}
        
        # ìºì‹œì—ì„œ í™•ì¸
        cache_key = f"{id(workbook)}_{table_name}"
        if cache_key in self._table_cache:
            return self._table_cache[cache_key]
            
        for sheet in workbook.worksheets:
            for table in sheet.tables.values():
                if table_name in table.name:
                    # ìºì‹œì— ì €ì¥
                    self._table_cache[cache_key] = table
                    self.logger.debug(f"í…Œì´ë¸” ìºì‹œì— ì €ì¥: {table_name}")
                    return table
                    
        return None

    def check_merged_cells(self, sheet, row, min_col, max_col):
        """ë³‘í•©ëœ ì…€ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ìˆìœ¼ë©´ True ë°˜í™˜"""
        # None ê°’ ì²´í¬ ê°•í™”
        if sheet is None or row is None or min_col is None or max_col is None:
            self.logger.warning("check_merged_cells: None ê°’ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤ (sheet, row, min_col, max_col ì¤‘ í•˜ë‚˜ ì´ìƒ)")
            return False
            
        # íƒ€ì… ì²´í¬ ë° ë³€í™˜
        try:
            row = int(row)
            min_col = int(min_col)
            max_col = int(max_col)
        except (ValueError, TypeError) as e:
            self.logger.warning(f"check_merged_cells: íƒ€ì… ë³€í™˜ ì‹¤íŒ¨ - row={row}, min_col={min_col}, max_col={max_col}, ì˜¤ë¥˜: {str(e)}")
            return False
            
        # sheet.merged_cellsê°€ Noneì¸ ê²½ìš° ì²´í¬
        if not hasattr(sheet, 'merged_cells') or sheet.merged_cells is None:
            self.logger.warning("check_merged_cells: sheet.merged_cellsê°€ ì—†ê±°ë‚˜ Noneì…ë‹ˆë‹¤")
            return False
            
        # ranges ì†ì„±ì´ ì—†ê±°ë‚˜ ë°˜ë³µ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì²´í¬
        try:
            if not hasattr(sheet.merged_cells, 'ranges') or not sheet.merged_cells.ranges:
                return False
        except Exception as e:
            self.logger.warning(f"check_merged_cells: merged_cells.ranges ì ‘ê·¼ ì˜¤ë¥˜: {str(e)}")
            return False
        
        # ê° ë³‘í•© ë²”ìœ„ ì²´í¬
        for merge_range in sheet.merged_cells.ranges:
            try:
                if merge_range is None or not str(merge_range):
                    continue
                    
                merge_range_str = str(merge_range)
                if ':' not in merge_range_str:
                    continue
                    
                merge_min_col, merge_min_row, merge_max_col, merge_max_row = range_boundaries(merge_range_str)
                
                # ê°’ íƒ€ì… í™•ì¸
                if None in (merge_min_col, merge_min_row, merge_max_col, merge_max_row):
                    continue
                    
                # í˜„ì¬ í–‰ì´ ë³‘í•© ë²”ìœ„ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
                if (merge_min_row <= row <= merge_max_row and 
                    not (merge_max_col < min_col or merge_min_col > max_col)):
                    return True
            except Exception as e:
                # ë²”ìœ„ íŒŒì‹± ì˜¤ë¥˜ ì‹œ ê±´ë„ˆë›°ê¸°
                self.logger.debug(f"check_merged_cells: ë³‘í•© ë²”ìœ„ '{merge_range}' ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {str(e)}")
                continue
        return False

    def find_safe_row(self, sheet, start_row, min_col, max_col):
        """ë³‘í•©ëœ ì…€ê³¼ ì¶©ëŒí•˜ì§€ ì•ŠëŠ” ì•ˆì „í•œ í–‰ ì°¾ê¸°"""
        # íŒŒë¼ë¯¸í„° ì²´í¬
        if sheet is None:
            self.logger.warning("find_safe_row: sheet íŒŒë¼ë¯¸í„°ê°€ Noneì…ë‹ˆë‹¤.")
            return 1
            
        # None ê°’ ì²´í¬ ë° ê¸°ë³¸ê°’ ì„¤ì •
        if start_row is None:
            self.logger.warning("find_safe_row: start_rowê°€ Noneì…ë‹ˆë‹¤. ê¸°ë³¸ê°’ 1 ì‚¬ìš©.")
            start_row = 1
        
        if min_col is None:
            self.logger.warning("find_safe_row: min_colì´ Noneì…ë‹ˆë‹¤. ê¸°ë³¸ê°’ 1 ì‚¬ìš©.")
            min_col = 1
            
        if max_col is None:
            self.logger.warning("find_safe_row: max_colì´ Noneì…ë‹ˆë‹¤. ê¸°ë³¸ê°’ 10 ì‚¬ìš©.")
            max_col = 10
            
        # íƒ€ì… ë³€í™˜ ì‹œë„
        try:
            start_row = int(start_row)
            min_col = int(min_col)
            max_col = int(max_col)
        except (ValueError, TypeError) as e:
            self.logger.warning(f"find_safe_row: ê°’ ë³€í™˜ ì˜¤ë¥˜ - start_row={start_row}, min_col={min_col}, max_col={max_col}, ì˜¤ë¥˜: {str(e)}")
            # ì•ˆì „í•œ ê¸°ë³¸ê°’ ì‚¬ìš©
            return 1
            
        # ê°’ ë²”ìœ„ ê²€ì¦
        if start_row < 1:
            self.logger.warning(f"find_safe_row: ì˜ëª»ëœ start_row ê°’ ({start_row}). ê¸°ë³¸ê°’ 1 ì‚¬ìš©.")
            start_row = 1
            
        if min_col < 1:
            self.logger.warning(f"find_safe_row: ì˜ëª»ëœ min_col ê°’ ({min_col}). ê¸°ë³¸ê°’ 1 ì‚¬ìš©.")
            min_col = 1
            
        if max_col < min_col:
            self.logger.warning(f"find_safe_row: ì˜ëª»ëœ max_col ê°’ ({max_col}, min_col={min_col}). min_col+5 ì‚¬ìš©.")
            max_col = min_col + 5
        
        row = start_row
        max_tries = 100  # ë¬´í•œ ë£¨í”„ ë°©ì§€
        tries = 0
        
        while tries < max_tries:
            try:
                if not self.check_merged_cells(sheet, row, min_col, max_col):
                    return row
                row += 1
                tries += 1
            except Exception as e:
                self.logger.error(f"find_safe_row: í–‰ {row}ì—ì„œ ë³‘í•©ëœ ì…€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                return row  # ì˜¤ë¥˜ ë°œìƒ ì‹œ í˜„ì¬ í–‰ ë°˜í™˜
        
        self.logger.warning(f"find_safe_row: {max_tries}ë²ˆ ì‹œë„ í›„ ì•ˆì „í•œ í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ í–‰ì„ ì‚¬ìš©í•©ë‹ˆë‹¤: {row}")
        return row

    def copy_cell_style(self, source_cell, target_cell):
        """Copy cell style from source to target cell"""
        if source_cell.has_style:
            target_cell.font = copy(source_cell.font)
            target_cell.fill = copy(source_cell.fill)
            target_cell.border = copy(source_cell.border)
            target_cell.alignment = copy(source_cell.alignment)
            target_cell.number_format = source_cell.number_format
            target_cell.protection = copy(source_cell.protection)

    def show_help(self):
        """ë„ì›€ë§ í‘œì‹œ"""
        help_window = tk.Toplevel(self.root)
        help_window.title("í”„ë¡œê·¸ë¨ ë„ì›€ë§")
        help_window.geometry("700x500")
        help_window.configure(bg="#FDF6E3")  # ë² ì´ì§€ìƒ‰ (ì´ì „: #FDF6F0)
        
        # ì°½ì„ ëª¨ë‹¬ë¡œ ì„¤ì • (ë¶€ëª¨ ì°½ ì¡°ì‘ ë°©ì§€)
        help_window.grab_set()
        
        # ë©”ì¸ ì½˜í…ì¸  í”„ë ˆì„
        content_frame = ttk.Frame(help_window, padding=15)
        content_frame.pack(fill=tk.BOTH, expand=True)
        
        # ì œëª©
        title = ttk.Label(content_frame, text="ğŸ± KDOC ë§ˆí¬7 V3.1 ì‚¬ìš© ì„¤ëª…ì„œ ğŸ±", 
                         font=('Arial', 16, 'bold'))
        title.pack(pady=(0, 15))
        
        # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ì˜ì—­ì„ ìœ„í•œ í”„ë ˆì„
        scroll_frame = ttk.Frame(content_frame)
        scroll_frame.pack(fill=tk.BOTH, expand=True)
        
        # í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
        text_area = tk.Text(
            scroll_frame,
            wrap=tk.WORD,
            bg="#FFF8E1",  # í¬ë¦¼ìƒ‰ ë°°ê²½
            font=('Arial', 11))
        text_area.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        
        # ìŠ¤í¬ë¡¤ë°” ì¶”ê°€
        scrollbar = ttk.Scrollbar(scroll_frame, command=text_area.yview)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        text_area.config(yscrollcommand=scrollbar.set)
        
        # ë„ì›€ë§ ë‚´ìš©
        help_text = """
ğŸ± KDOC ë§ˆí¬7 V3.1 ì‚¬ìš© ì„¤ëª…ì„œ ğŸ±

1. í”„ë¡œê·¸ë¨ì´ ë­ì˜ˆìš”?
   - í™˜ì ì •ë³´ì™€ ê²°ì œ ë‚´ì—­ì„ ì •ë¦¬í•´ì£¼ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.
   - ì—‘ì…€ íŒŒì¼ê³¼ CSV íŒŒì¼ì˜ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ í•©ì³ì¤ë‹ˆë‹¤.
   - ê°™ì€ ë‚´ìš©ì´ ì¤‘ë³µìœ¼ë¡œ ë“¤ì–´ê°€ëŠ” ê²ƒì„ ë°©ì§€í•´ì¤ë‹ˆë‹¤.

2. í•„ìš”í•œ íŒŒì¼ì€ ë­ê°€ ìˆë‚˜ìš”?
   - í•„ìˆ˜ íŒŒì¼: 'íšŒì›-sales_ê³µë€.xlsx' (ë©”ì¸ íŒŒì¼)
   - ì„ íƒ íŒŒì¼: 'Patients.csv' (í™˜ì ì •ë³´)
   - ì„ íƒ íŒŒì¼: 'PaymentItems.csv' (ê²°ì œ ë‚´ì—­)
   - ëª¨ë“  íŒŒì¼ì€ í”„ë¡œê·¸ë¨ì´ ìˆëŠ” í´ë”ì— ë„£ì–´ì£¼ì„¸ìš”.

3. ì–´ë–»ê²Œ ì‚¬ìš©í•˜ë‚˜ìš”?
   â‘  íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
      - í”„ë¡œê·¸ë¨ì´ í•„ìš”í•œ íŒŒì¼ì„ ì°¾ì•„ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
      - íŒŒì¼ì´ ì œëŒ€ë¡œ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
   â‘¡ í‘œ ì—…ë°ì´íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
      - í™˜ì ì •ë³´ë‚˜ ê²°ì œ ë‚´ì—­ì„ ë©”ì¸ íŒŒì¼ì— ë„£ì–´ì¤ë‹ˆë‹¤.
      - ê°™ì€ ë‚´ìš©ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
      - ê²°ê³¼ëŠ” ì•Œë¦¼ì°½ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   
   â‘¢ í™˜ì ì •ë³´ ì—…ë°ì´íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
      - í™˜ì ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì •ë¦¬í•´ì¤ë‹ˆë‹¤.
      - ì´ë¦„, ë‚˜ì´, ì„±ë³„, ì§€ì—­ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.

4. ì£¼ìš” ê¸°ëŠ¥ ì„¤ëª…:
   ğŸ“‹ ì¤‘ë³µ ì²´í¬:
      - ê°™ì€ í™˜ì ì •ë³´ê°€ ì—¬ëŸ¬ ë²ˆ ë“¤ì–´ê°€ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
      - ì´ë¦„, ë“±ë¡ ë‚ ì§œ, ì£¼ì†Œë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
      - íŠ¹ë³„í•œ í™˜ìë‚˜ ì˜ì‚¬ëŠ” ì¤‘ë³µ ì²´í¬ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
   
   ğŸ”„ ë°ì´í„° ì •ë¦¬:
      - ì´ë¦„ì˜ ëŒ€ì†Œë¬¸ìì™€ ê³µë°±ì„ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.
      - ë‚ ì§œ í˜•ì‹ì„ í†µì¼í•©ë‹ˆë‹¤ (ì˜ˆ: 2024-03-15).
      - íŠ¹ìˆ˜ë¬¸ìì™€ ê³µë°±ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
   
   ğŸ“Š ê²°ê³¼ í™•ì¸:
      - ì²˜ë¦¬ëœ ê±´ìˆ˜, ì¤‘ë³µ ê±´ìˆ˜, ì œì™¸ëœ ê±´ìˆ˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
      - ìƒì„¸í•œ ê²°ê³¼ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

5. íŒŒì¼ ê´€ë¦¬:
   - 'BACK UP' í´ë”: ì›ë³¸ íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
   - 'DONE' í´ë”: ì²˜ë¦¬ëœ íŒŒì¼ì´ ì´ë™ë©ë‹ˆë‹¤.
   - 'SKIPPED' í´ë”: ì¤‘ë³µëœ íŒŒì¼ì´ ì´ë™ë©ë‹ˆë‹¤.

6. ë¡œê·¸ í™•ì¸:
   - í™”ë©´ ì•„ë˜ì—ì„œ ì‘ì—… ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - ë””ë²„ê·¸ ëª¨ë“œë¥¼ ì¼œë©´ ë” ìì„¸í•œ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œ ë¡œê·¸ë¥¼ ë³´ë©´ ì›ì¸ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

7. ì•Œë¦¼ ê¸°ëŠ¥:
   - ì‘ì—…ì´ ëë‚˜ë©´ ê²°ê³¼ë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤.
   - ì¤‘ë³µëœ ë‚´ìš©ì´ ìˆìœ¼ë©´ ìƒì„¸ ì •ë³´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
   - ì œì™¸ëœ ë‚´ìš©ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

8. ì£¼ì˜í•  ì :
   - íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ë™ì•ˆ í”„ë¡œê·¸ë¨ì„ ë„ì§€ ë§ˆì„¸ìš”.
   - í° íŒŒì¼ì€ ì²˜ë¦¬í•˜ëŠ”ë° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - ì¤‘ìš”í•œ ì‘ì—… í›„ì—ëŠ” íŒŒì¼ì„ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”.

9. ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œ:
   - íŒŒì¼ì´ ì•ˆ ë³´ì—¬ìš”: íŒŒì¼ ì´ë¦„ê³¼ í™•ì¥ìë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
   - ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ë¡œê·¸ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
   - ì´ìƒí•œ ë™ì‘ì´ì—ìš”: ë””ë²„ê·¸ ëª¨ë“œë¥¼ ì¼œì„œ í™•ì¸í•´ì£¼ì„¸ìš”.
   - í”„ë¡œê·¸ë¨ì´ ë©ˆì·„ì–´ìš”: ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. í° íŒŒì¼ì€ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤.

10. ìƒˆë¡œìš´ ê¸°ëŠ¥ (V3.1):
    - ë” ì •í™•í•œ ì¤‘ë³µ ì²´í¬
    - ìì„¸í•œ ì‘ì—… ë‚´ì—­ í™•ì¸
    - í¸ë¦¬í•œ ì•Œë¦¼ì°½
    - ë” ë¹ ë¥¸ ì†ë„ì™€ ê¹”ë”í•œ í™”ë©´

ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ê°œë°œìì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!
"""
        
        text_area.insert(tk.END, help_text)
        text_area.config(state="disabled")  # ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì •
        
        # ë‹«ê¸° ë²„íŠ¼
        close_btn = tk.Button(
            content_frame,
            text="ë‹«ê¸°",
            font=("Arial", 11),
            bg="#F5CBA7",  # í™©í† ìƒ‰ ë²„íŠ¼ (ì´ì „: #FFE1E1)
            fg="#5D4037",
            padx=10,
            pady=5,
            relief="flat",
            cursor="hand2",
            command=help_window.destroy
        )
        close_btn.pack(pady=15)
        
        # ì°½ì„ í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ
        help_window.update_idletasks()
        width = help_window.winfo_width()
        height = help_window.winfo_height()
        x = (help_window.winfo_screenwidth() // 2) - (width // 2)
        y = (help_window.winfo_screenheight() // 2) - (height // 2)
        help_window.geometry(f"{width}x{height}+{x}+{y}")
        
        # ë¶€ëª¨ ì°½ë³´ë‹¤ í•­ìƒ ìœ„ì— í‘œì‹œ
        help_window.transient(self.root)
        help_window.focus_set()

    # ë‚ ì§œ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€
    def format_date(self, date_value, include_time=False, excel_format=False):
        """ë‹¤ì–‘í•œ í˜•ì‹ì˜ ë‚ ì§œë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        
        Args:
            date_value: ë³€í™˜í•  ë‚ ì§œ ê°’ (ë¬¸ìì—´, datetime ë“±)
            include_time: ì‹œê°„ì„ í¬í•¨í• ì§€ ì—¬ë¶€
            excel_format: ì—‘ì…€ í•œê¸€ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í• ì§€ ì—¬ë¶€ (True: 2024ë…„ 3ì›” 15ì¼)
            
        Returns:
            formatted_date: í˜•ì‹í™”ëœ ë‚ ì§œ ë¬¸ìì—´ ë˜ëŠ” None (ë³€í™˜ ì‹¤íŒ¨ ì‹œ)
        """
        if date_value is None:
            return None
            
        try:
            # ì´ë¯¸ datetime ê°ì²´ì¸ ê²½ìš°
            if isinstance(date_value, datetime):
                dt = date_value
            else:
                # pandasë¥¼ í†µí•œ ë‚ ì§œ ë³€í™˜
                dt = pd.to_datetime(date_value, errors='coerce')
                if pd.isna(dt):
                    return date_value  # ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            
            # ì‹œê°„ì´ ì—†ëŠ” ê²½ìš° í˜„ì¬ ì‹œê°„ ì¶”ê°€ (include_time=Trueì¸ ê²½ìš°ë§Œ)
            if include_time and dt.hour == 0 and dt.minute == 0:
                dt = dt.replace(hour=datetime.now().hour, minute=datetime.now().minute)
            
            # í˜•ì‹ì— ë§ê²Œ ì¶œë ¥
            if excel_format:
                return dt.strftime("%Yë…„ %mì›” %dì¼")
            elif include_time:
                return dt.strftime("%Y-%m-%d %H:%M")
            else:
                return dt.strftime("%Y-%m-%d")
                
        except Exception as e:
            self.logger.warning(f"ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨: {date_value}, ì˜¤ë¥˜: {str(e)}")
            return date_value  # ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜

    def show_detailed_result(self, title, summary, details=None):
        """ìƒì„¸ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ"""
        result_window = tk.Toplevel()
        result_window.title(title)
        result_window.geometry("600x500")
        
        # ì°½ì„ í™”ë©´ ì¤‘ì•™ì— ìœ„ì¹˜
        window_width = 600
        window_height = 500
        screen_width = result_window.winfo_screenwidth()
        screen_height = result_window.winfo_screenheight()
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2
        result_window.geometry(f"{window_width}x{window_height}+{x}+{y}")
        
        # ë©”ì¸ í”„ë ˆì„
        main_frame = ttk.Frame(result_window)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # ìš”ì•½ ì •ë³´ í‘œì‹œ
        summary_label = ttk.Label(
            main_frame, 
            text=summary,
            wraplength=550,
            justify=tk.LEFT
        )
        summary_label.pack(fill=tk.X, pady=(0, 10))
        
        if details:
            # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ì˜ì—­ì„ ìœ„í•œ í”„ë ˆì„
            text_frame = ttk.Frame(main_frame)
            text_frame.pack(fill=tk.BOTH, expand=True)
            
            # ìŠ¤í¬ë¡¤ë°” ìƒì„±
            scrollbar = ttk.Scrollbar(text_frame)
            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
            # í…ìŠ¤íŠ¸ ìœ„ì ¯ ìƒì„±
            text_widget = tk.Text(
                text_frame,
                wrap=tk.WORD,
                yscrollcommand=scrollbar.set,
                height=15,
                background='#FFF3E0'  # ì—°í•œ í¬ë¦¼ìƒ‰ (ì´ì „: #F5F5F5)
            )
            text_widget.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            
            # ìŠ¤í¬ë¡¤ë°”ì™€ í…ìŠ¤íŠ¸ ìœ„ì ¯ ì—°ê²°
            scrollbar.config(command=text_widget.yview)
            
            # ìƒì„¸ ì •ë³´ ì¶”ê°€
            text_widget.insert(tk.END, details)
            text_widget.config(state=tk.DISABLED)  # ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì •
            
            # ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸ ë°”ì¸ë”©
            def on_mousewheel(event):
                text_widget.yview_scroll(int(-1 * (event.delta / 120)), "units")
            text_widget.bind("<MouseWheel>", on_mousewheel)
        
        # í™•ì¸ ë²„íŠ¼
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill=tk.X, pady=(10, 0))
        
        ok_button = ttk.Button(
            button_frame,
            text="í™•ì¸",
            command=result_window.destroy,
            width=15
        )
        ok_button.pack(pady=(10, 0))
        
        # ì°½ì„ ëª¨ë‹¬ë¡œ ì„¤ì •
        result_window.transient(self.root)
        result_window.grab_set()
        
        # ì°½ì´ ë‹«í ë•Œê¹Œì§€ ëŒ€ê¸°
        self.root.wait_window(result_window)

    def on_closing(self):
        """í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì²˜ë¦¬"""
        if messagebox.askokcancel("ì¢…ë£Œ", "í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            try:
                # ì¢…ë£Œ ë©”ì‹œì§€ ì¶œë ¥
                self.logger.info("í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
                
                # stdoutì— ì•ˆì „í•˜ê²Œ ì¶œë ¥ ì‹œë„
                try:
                    if hasattr(sys, 'stdout') and sys.stdout and hasattr(sys.stdout, 'write'):
                        sys.stdout.write("í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë©ë‹ˆë‹¤.\n")
                        if hasattr(sys.stdout, 'flush'):
                            sys.stdout.flush()
                except Exception:
                    pass
                
                # ì§„í–‰ í‘œì‹œì¤„ ì¤‘ì§€
                try:
                    if hasattr(self, 'progress_bar'):
                        self.progress_bar.stop()
                except Exception:
                    pass
                
                # ë¦¬ë””ë ‰ì…˜ í•´ì œ - ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                if hasattr(self, 'stdout_redirector'):
                    try:
                        if hasattr(self.stdout_redirector, 'original_stdout'):
                            sys.stdout = self.stdout_redirector.original_stdout
                    except Exception:
                        # ê¸°ë³¸ ì¶œë ¥ìœ¼ë¡œ ë³µì›
                        sys.stdout = sys.__stdout__
                        
                if hasattr(self, 'stderr_redirector'):
                    try:
                        if hasattr(self.stderr_redirector, 'original_stdout'):
                            sys.stderr = self.stderr_redirector.original_stdout
                    except Exception:
                        # ê¸°ë³¸ ì¶œë ¥ìœ¼ë¡œ ë³µì›
                        sys.stderr = sys.__stderr__
            except Exception as e:
                print(f"ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            finally:
                # ì¦‰ì‹œ ê°•ì œ ì¢…ë£Œ
                os._exit(0)

    def center_window(self):
        """ì°½ì„ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜í•©ë‹ˆë‹¤"""
        self.root.update_idletasks()
        width = self.root.winfo_width()
        height = self.root.winfo_height()
        x = (self.root.winfo_screenwidth() // 2) - (width // 2)
        y = (self.root.winfo_screenheight() // 2) - (height // 2)
        self.root.geometry(f"{width}x{height}+{x}+{y}")
    
    def find_main_file(self):
        """ë©”ì¸ Excel/CSV íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤('íšŒì›-sales'ë¡œ ì‹œì‘í•˜ëŠ” íŒŒì¼)"""
        for filename in os.listdir('.'):
            lower_name = filename.lower()
            if lower_name.startswith('íšŒì›-sales') and (lower_name.endswith('.xlsx') or lower_name.endswith('.csv')):
                print(f"ë©”ì¸ íŒŒì¼ ì°¾ìŒ: {filename}")
                return filename
        print("ë©”ì¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None
    
    def find_file(self, prefix):
        """íŠ¹ì • ì ‘ë‘ì‚¬ë¡œ ì‹œì‘í•˜ëŠ” Excel/CSV íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤"""
        for filename in os.listdir('.'):
            lower_name = filename.lower()
            if lower_name.startswith(prefix.lower()) and (lower_name.endswith('.xlsx') or lower_name.endswith('.csv')):
                print(f"{prefix} íŒŒì¼ ì°¾ìŒ: {filename}")
                return filename
        print(f"{prefix} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

# Run the application
if __name__ == "__main__":
    try:
        # ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ì„¤ì • 
        sys.excepthook = custom_excepthook
        
        # PyInstaller í™˜ê²½ì¸ì§€ í™•ì¸
        is_frozen = getattr(sys, 'frozen', False)
        
        # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        log_dir = "logs"
        if not os.path.exists(log_dir):
            os.makedirs(log_dir)
            
        # ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¡œê·¸ íŒŒì¼ ì´ë¦„ ìƒì„±
        log_file = os.path.join(log_dir, f"app_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt")
        
        # ë£¨íŠ¸ ë¡œê±° ì„¤ì •
        root_logger = logging.getLogger()
        root_logger.handlers = []  # ê¸°ì¡´ í•¸ë“¤ëŸ¬ ëª¨ë‘ ì œê±°
        
        # íŒ¨í‚¤ì§•ëœ í™˜ê²½ì—ì„œëŠ” GUI ë¡œê¹…ì„ ë¹„í™œì„±í™”í•˜ê³  íŒŒì¼ ë¡œê¹…ë§Œ ì‚¬ìš©
        if is_frozen:
            # íŒŒì¼ í•¸ë“¤ëŸ¬ ì¶”ê°€ - ë””ë²„ê·¸ ë ˆë²¨ë¡œ ì„¤ì •
            file_handler = logging.FileHandler(log_file, encoding='utf-8')
            file_handler.setLevel(logging.DEBUG)
            formatter = logging.Formatter('[%(asctime)s] %(levelname)s: %(message)s', datefmt='%H:%M:%S')
            file_handler.setFormatter(formatter)
            root_logger.addHandler(file_handler)
            root_logger.setLevel(logging.DEBUG)
            
            # ì½˜ì†” ì¶œë ¥ì€ ì•ˆì „í•œ ê°ì²´ë¡œ ëŒ€ì²´
            class SafeWriter:
                def write(self, s): pass
                def flush(self): pass
                def isatty(self): return False
            
            # í‘œì¤€ ì¶œë ¥/ì—ëŸ¬ ìŠ¤íŠ¸ë¦¼ êµì²´
            sys.stdout = SafeWriter()
            sys.stderr = SafeWriter()
            
            # ì‹œì‘ ë©”ì‹œì§€ ê¸°ë¡
            logging.info(f"ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ - ë¡œê·¸ íŒŒì¼: {log_file}")
        else:
            # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì½˜ì†” ë¡œê·¸ë„ í™œì„±í™”
            console_handler = logging.StreamHandler()
            console_handler.setLevel(logging.INFO)
            formatter = logging.Formatter('[%(asctime)s] %(levelname)s: %(message)s', datefmt='%H:%M:%S')
            console_handler.setFormatter(formatter)
            root_logger.addHandler(console_handler)
            
            # íŒŒì¼ í•¸ë“¤ëŸ¬ë„ ì¶”ê°€
            file_handler = logging.FileHandler(log_file, encoding='utf-8')
            file_handler.setLevel(logging.DEBUG)
            file_handler.setFormatter(formatter)
            root_logger.addHandler(file_handler)
            
            root_logger.setLevel(logging.DEBUG)
        
        logging.info("Starting Excel Processor application...")
        
        # Check for required libraries
        missing_libs = []
        try:
            logging.info("Checking for openpyxl...")
            import openpyxl
            logging.info("openpyxl found.")
        except ImportError:
            missing_libs.append("openpyxl")
            logging.error("openpyxl not found.")
        
        try:
            logging.info("Checking for pandas...")
            import pandas
            logging.info("pandas found.")
        except ImportError:
            missing_libs.append("pandas")
            logging.error("pandas not found.")
        
        if missing_libs:
            logging.error("Missing required libraries:")
            for lib in missing_libs:
                logging.error(f"  - {lib}")
            logging.error("\nPlease install them using:")
            logging.error(f"pip install {' '.join(missing_libs)}")
            sys.exit(1)
        
        # GUI ì´ì¤‘í™” ë°©ì§€
        try:
            root_check = tk.Tk()
            root_check.withdraw()
            root_check.destroy()
        except:
            pass
            
        logging.info("Initializing ExcelProcessor...")
        app = ExcelProcessor()
        logging.info("Starting main loop...")
        
        # frozen í™˜ê²½ì´ ì•„ë‹ ê²½ìš°ì—ë§Œ GUI ë¡œê·¸ í•¸ë“¤ëŸ¬ ìƒì„±
        if not is_frozen:
            app.create_gui_log_handler()
            
        app.root.mainloop()
    except Exception as e:
        logging.error(f"Error initializing application: {str(e)}")
        logging.error(traceback.format_exc())

# íŒŒì¼ ì‹¤í–‰ ì‹œì‘ ë¶€ë¶„ ì œê±° (ì¤‘ë³µ main ë¸”ë¡)
